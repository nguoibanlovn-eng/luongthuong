<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng team | L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #0b57d0;
      --bg: #f5f5f5;
      --card-radius: 12px;
      --green-bg: #e6f4ea;
      --green-text: #137333;
      --yellow-bg: #fff8e1;
      --yellow-text: #b05a00;
      --red-bg: #fce8e6;
      --red-text: #b3261e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 16px 16px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: .01em;
    }

    .subtitle {
      font-size: 12px;
      color: #666;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 16px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: var(--card-radius);
      border: 1px solid #e5e5e5;
      padding: 12px 12px 14px;
      background: #fafafa;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .team-select-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .team-select-row label {
      font-size: 13px;
      color: #444;
    }

    select, input[type="text"], input[type="number"] {
      font-family: inherit;
      font-size: 13px;
    }

    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      min-width: 150px;
    }

    select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5f0ff;
      color: #1a4fbf;
      white-space: nowrap;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 12px;
      margin-bottom: 2px;
      color: #444;
    }

    .field-sub {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row .field-group {
      flex: 1;
      margin-bottom: 0;
    }

    .field-input {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      outline: none;
      text-align: right;
    }

    .field-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
      background: #fff;
    }

    .field-input[readonly] {
      background: #f3f4f6;
      cursor: default;
    }

    .small {
      font-size: 11px;
      color: #777;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #0b57d0;
      color: #fff;
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }

    .btn-primary:hover {
      background: #0a4ab5;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #ddd;
      color: #555;
    }

    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0 10px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      border-radius: 10px;
      border: 1px solid #eee;
      background: #fafafa;
      padding: 8px 10px;
      font-size: 12px;
    }

    .summary-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .targets-row {
      margin-bottom: 6px;
    }

    .target-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .target-inputs .target-field {
      flex: 1 1 120px;
    }

    .target-label {
      font-size: 11px;
      color: #555;
      margin-bottom: 2px;
    }

    .target-inputs input {
      width: 100%;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: right;
      background: #fff;
      outline: none;
    }

    .target-inputs input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .team-block {
      border-radius: 10px;
      border: 1px solid #e5e5e5;
      padding: 10px 10px 12px;
      background: #fff;
      margin-bottom: 10px;
    }

    .team-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .team-name {
      font-weight: 600;
      font-size: 13px;
    }

    .table-wrapper {
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }

    .pl-cell {
      font-weight: 500;
    }
    .pl-pos {
      background: var(--green-bg);
      color: var(--green-text);
    }
    .pl-low {
      background: var(--yellow-bg);
      color: var(--yellow-text);
    }
    .pl-neg {
      background: var(--red-bg);
      color: var(--red-text);
    }

    .note {
      margin-top: 6px;
      font-size: 11px;
      color: #777;
    }

    .footer-cta {
      margin-top: 16px;
      text-align: center;
      font-size: 12px;
      color: #555;
    }

    .footer-cta a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .footer-cta a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng theo team</h1>
    <div class="subtitle">
      C√¥ng c·ª• n·ªôi b·ªô gi√∫p L·ªó V≈© &amp; team set target ‚Äì t√≠nh h√≤a v·ªën ‚Äì chia th∆∞·ªüng theo t·ª´ng team (Sale, RD, CSKH, KT+HCNS, Media).
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: c·∫•u h√¨nh t·ª´ng team -->
    <section class="panel">
      <div class="panel-title">
        <span>C·∫•u h√¨nh team</span>
        <span class="tag">L∆∞u theo tr√¨nh duy·ªát c·ªßa b·∫°n</span>
      </div>

      <div class="team-select-row">
        <label for="teamSelect">Ch·ªçn team:</label>
        <select id="teamSelect"></select>
        <button class="btn btn-ghost" id="addTeamBtn" type="button">+ Th√™m team</button>
      </div>

      <div class="field-group">
        <label class="field-label" for="teamNameInput">T√™n team</label>
        <input id="teamNameInput" type="text" class="field-input" />
        <div class="field-sub">V√≠ d·ª•: Facebook, TikTok, Shopee, Web, Offline‚Ä¶</div>
      </div>

      <div class="field-group">
        <label class="field-label">Chi ph√≠ c·ªë ƒë·ªãnh m·ªói k·ª≥ (VNƒê)</label>
        <input id="fixedCostInput" type="text" class="field-input" inputmode="numeric" />
        <div class="field-sub">L∆∞∆°ng c·ª©ng, m·∫∑t b·∫±ng, qu·∫£n l√Ω chung‚Ä¶ d√†nh ri√™ng cho team n√†y.</div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Gi√° v·ªën (COGS)</label>
          <input id="cogsRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">T√≠nh theo % doanh thu.</div>
        </div>
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ b√°n h√†ng</label>
          <input id="sellRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Marketing, CSKH, v·∫≠n h√†nh theo %.</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ kh√°c (bi·∫øn ph√≠)</label>
          <input id="otherRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Ph√≠ s√†n, POS, thu h·ªô, v·∫≠n chuy·ªÉn‚Ä¶</div>
        </div>
        <div class="field-group">
          <label class="field-label">T·ªïng bi·∫øn ph√≠ (%)</label>
          <input id="totalVarRateDisplay" type="text" class="field-input" readonly />
          <div class="field-sub">= Gi√° v·ªën + b√°n h√†ng + kh√°c</div>
        </div>
      </div>

      <!-- T·ª∑ l·ªá th∆∞·ªüng -->
      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng Sale tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="saleBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng RD tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="rdBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng CSKH tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="cskhBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng KT + HCNS tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="hcnsBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">% th∆∞·ªüng Media tr√™n L·ª¢I NHU·∫¨N</label>
        <input id="mediaBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
      </div>

      <div class="field-group">
        <label class="field-label">ƒêi·ªÉm h√≤a v·ªën (theo c·∫•u h√¨nh ƒëang nh·∫≠p)</label>
        <input id="breakevenDisplay" type="text" class="field-input" readonly />
        <div class="field-sub">
          Doanh thu c·∫ßn ƒë·∫°t ƒë·ªÉ l·ª£i nhu·∫≠n = 0 (ch·ªâ ƒë·ªß b√π chi ph√≠). Ch·ªâ l√† preview khi anh ch·ªânh, ch∆∞a l∆∞u.
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn btn-primary" id="saveTeamBtn" type="button">üíæ L∆∞u c·∫•u h√¨nh team</button>
        <button class="btn btn-ghost" id="resetTeamBtn" type="button">‚Ü∫ ƒê∆∞a v·ªÅ m·∫∑c ƒë·ªãnh</button>
      </div>

      <div class="note">
        ‚Ä¢ M·ªói team c√≥ th·ªÉ c√≥ chi ph√≠ &amp; m·ª©c th∆∞·ªüng ri√™ng cho t·ª´ng b·ªô ph·∫≠n (Sale, RD, CSKH, KT+HCNS, Media).<br>
        ‚Ä¢ C·∫•u h√¨nh &amp; m·ªëc doanh thu ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát (localStorage) ‚Äì kh√¥ng share gi·ªØa c√°c m√°y.
      </div>
    </section>

    <!-- RIGHT: m·ª•c ti√™u + k·∫øt qu·∫£ + t·ªïng quan nhi·ªÅu team -->
    <section>
      <!-- T·∫§T C·∫¢ TEAM -->
      <div class="panel">
        <div class="panel-title">
          <span>M·ª•c ti√™u doanh thu &amp; t·ªïng quan c√°c team</span>
        </div>

        <div class="targets-row small">
          M·ªói team d√πng <b>3 m·ªëc doanh thu ri√™ng</b>: M·ªëc 1, M·ªëc 2 v√† <b>M·ªëc 3 (th·ª±c t·∫ø)</b>.  
          M·ªëc 3 s·∫Ω d√πng ƒë·ªÉ t√≠nh t·ªïng doanh thu &amp; t·ªïng th∆∞·ªüng to√†n c√¥ng ty.
        </div>

        <div id="teamsOverviewContainer"></div>

        <div class="note">
          ‚Ä¢ B·∫£ng chi ti·∫øt trong m·ªói team c√≥ th·ªÉ thu g·ªçn b·∫±ng n√∫t ‚Äú·∫®n chi ti·∫øt / Xem chi ti·∫øt‚Äù.<br>
          ‚Ä¢ M·ªëc 3 ƒë∆∞·ª£c d√πng l√†m ‚Äúm·ªëc th·ª±c t·∫ø‚Äù ƒë·ªÉ c·ªông t·ªïng to√†n doanh nghi·ªáp.
        </div>
      </div>

      <!-- T·ªïng h·ª£p t·∫•t c·∫£ team -->
      <div class="panel" id="multiTeamPanel">
        <div class="panel-title">
          <span>T·ªïng quan t·∫•t c·∫£ team (M·ªëc 3 ‚Äì th·ª±c t·∫ø)</span>
        </div>

        <div class="small" style="margin-bottom:4px;">
          D√πng <b>doanh thu M·ªëc 3</b> ri√™ng c·ªßa t·ª´ng team ƒë·ªÉ t√≠nh doanh thu, l·ª£i nhu·∫≠n v√† th∆∞·ªüng.
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
            <tr>
              <th>Team</th>
              <th>Doanh thu M·ªëc 3</th>
              <th>L·ª£i nhu·∫≠n</th>
              <th>Th∆∞·ªüng Sale</th>
              <th>Th∆∞·ªüng RD</th>
              <th>Th∆∞·ªüng CSKH</th>
              <th>Th∆∞·ªüng KT+HCNS</th>
              <th>Th∆∞·ªüng Media</th>
              <th>T·ªïng th∆∞·ªüng</th>
            </tr>
            </thead>
            <tbody id="allTeamsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer-cta">
        X√¢y d·ª±ng b·ªüi L·ªó V≈© ‚Äì ƒë·ªçc th√™m chia s·∫ª v·ªÅ TMƒêT t·∫°i
        <a href="https://nguoibanlo.vn" target="_blank" rel="noopener noreferrer">nguoibanlo.vn</a>
      </div>
    </section>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const STORAGE_KEY = 'plan_thuong_teams_v4';

    const DEFAULT_TARGETS = [
      800000000, 1200000000, 3000000000
    ];

    const DEFAULT_TEAMS = {
      facebook: {
        id: 'facebook',
        name: 'Facebook',
        fixedCost: 300000000,
        cogsRate: 60,
        sellRate: 14,
        otherRate: 6,
        saleBonusRate: 27,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1,
        targets: [...DEFAULT_TARGETS]
      },
      tiktok: {
        id: 'tiktok',
        name: 'TikTok',
        fixedCost: 250000000,
        cogsRate: 58,
        sellRate: 16,
        otherRate: 8,
        saleBonusRate: 27,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1,
        targets: [...DEFAULT_TARGETS]
      },
      shopee: {
        id: 'shopee',
        name: 'Shopee',
        fixedCost: 200000000,
        cogsRate: 60,
        sellRate: 15,
        otherRate: 10,
        saleBonusRate: 7,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1,
        targets: [...DEFAULT_TARGETS]
      },
      web: {
        id: 'web',
        name: 'Web',
        fixedCost: 150000000,
        cogsRate: 55,
        sellRate: 10,
        otherRate: 5,
        saleBonusRate: 25,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1,
        targets: [...DEFAULT_TARGETS]
      }
    };

    let teams = {};
    let currentTeamId = 'facebook';

    // DOM refs - left
    const teamSelect = document.getElementById('teamSelect');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const teamNameInput = document.getElementById('teamNameInput');
    const fixedCostInput = document.getElementById('fixedCostInput');
    const cogsRateInput = document.getElementById('cogsRateInput');
    const sellRateInput = document.getElementById('sellRateInput');
    const otherRateInput = document.getElementById('otherRateInput');
    const totalVarRateDisplay = document.getElementById('totalVarRateDisplay');
    const saleBonusRateInput = document.getElementById('saleBonusRateInput');
    const rdBonusRateInput = document.getElementById('rdBonusRateInput');
    const cskhBonusRateInput = document.getElementById('cskhBonusRateInput');
    const hcnsBonusRateInput = document.getElementById('hcnsBonusRateInput');
    const mediaBonusRateInput = document.getElementById('mediaBonusRateInput');
    const breakevenDisplay = document.getElementById('breakevenDisplay');

    const saveTeamBtn = document.getElementById('saveTeamBtn');
    const resetTeamBtn = document.getElementById('resetTeamBtn');

    // DOM refs - right
    const teamsOverviewContainer = document.getElementById('teamsOverviewContainer');
    const allTeamsBody = document.getElementById('allTeamsBody');

    function formatMoney(value) {
      if (!isFinite(value)) return '‚Äì';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
    }

    function formatPercent(value) {
      if (!isFinite(value)) return '‚Äì';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + '%';
    }

    function parseMoney(str) {
      const digits = String(str || '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }

    function normalizeMoneyInput(el) {
      const num = parseMoney(el.value);
      el.value = num ? num.toLocaleString('vi-VN') : '';
      return num;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          teams = { ...DEFAULT_TEAMS };
          return;
        }
        const data = JSON.parse(raw);
        teams = data.teams || { ...DEFAULT_TEAMS };
        // ƒë·∫£m b·∫£o m·ªói team c√≥ targets 3 ph·∫ßn t·ª≠
        Object.values(teams).forEach(t => {
          if (!Array.isArray(t.targets)) t.targets = [...DEFAULT_TARGETS];
          while (t.targets.length < 3) t.targets.push(0);
          if (t.targets.length > 3) t.targets = t.targets.slice(0,3);
        });
        currentTeamId = data.currentTeamId || 'facebook';
        if (!teams[currentTeamId]) {
          currentTeamId = Object.keys(teams)[0] || 'facebook';
        }
      } catch (e) {
        teams = { ...DEFAULT_TEAMS };
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          teams,
          currentTeamId
        }));
      } catch (e) {}
    }

    function renderTeamOptions() {
      teamSelect.innerHTML = '';
      Object.values(teams).forEach(team => {
        const opt = document.createElement('option');
        opt.value = team.id;
        opt.textContent = team.name;
        teamSelect.appendChild(opt);
      });
      if (teams[currentTeamId]) {
        teamSelect.value = currentTeamId;
      }
    }

    function calcBreakevenFromValues(fixedCost, cogsRate, sellRate, otherRate) {
      const totalVarRate = (cogsRate || 0) + (sellRate || 0) + (otherRate || 0);
      totalVarRateDisplay.value = formatPercent(totalVarRate);
      const varRateDecimal = totalVarRate / 100;
      const denom = 1 - varRateDecimal;
      if (denom <= 0) return NaN;
      return fixedCost / denom;
    }

    function renderCurrentTeamConfig() {
      const team = teams[currentTeamId];
      if (!team) return;
      teamNameInput.value = team.name || '';
      fixedCostInput.value = team.fixedCost ? team.fixedCost.toLocaleString('vi-VN') : '';
      cogsRateInput.value = team.cogsRate != null ? team.cogsRate : '';
      sellRateInput.value = team.sellRate != null ? team.sellRate : '';
      otherRateInput.value = team.otherRate != null ? team.otherRate : '';
      saleBonusRateInput.value = team.saleBonusRate != null ? team.saleBonusRate : '';
      rdBonusRateInput.value = team.rdBonusRate != null ? team.rdBonusRate : '';
      cskhBonusRateInput.value = team.cskhBonusRate != null ? team.cskhBonusRate : '';
      hcnsBonusRateInput.value = team.hcnsBonusRate != null ? team.hcnsBonusRate : '';
      mediaBonusRateInput.value = team.mediaBonusRate != null ? team.mediaBonusRate : '';

      // preview h√≤a v·ªën
      const fixed = team.fixedCost || 0;
      const breakeven = calcBreakevenFromValues(
        fixed,
        team.cogsRate || 0,
        team.sellRate || 0,
        team.otherRate || 0
      );
      breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
    }

    function recalcLeftPreview() {
      const fixed = parseMoney(fixedCostInput.value);
      const cogs = parseFloat(cogsRateInput.value || '0');
      const sell = parseFloat(sellRateInput.value || '0');
      const other = parseFloat(otherRateInput.value || '0');
      const breakeven = calcBreakevenFromValues(fixed, cogs, sell, other);
      breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
    }

    function computeTeamRows(team) {
      const tTargets = team.targets || [0,0,0];
      const labels = ['M·ªëc 1', 'M·ªëc 2', 'M·ªëc 3 (th·ª±c t·∫ø)'];

      const varRateDecimal = ((team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0)) / 100;
      const fixed = team.fixedCost || 0;

      const denom = 1 - varRateDecimal;
      const breakeven = denom > 0 ? fixed / denom : NaN;

      const saleBonusRate = team.saleBonusRate || 0;
      const rdBonusRate = team.rdBonusRate || 0;
      const cskhBonusRate = team.cskhBonusRate || 0;
      const hcnsBonusRate = team.hcnsBonusRate || 0;
      const mediaBonusRate = team.mediaBonusRate || 0;

      const rows = [];
      let m3Info = {
        revenue: tTargets[2] || 0,
        profit: 0,
        totalBonus: 0
      };

      for (let i = 0; i < 3; i++) {
        const revenue = tTargets[i] || 0;
        if (!revenue || revenue <= 0) {
          rows.push(null);
          continue;
        }
        const totalCost = revenue * varRateDecimal + fixed;
        const profit = revenue - totalCost;
        const margin = revenue > 0 ? profit / revenue * 100 : 0;

        const saleBonus = profit > 0 ? profit * (saleBonusRate / 100) : 0;
        const rdBonus = profit > 0 ? profit * (rdBonusRate / 100) : 0;
        const cskhBonus = profit > 0 ? profit * (cskhBonusRate / 100) : 0;
        const hcnsBonus = profit > 0 ? profit * (hcnsBonusRate / 100) : 0;
        const mediaBonus = profit > 0 ? profit * (mediaBonusRate / 100) : 0;

        const totalBonus = saleBonus + rdBonus + cskhBonus + hcnsBonus + mediaBonus;
        const bonusOnProfit = profit > 0 ? totalBonus / profit * 100 : 0;

        const row = {
          label: labels[i],
          revenue,
          totalCost,
          profit,
          margin,
          saleBonus,
          rdBonus,
          cskhBonus,
          hcnsBonus,
          mediaBonus,
          totalBonus,
          bonusOnProfit
        };
        rows.push(row);

        if (i === 2) {
          m3Info = {
            revenue,
            profit,
            totalBonus
          };
        }
      }

      return { breakeven, rows, m3Info };
    }

    function renderTeamsOverview() {
      teamsOverviewContainer.innerHTML = '';

      Object.values(teams).forEach(team => {
        const { breakeven, rows, m3Info } = computeTeamRows(team);
        const teamTargets = team.targets || [0,0,0];

        const block = document.createElement('div');
        block.className = 'team-block';

        const header = document.createElement('div');
        header.className = 'team-header';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'team-name';
        nameSpan.textContent = team.name || team.id;

        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'btn btn-ghost';
        toggleBtn.textContent = '·∫®n chi ti·∫øt';

        header.appendChild(nameSpan);
        header.appendChild(toggleBtn);
        block.appendChild(header);

        // targets
        const labels = ['M·ªëc 1', 'M·ªëc 2', 'M·ªëc 3 (th·ª±c t·∫ø)'];
        const targetsRow = document.createElement('div');
        targetsRow.className = 'target-inputs';

        for (let i = 0; i < 3; i++) {
          const field = document.createElement('div');
          field.className = 'target-field';

          const label = document.createElement('div');
          label.className = 'target-label';
          label.textContent = labels[i];

          const input = document.createElement('input');
          input.type = 'text';
          input.inputMode = 'numeric';
          const v = teamTargets[i] || 0;
          input.value = v ? v.toLocaleString('vi-VN') : '';

          input.addEventListener('input', () => {
            const num = parseMoney(input.value);
            input.value = num ? num.toLocaleString('vi-VN') : '';
            if (!Array.isArray(team.targets)) team.targets = [0,0,0];
            team.targets[i] = num;
            saveState();
            recalc();
          });

          field.appendChild(label);
          field.appendChild(input);
          targetsRow.appendChild(field);
        }

        block.appendChild(targetsRow);

        // summary cards
        const summaryGrid = document.createElement('div');
        summaryGrid.className = 'summary-grid';

        const card1 = document.createElement('div');
        card1.className = 'summary-card';
        card1.innerHTML =
          '<div class="summary-title">ƒêi·ªÉm h√≤a v·ªën</div>' +
          `<div class="summary-value">${breakeven > 0 ? formatMoney(breakeven) : '‚Äì'}</div>` +
          '<div class="small">Doanh thu c·∫ßn ƒë·ªÉ l√£i = 0.</div>`;

        const marginText = (m3Info.revenue > 0 && isFinite(m3Info.profit))
          ? formatPercent(m3Info.profit / m3Info.revenue * 100)
          : '‚Äì';

        const card2 = document.createElement('div');
        card2.className = 'summary-card';
        card2.innerHTML =
          '<div class="summary-title">Bi√™n l·ª£i nhu·∫≠n t·∫°i M·ªëc 3</div>' +
          `<div class="summary-value">${marginText}</div>` +
          '<div class="small">T√≠nh tr√™n doanh thu M·ªëc 3 c·ªßa team n√†y.</div>';

        const card3 = document.createElement('div');
        card3.className = 'summary-card';
        card3.innerHTML =
          '<div class="summary-title">T·ªïng th∆∞·ªüng t·∫°i M·ªëc 3</div>' +
          `<div class="summary-value">${m3Info.totalBonus > 0 ? formatMoney(m3Info.totalBonus) : '‚Äì'}</div>` +
          '<div class="small">Sale + RD + CSKH + KT+HCNS + Media (ch·ªâ khi LN &gt; 0).</div>';

        summaryGrid.appendChild(card1);
        summaryGrid.appendChild(card2);
        summaryGrid.appendChild(card3);

        block.appendChild(summaryGrid);

        // chi ti·∫øt b·∫£ng
        const detailWrapper = document.createElement('div');

        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>M·ªëc</th>
            <th>Doanh thu</th>
            <th>T·ªïng chi ph√≠</th>
            <th>L·ª£i nhu·∫≠n</th>
            <th>Bi√™n LN (%)</th>
            <th>Th∆∞·ªüng Sale</th>
            <th>Th∆∞·ªüng RD</th>
            <th>Th∆∞·ªüng CSKH</th>
            <th>Th∆∞·ªüng KT+HCNS</th>
            <th>Th∆∞·ªüng Media</th>
            <th>T·ªïng th∆∞·ªüng</th>
            <th>T·ªïng th∆∞·ªüng / LN</th>
          </tr>
        `;
        const tbody = document.createElement('tbody');

        rows.forEach(row => {
          if (!row) return;
          const tr = document.createElement('tr');

          const tdLabel = document.createElement('td');
          tdLabel.textContent = row.label;
          tdLabel.style.textAlign = 'left';

          const tdRev = document.createElement('td');
          tdRev.textContent = formatMoney(row.revenue);

          const tdCost = document.createElement('td');
          tdCost.textContent = formatMoney(row.totalCost);

          const tdProfit = document.createElement('td');
          tdProfit.className = 'pl-cell';
          if (row.profit < 0) {
            tdProfit.classList.add('pl-neg');
          } else if (row.profit === 0 || row.margin < 3) {
            tdProfit.classList.add('pl-low');
          } else {
            tdProfit.classList.add('pl-pos');
          }
          tdProfit.textContent = formatMoney(row.profit);

          const tdMargin = document.createElement('td');
          tdMargin.textContent = formatPercent(row.margin);

          const tdSale = document.createElement('td');
          tdSale.textContent = row.saleBonus > 0 ? formatMoney(row.saleBonus) : '‚Äì';

          const tdRd = document.createElement('td');
          tdRd.textContent = row.rdBonus > 0 ? formatMoney(row.rdBonus) : '‚Äì';

          const tdCskh = document.createElement('td');
          tdCskh.textContent = row.cskhBonus > 0 ? formatMoney(row.cskhBonus) : '‚Äì';

          const tdHcns = document.createElement('td');
          tdHcns.textContent = row.hcnsBonus > 0 ? formatMoney(row.hcnsBonus) : '‚Äì';

          const tdMedia = document.createElement('td');
          tdMedia.textContent = row.mediaBonus > 0 ? formatMoney(row.mediaBonus) : '‚Äì';

          const tdTotalBonus = document.createElement('td');
          tdTotalBonus.textContent = row.totalBonus > 0 ? formatMoney(row.totalBonus) : '‚Äì';

          const tdRatio = document.createElement('td');
          tdRatio.textContent =
            row.totalBonus > 0 && row.profit > 0
              ? formatPercent(row.bonusOnProfit)
              : '‚Äì';

          tr.appendChild(tdLabel);
          tr.appendChild(tdRev);
          tr.appendChild(tdCost);
          tr.appendChild(tdProfit);
          tr.appendChild(tdMargin);
          tr.appendChild(tdSale);
          tr.appendChild(tdRd);
          tr.appendChild(tdCskh);
          tr.appendChild(tdHcns);
          tr.appendChild(tdMedia);
          tr.appendChild(tdTotalBonus);
          tr.appendChild(tdRatio);

          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        detailWrapper.appendChild(tableWrapper);
        block.appendChild(detailWrapper);

        toggleBtn.addEventListener('click', () => {
          const hidden = detailWrapper.style.display === 'none';
          detailWrapper.style.display = hidden ? '' : 'none';
          toggleBtn.textContent = hidden ? '·∫®n chi ti·∫øt' : 'Xem chi ti·∫øt';
        });

        teamsOverviewContainer.appendChild(block);
      });
    }

    function recalcAllTeamsSummary() {
      allTeamsBody.innerHTML = '';

      let sumRevenue = 0;
      let sumProfit = 0;
      let sumSaleBonus = 0;
      let sumRdBonus = 0;
      let sumCskhBonus = 0;
      let sumHcnsBonus = 0;
      let sumMediaBonus = 0;

      Object.values(teams).forEach(team => {
        const { rows } = computeTeamRows(team);
        const m3Row = rows[2]; // M·ªëc 3

        const revenue = team.targets && team.targets[2] ? team.targets[2] : 0;

        const varRateDecimal = ((team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0)) / 100;
        const fixed = team.fixedCost || 0;
        const totalCost = revenue * varRateDecimal + fixed;
        const profit = revenue - totalCost;

        const saleBonusRate = team.saleBonusRate || 0;
        const rdBonusRate = team.rdBonusRate || 0;
        const cskhBonusRate = team.cskhBonusRate || 0;
        const hcnsBonusRate = team.hcnsBonusRate || 0;
        const mediaBonusRate = team.mediaBonusRate || 0;

        const saleBonus = profit > 0 ? profit * (saleBonusRate / 100) : 0;
        const rdBonus = profit > 0 ? profit * (rdBonusRate / 100) : 0;
        const cskhBonus = profit > 0 ? profit * (cskhBonusRate / 100) : 0;
        const hcnsBonus = profit > 0 ? profit * (hcnsBonusRate / 100) : 0;
        const mediaBonus = profit > 0 ? profit * (mediaBonusRate / 100) : 0;

        const totalBonus = saleBonus + rdBonus + cskhBonus + hcnsBonus + mediaBonus;

        sumRevenue += revenue;
        sumProfit += profit;
        sumSaleBonus += saleBonus;
        sumRdBonus += rdBonus;
        sumCskhBonus += cskhBonus;
        sumHcnsBonus += hcnsBonus;
        sumMediaBonus += mediaBonus;

        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = team.name || team.id;
        tdName.style.textAlign = 'left';

        const tdRev = document.createElement('td');
        tdRev.textContent = revenue > 0 ? formatMoney(revenue) : (m3Row ? formatMoney(m3Row.revenue) : '‚Äì');

        const tdProfit = document.createElement('td');
        tdProfit.textContent = revenue > 0 ? formatMoney(profit) : (m3Row ? formatMoney(m3Row.profit) : '‚Äì');

        const tdSale = document.createElement('td');
        tdSale.textContent = saleBonus > 0 ? formatMoney(saleBonus) : '‚Äì';

        const tdRd = document.createElement('td');
        tdRd.textContent = rdBonus > 0 ? formatMoney(rdBonus) : '‚Äì';

        const tdCskh = document.createElement('td');
        tdCskh.textContent = cskhBonus > 0 ? formatMoney(cskhBonus) : '‚Äì';

        const tdHcns = document.createElement('td');
        tdHcns.textContent = hcnsBonus > 0 ? formatMoney(hcnsBonus) : '‚Äì';

        const tdMedia = document.createElement('td');
        tdMedia.textContent = mediaBonus > 0 ? formatMoney(mediaBonus) : '‚Äì';

        const tdTotalBonus = document.createElement('td');
        tdTotalBonus.textContent = totalBonus > 0 ? formatMoney(totalBonus) : '‚Äì';

        tr.appendChild(tdName);
        tr.appendChild(tdRev);
        tr.appendChild(tdProfit);
        tr.appendChild(tdSale);
        tr.appendChild(tdRd);
        tr.appendChild(tdCskh);
        tr.appendChild(tdHcns);
        tr.appendChild(tdMedia);
        tr.appendChild(tdTotalBonus);

        allTeamsBody.appendChild(tr);
      });

      const trTotal = document.createElement('tr');
      trTotal.style.fontWeight = '600';

      const tdLabel = document.createElement('td');
      tdLabel.textContent = 'T·ªîNG (t·∫•t c·∫£ team)';
      tdLabel.style.textAlign = 'left';

      const tdRevSum = document.createElement('td');
      tdRevSum.textContent = formatMoney(sumRevenue);

      const tdProfitSum = document.createElement('td');
      tdProfitSum.textContent = formatMoney(sumProfit);

      const tdSaleSum = document.createElement('td');
      tdSaleSum.textContent = formatMoney(sumSaleBonus);

      const tdRdSum = document.createElement('td');
      tdRdSum.textContent = formatMoney(sumRdBonus);

      const tdCskhSum = document.createElement('td');
      tdCskhSum.textContent = formatMoney(sumCskhBonus);

      const tdHcnsSum = document.createElement('td');
      tdHcnsSum.textContent = formatMoney(sumHcnsBonus);

      const tdMediaSum = document.createElement('td');
      tdMediaSum.textContent = formatMoney(sumMediaBonus);

      const tdBonusSum = document.createElement('td');
      tdBonusSum.textContent = formatMoney(
        sumSaleBonus + sumRdBonus + sumCskhBonus + sumHcnsBonus + sumMediaBonus
      );

      trTotal.appendChild(tdLabel);
      trTotal.appendChild(tdRevSum);
      trTotal.appendChild(tdProfitSum);
      trTotal.appendChild(tdSaleSum);
      trTotal.appendChild(tdRdSum);
      trTotal.appendChild(tdCskhSum);
      trTotal.appendChild(tdHcnsSum);
      trTotal.appendChild(tdMediaSum);
      trTotal.appendChild(tdBonusSum);

      allTeamsBody.appendChild(trTotal);
    }

    function recalc() {
      renderTeamsOverview();
      recalcAllTeamsSummary();
    }

    // ====== Events ======
    teamSelect.addEventListener('change', () => {
      currentTeamId = teamSelect.value;
      saveState();
      renderCurrentTeamConfig();
    });

    addTeamBtn.addEventListener('click', () => {
      const id = 'team_' + Date.now();
      teams[id] = {
        id,
        name: 'Team m·ªõi',
        fixedCost: 0,
        cogsRate: 60,
        sellRate: 10,
        otherRate: 5,
        saleBonusRate: 20,
        rdBonusRate: 5,
        cskhBonusRate: 3,
        hcnsBonusRate: 3,
        mediaBonusRate: 2,
        targets: [...DEFAULT_TARGETS]
      };
      currentTeamId = id;
      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    saveTeamBtn.addEventListener('click', () => {
      const team = teams[currentTeamId];
      if (!team) return;

      team.name = teamNameInput.value || team.name;
      team.fixedCost = parseMoney(teamNameInput.value) ? team.fixedCost : parseMoney(fixedCostInput.value);
      team.fixedCost = parseMoney(fixedCostInput.value);
      team.cogsRate = parseFloat(cogsRateInput.value || '0');
      team.sellRate = parseFloat(sellRateInput.value || '0');
      team.otherRate = parseFloat(otherRateInput.value || '0');
      team.saleBonusRate = parseFloat(saleBonusRateInput.value || '0');
      team.rdBonusRate = parseFloat(rdBonusRateInput.value || '0');
      team.cskhBonusRate = parseFloat(cskhBonusRateInput.value || '0');
      team.hcnsBonusRate = parseFloat(hcnsBonusRateInput.value || '0');
      team.mediaBonusRate = parseFloat(mediaBonusRateInput.value || '0');

      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    resetTeamBtn.addEventListener('click', () => {
      const def = DEFAULT_TEAMS[currentTeamId];
      if (def) {
        teams[currentTeamId] = {
          ...def,
          targets: [...def.targets]
        };
      } else {
        teams[currentTeamId] = {
          id: currentTeamId,
          name: 'Team m·ªõi',
          fixedCost: 0,
          cogsRate: 60,
          sellRate: 10,
          otherRate: 5,
          saleBonusRate: 20,
          rdBonusRate: 5,
          cskhBonusRate: 3,
          hcnsBonusRate: 3,
          mediaBonusRate: 2,
          targets: [...DEFAULT_TARGETS]
        };
      }
      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    [fixedCostInput, cogsRateInput, sellRateInput, otherRateInput].forEach(el => {
      el.addEventListener('input', () => {
        normalizeMoneyInput(fixedCostInput);
        recalcLeftPreview();
      });
    });

    // INIT
    loadState();
    renderTeamOptions();
    renderCurrentTeamConfig();
    recalc();
  });
</script>
</body>
</html>
