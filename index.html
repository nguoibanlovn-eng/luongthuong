<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu – lợi nhuận – thưởng theo team | Lỗ Vũ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      padding: 16px;
      max-width: 1100px;
      margin-inline: auto;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 14px;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 6px;
    }
    h2 {
      margin-top: 20px;
      font-size: 18px;
    }
    p {
      margin: 2px 0 6px;
    }
    .muted {
      opacity: 0.7;
      font-size: 12px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 6px 0 10px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid rgba(128,128,128,0.5);
      padding: 6px 12px;
      background: transparent;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    button.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }
    button.danger {
      border-color: #dc2626;
      color: #dc2626;
    }
    button.small {
      padding: 4px 8px;
      font-size: 11px;
    }

    .chip-button {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(128,128,128,0.06);
    }
    .chip-button.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(128,128,128,0.5);
      font-size: 13px;
      background: transparent;
      height: 32px;
    }
    input:focus {
      outline: 2px solid #2563eb55;
      border-color: #2563eb;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .col-2 { grid-column: span 2; }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    @media (max-width: 768px) {
      .col-2,
      .col-3,
      .col-4,
      .col-6 { grid-column: span 12; }
    }

    .card {
      border-radius: 14px;
      border: 1px solid rgba(128,128,128,0.35);
      padding: 10px;
      margin-bottom: 12px;
      background: rgba(255,255,255,0.02);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(128,128,128,0.6);
      background: rgba(128,128,128,0.05);
    }

    .pill-input {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(128,128,128,0.6);
      background: rgba(249,250,251,0.8);
    }
    .pill-input span {
      opacity: 0.7;
    }
    .pill-input strong {
      font-variant-numeric: tabular-nums;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(128,128,128,0.25);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    th:first-child,
    td:first-child {
      text-align: left;
    }
    th {
      font-weight: 600;
      background: rgba(148,163,184,0.18);
    }
    tbody tr:nth-child(even) {
      background: rgba(148,163,184,0.08);
    }
    tfoot td {
      font-weight: 600;
      background: rgba(37,99,235,0.06);
    }
    .row-total {
      background: rgba(59,130,246,0.08) !important;
    }
    .row-profit {
      background: rgba(16,185,129,0.08) !important;
    }
    .positive {
      color: #16a34a;
    }
    .negative {
      color: #dc2626;
    }
    .section-divider {
      margin: 14px 0 8px;
      border-top: 1px dashed rgba(148,163,184,0.9);
    }
    .tagline {
      font-size: 12px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h1>Plan doanh thu – lợi nhuận – thưởng theo team</h1>
  <p class="muted">
    Công cụ nội bộ giúp Lỗ Vũ &amp; team set target, tính hòa vốn, chia thưởng theo từng team
    (Sale, RD, CSKH, KT+HCNS, Media).
  </p>

  <div class="section-divider"></div>

  <h2>Cấu hình team <span class="muted">Áp dụng trong phiên làm việc này</span></h2>
  <div class="toolbar">
    <div>
      <span class="muted">Chọn team nhanh:</span>
      <button class="chip-button" data-name="TikTok" onclick="focusTeam('TikTok')">TikTok</button>
      <button class="chip-button" data-name="Shopee" onclick="focusTeam('Shopee')">Shopee</button>
      <button class="chip-button" data-name="Facebook" onclick="focusTeam('Facebook')">Facebook</button>
      <button class="chip-button" data-name="Offline" onclick="focusTeam('Offline')">Offline</button>
    </div>
    <div>
      <button class="primary" onclick="addTeam()">+ Thêm team</button>
    </div>
  </div>
  <p class="muted">
    • Thay đổi chỉ lưu trong lần mở trang này (reload sẽ quay về mặc định).<br />
    • Mỗi team có chi phí &amp; mức thưởng riêng: Sale, RD, CSKH, KT+HCNS, Media.
  </p>

  <div id="teamsContainer"></div>

  <div class="section-divider"></div>

  <h2>Mục tiêu doanh thu &amp; tổng quan các team</h2>
  <p class="muted">
    Mỗi team dùng 3 mốc doanh thu: <b>Mốc 1</b>, <b>Mốc 2</b>, <b>Mốc 3 (thực tế)</b>. Mốc 3 dùng để
    tính tổng doanh thu &amp; tổng thưởng toàn công ty.
  </p>
  <p class="muted">
    • Dùng nút "<b>Ẩn chi tiết / Xem chi tiết</b>" trên từng team để thu gọn bảng.<br />
    • Mốc 3 là “mốc thực tế” để cộng tổng doanh nghiệp.
  </p>

  <h2 style="margin-top: 18px;">Tổng quan tất cả team (Mốc 3 – thực tế)</h2>
  <div id="summaryContainer"></div>

  <p class="tagline">
    Xây dựng bởi Lỗ Vũ – đọc thêm chia sẻ về TMĐT tại
    <a href="https://nguoibanlo.vn" target="_blank" rel="noreferrer">nguoibanlo.vn</a>
  </p>

  <script>
    function formatCurrency(n) {
      if (isNaN(n)) return "-";
      return n.toLocaleString("vi-VN", { maximumFractionDigits: 0 });
    }
    function formatPercent(n) {
      if (isNaN(n)) return "-";
      return n.toLocaleString("vi-VN", { maximumFractionDigits: 1 }) + " %";
    }

    function createDefaultTeam(name) {
      return {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        name: name || "Team mới",
        fixedCost: 30000000,
        cogs: 60,
        selling: 10,
        other: 5,
        bonusSale: 10,
        bonusRD: 5,
        bonusCSKH: 5,
        bonusKT: 3,
        bonusMedia: 5,
        revenue1: 100000000,
        revenue2: 150000000,
        revenue3: 200000000,
        collapsed: false
      };
    }

    let teams = [
      createDefaultTeam("TikTok"),
      createDefaultTeam("Shopee")
    ];

    // --- chọn team nhanh bằng chip ---
    function focusTeam(name) {
      // highlight chip
      document.querySelectorAll(".chip-button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.name === name);
      });

      // tìm team theo name
      let t = teams.find(team => team.name.toLowerCase() === name.toLowerCase());
      if (!t) {
        t = createDefaultTeam(name);
        teams = [...teams, t];
      }
      render();

      // scroll tới card của team
      requestAnimationFrame(() => {
        const el = document.querySelector(`.card[data-team-id="${t.id}"]`);
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    function computeTeamMetrics(team) {
      const varPct = (Number(team.cogs) || 0) +
                     (Number(team.selling) || 0) +
                     (Number(team.other) || 0);

      function calcForRevenue(r) {
        const revenue = Number(r) || 0;
        const variableCost = revenue * (varPct / 100);
        const grossProfit = revenue - variableCost;
        const fixedCost = Number(team.fixedCost) || 0;
        const netProfit = grossProfit - fixedCost;
        const safeProfit = Math.max(0, netProfit);

        const bonusSale = safeProfit * ((Number(team.bonusSale) || 0) / 100);
        const bonusRD = safeProfit * ((Number(team.bonusRD) || 0) / 100);
        const bonusCSKH = safeProfit * ((Number(team.bonusCSKH) || 0) / 100);
        const bonusKT = safeProfit * ((Number(team.bonusKT) || 0) / 100);
        const bonusMedia = safeProfit * ((Number(team.bonusMedia) || 0) / 100);

        const totalBonus = bonusSale + bonusRD + bonusCSKH + bonusKT + bonusMedia;
        const profitAfterBonus = netProfit - totalBonus;

        return {
          revenue,
          variableCost,
          grossProfit,
          fixedCost,
          netProfit,
          bonusSale,
          bonusRD,
          bonusCSKH,
          bonusKT,
          bonusMedia,
          totalBonus,
          profitAfterBonus
        };
      }

      let breakEven = null;
      const fixedCost = Number(team.fixedCost) || 0;
      if (varPct < 100 && fixedCost > 0) {
        breakEven = fixedCost / (1 - varPct / 100);
      }

      return {
        varPct,
        breakEven,
        m1: calcForRevenue(team.revenue1),
        m2: calcForRevenue(team.revenue2),
        m3: calcForRevenue(team.revenue3)
      };
    }

    function handleInput(teamId, field, value) {
      teams = teams.map(t =>
        t.id === teamId ? { ...t, [field]: value } : t
      );
      render();
    }

    function toggleCollapse(teamId) {
      teams = teams.map(t =>
        t.id === teamId ? { ...t, collapsed: !t.collapsed } : t
      );
      render();
    }

    function deleteTeam(teamId) {
      if (teams.length === 1) {
        alert("Cần ít nhất 1 team.");
        return;
      }
      teams = teams.filter(t => t.id !== teamId);
      render();
    }

    function addTeam() {
      teams = [...teams, createDefaultTeam("Team mới")];
      render();
    }

    function renderTeams() {
      const container = document.getElementById("teamsContainer");
      container.innerHTML = "";

      teams.forEach((team, index) => {
        const metrics = computeTeamMetrics(team);
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.teamId = team.id;

        const breakEvenText = metrics.breakEven
          ? formatCurrency(metrics.breakEven) + " đ"
          : "Không xác định";

        const headerHtml = `
          <div class="card-header">
            <div class="card-header-left">
              <span class="badge">Team ${index + 1}</span>
              <input
                type="text"
                value="${team.name}"
                oninput="handleInput('${team.id}', 'name', this.value)"
                style="max-width: 170px;"
              />
              <span class="pill-input">
                <span>Tổng biến phí:</span>
                <strong>${formatPercent(metrics.varPct)}</strong>
              </span>
              <span class="pill-input">
                <span>Điểm hòa vốn:</span>
                <strong>${breakEvenText}</strong>
              </span>
            </div>
            <div>
              <button class="small" onclick="toggleCollapse('${team.id}')">
                ${team.collapsed ? "Xem chi tiết" : "Ẩn chi tiết"}
              </button>
              <button class="small danger" onclick="deleteTeam('${team.id}')">
                Xóa
              </button>
            </div>
          </div>
        `;

        let bodyHtml = "";
        if (!team.collapsed) {
          bodyHtml += `
            <div class="grid">
              <div class="col-3">
                <p><strong>Chi phí cố định / kỳ (VNĐ)</strong></p>
                <input
                  type="number"
                  value="${team.fixedCost}"
                  oninput="handleInput('${team.id}', 'fixedCost', this.value)"
                  placeholder="Lương cứng, mặt bằng..."
                />
              </div>
              <div class="col-3">
                <p><strong>% Giá vốn (COGS)</strong></p>
                <input
                  type="number"
                  value="${team.cogs}"
                  oninput="handleInput('${team.id}', 'cogs', this.value)"
                  placeholder="VD: 60"
                />
              </div>
              <div class="col-3">
                <p><strong>% Chi phí bán hàng</strong></p>
                <input
                  type="number"
                  value="${team.selling}"
                  oninput="handleInput('${team.id}', 'selling', this.value)"
                  placeholder="VD: 10"
                />
              </div>
              <div class="col-3">
                <p><strong>% Chi phí khác (biến phí)</strong></p>
                <input
                  type="number"
                  value="${team.other}"
                  oninput="handleInput('${team.id}', 'other', this.value)"
                  placeholder="VD: 5"
                />
              </div>
              <div class="col-12 muted">
                = Giá vốn + Chi phí bán hàng + Chi phí khác → <b>Tổng biến phí: ${formatPercent(metrics.varPct)}</b>
              </div>

              <div class="col-12" style="margin-top: 6px;">
                <p><strong>% thưởng trên LỢI NHUẬN (chỉ tính khi lợi nhuận &gt; 0)</strong></p>
              </div>
              <div class="col-2">
                <p>Sale</p>
                <input
                  type="number"
                  value="${team.bonusSale}"
                  oninput="handleInput('${team.id}', 'bonusSale', this.value)"
                />
              </div>
              <div class="col-2">
                <p>RD</p>
                <input
                  type="number"
                  value="${team.bonusRD}"
                  oninput="handleInput('${team.id}', 'bonusRD', this.value)"
                />
              </div>
              <div class="col-2">
                <p>CSKH</p>
                <input
                  type="number"
                  value="${team.bonusCSKH}"
                  oninput="handleInput('${team.id}', 'bonusCSKH', this.value)"
                />
              </div>
              <div class="col-2">
                <p>KT + HCNS</p>
                <input
                  type="number"
                  value="${team.bonusKT}"
                  oninput="handleInput('${team.id}', 'bonusKT', this.value)"
                />
              </div>
              <div class="col-2">
                <p>Media</p>
                <input
                  type="number"
                  value="${team.bonusMedia}"
                  oninput="handleInput('${team.id}', 'bonusMedia', this.value)"
                />
              </div>
              <div class="col-12 muted">
                Tổng % thưởng = Sale + RD + CSKH + KT + Media. Nên giữ ở mức hợp lý để doanh nghiệp vẫn còn lợi nhuận.
              </div>

              <div class="col-12" style="margin-top: 6px;">
                <p><strong>Doanh thu 3 mốc</strong></p>
              </div>
              <div class="col-4">
                <p>Mốc 1</p>
                <input
                  type="number"
                  value="${team.revenue1}"
                  oninput="handleInput('${team.id}', 'revenue1', this.value)"
                  placeholder="Mục tiêu thấp"
                />
              </div>
              <div class="col-4">
                <p>Mốc 2</p>
                <input
                  type="number"
                  value="${team.revenue2}"
                  oninput="handleInput('${team.id}', 'revenue2', this.value)"
                  placeholder="Mục tiêu chuẩn"
                />
              </div>
              <div class="col-4">
                <p>Mốc 3 (thực tế)</p>
                <input
                  type="number"
                  value="${team.revenue3}"
                  oninput="handleInput('${team.id}', 'revenue3', this.value)"
                  placeholder="Thực tế đạt"
                />
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Chỉ tiêu</th>
                  <th>Mốc 1</th>
                  <th>Mốc 2</th>
                  <th>Mốc 3</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Doanh thu</td>
                  <td>${formatCurrency(metrics.m1.revenue)}</td>
                  <td>${formatCurrency(metrics.m2.revenue)}</td>
                  <td>${formatCurrency(metrics.m3.revenue)}</td>
                </tr>
                <tr>
                  <td>Biến phí</td>
                  <td>${formatCurrency(metrics.m1.variableCost)}</td>
                  <td>${formatCurrency(metrics.m2.variableCost)}</td>
                  <td>${formatCurrency(metrics.m3.variableCost)}</td>
                </tr>
                <tr>
                  <td>Lợi nhuận gộp (sau biến phí)</td>
                  <td>${formatCurrency(metrics.m1.grossProfit)}</td>
                  <td>${formatCurrency(metrics.m2.grossProfit)}</td>
                  <td>${formatCurrency(metrics.m3.grossProfit)}</td>
                </tr>
                <tr>
                  <td>Chi phí cố định</td>
                  <td>${formatCurrency(metrics.m1.fixedCost)}</td>
                  <td>${formatCurrency(metrics.m2.fixedCost)}</td>
                  <td>${formatCurrency(metrics.m3.fixedCost)}</td>
                </tr>
                <tr>
                  <td>Lợi nhuận trước thưởng</td>
                  <td class="${metrics.m1.netProfit >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m1.netProfit)}
                  </td>
                  <td class="${metrics.m2.netProfit >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m2.netProfit)}
                  </td>
                  <td class="${metrics.m3.netProfit >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m3.netProfit)}
                  </td>
                </tr>
                <tr>
                  <td>Thưởng Sale</td>
                  <td>${formatCurrency(metrics.m1.bonusSale)}</td>
                  <td>${formatCurrency(metrics.m2.bonusSale)}</td>
                  <td>${formatCurrency(metrics.m3.bonusSale)}</td>
                </tr>
                <tr>
                  <td>Thưởng RD</td>
                  <td>${formatCurrency(metrics.m1.bonusRD)}</td>
                  <td>${formatCurrency(metrics.m2.bonusRD)}</td>
                  <td>${formatCurrency(metrics.m3.bonusRD)}</td>
                </tr>
                <tr>
                  <td>Thưởng CSKH</td>
                  <td>${formatCurrency(metrics.m1.bonusCSKH)}</td>
                  <td>${formatCurrency(metrics.m2.bonusCSKH)}</td>
                  <td>${formatCurrency(metrics.m3.bonusCSKH)}</td>
                </tr>
                <tr>
                  <td>Thưởng KT + HCNS</td>
                  <td>${formatCurrency(metrics.m1.bonusKT)}</td>
                  <td>${formatCurrency(metrics.m2.bonusKT)}</td>
                  <td>${formatCurrency(metrics.m3.bonusKT)}</td>
                </tr>
                <tr>
                  <td>Thưởng Media</td>
                  <td>${formatCurrency(metrics.m1.bonusMedia)}</td>
                  <td>${formatCurrency(metrics.m2.bonusMedia)}</td>
                  <td>${formatCurrency(metrics.m3.bonusMedia)}</td>
                </tr>
                <tr class="row-total">
                  <td><strong>Tổng thưởng</strong></td>
                  <td>${formatCurrency(metrics.m1.totalBonus)}</td>
                  <td>${formatCurrency(metrics.m2.totalBonus)}</td>
                  <td>${formatCurrency(metrics.m3.totalBonus)}</td>
                </tr>
                <tr class="row-profit">
                  <td><strong>Lợi nhuận sau thưởng</strong></td>
                  <td class="${metrics.m1.profitAfterBonus >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m1.profitAfterBonus)}
                  </td>
                  <td class="${metrics.m2.profitAfterBonus >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m2.profitAfterBonus)}
                  </td>
                  <td class="${metrics.m3.profitAfterBonus >= 0 ? "positive" : "negative"}">
                    ${formatCurrency(metrics.m3.profitAfterBonus)}
                  </td>
                </tr>
              </tbody>
            </table>
          `;
        }

        card.innerHTML = headerHtml + bodyHtml;
        container.appendChild(card);
      });
    }

    function renderSummary() {
      const container = document.getElementById("summaryContainer");
      if (!teams.length) {
        container.innerHTML = "<p class='muted'>Chưa có team nào.</p>";
        return;
      }

      let rowsHtml = "";
      let totalRevenue = 0;
      let totalProfit = 0;
      let totalSale = 0, totalRD = 0, totalCSKH = 0, totalKT = 0, totalMedia = 0, totalBonus = 0;

      teams.forEach(team => {
        const metrics = computeTeamMetrics(team).m3;
        totalRevenue += metrics.revenue;
        totalProfit += metrics.profitAfterBonus;
        totalSale += metrics.bonusSale;
        totalRD += metrics.bonusRD;
        totalCSKH += metrics.bonusCSKH;
        totalKT += metrics.bonusKT;
        totalMedia += metrics.bonusMedia;
        totalBonus += metrics.totalBonus;

        rowsHtml += `
          <tr>
            <td>${team.name}</td>
            <td>${formatCurrency(metrics.revenue)}</td>
            <td class="${metrics.profitAfterBonus >= 0 ? "positive" : "negative"}">
              ${formatCurrency(metrics.profitAfterBonus)}
            </td>
            <td>${formatCurrency(metrics.bonusSale)}</td>
            <td>${formatCurrency(metrics.bonusRD)}</td>
            <td>${formatCurrency(metrics.bonusCSKH)}</td>
            <td>${formatCurrency(metrics.bonusKT)}</td>
            <td>${formatCurrency(metrics.bonusMedia)}</td>
            <td>${formatCurrency(metrics.totalBonus)}</td>
          </tr>
        `;
      });

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>Doanh thu Mốc 3</th>
              <th>Lợi nhuận sau thưởng</th>
              <th>Thưởng Sale</th>
              <th>Thưởng RD</th>
              <th>Thưởng CSKH</th>
              <th>Thưởng KT+HCNS</th>
              <th>Thưởng Media</th>
              <th>Tổng thưởng</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
          <tfoot>
            <tr>
              <td><strong>Tổng doanh nghiệp</strong></td>
              <td>${formatCurrency(totalRevenue)}</td>
              <td class="${totalProfit >= 0 ? "positive" : "negative"}">
                ${formatCurrency(totalProfit)}
              </td>
              <td>${formatCurrency(totalSale)}</td>
              <td>${formatCurrency(totalRD)}</td>
              <td>${formatCurrency(totalCSKH)}</td>
              <td>${formatCurrency(totalKT)}</td>
              <td>${formatCurrency(totalMedia)}</td>
              <td>${formatCurrency(totalBonus)}</td>
            </tr>
          </tfoot>
        </table>
      `;

      container.innerHTML = tableHtml;
    }

    function render() {
      renderTeams();
      renderSummary();
    }

    render();
  </script>
</body>
</html>
