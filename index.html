<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng team | L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #0b57d0;
      --bg: #f5f5f5;
      --card-radius: 12px;
      --green-bg: #e6f4ea;
      --green-text: #137333;
      --yellow-bg: #fff8e1;
      --yellow-text: #b05a00;
      --red-bg: #fce8e6;
      --red-text: #b3261e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 16px 16px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: .01em;
    }

    .subtitle {
      font-size: 12px;
      color: #666;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 16px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: var(--card-radius);
      border: 1px solid #e5e5e5;
      padding: 12px 12px 14px;
      background: #fafafa;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .team-select-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .team-select-row label {
      font-size: 13px;
      color: #444;
    }

    select, input[type="text"], input[type="number"] {
      font-family: inherit;
      font-size: 13px;
    }

    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      min-width: 150px;
    }

    select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5f0ff;
      color: #1a4fbf;
      white-space: nowrap;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 12px;
      margin-bottom: 2px;
      color: #444;
    }

    .field-sub {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row .field-group {
      flex: 1;
      margin-bottom: 0;
    }

    .field-input {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      outline: none;
      text-align: right;
    }

    .field-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
      background: #fff;
    }

    .field-input[readonly] {
      background: #f3f4f6;
      cursor: default;
    }

    .small {
      font-size: 11px;
      color: #777;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }

    .btn-primary:hover {
      background: #0a4ab5;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #ddd;
      color: #555;
    }

    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      border-radius: 10px;
      border: 1px solid #eee;
      background: #fafafa;
      padding: 8px 10px;
      font-size: 12px;
    }

    .summary-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .targets-row {
      margin-bottom: 6px;
    }

    .target-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .target-inputs .target-field {
      flex: 1 1 120px;
    }

    .target-label {
      font-size: 11px;
      color: #555;
      margin-bottom: 2px;
    }

    .target-inputs input {
      width: 100%;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: right;
      background: #fff;
      outline: none;
    }

    .target-inputs input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .table-wrapper {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }

    .pl-cell {
      font-weight: 500;
    }
    .pl-pos {
      background: var(--green-bg);
      color: var(--green-text);
    }
    .pl-low {
      background: var(--yellow-bg);
      color: var(--yellow-text);
    }
    .pl-neg {
      background: var(--red-bg);
      color: var(--red-text);
    }

    .note {
      margin-top: 6px;
      font-size: 11px;
      color: #777;
    }

    .footer-cta {
      margin-top: 16px;
      text-align: center;
      font-size: 12px;
      color: #555;
    }

    .footer-cta a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .footer-cta a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng theo team</h1>
    <div class="subtitle">
      C√¥ng c·ª• n·ªôi b·ªô gi√∫p L·ªó V≈© &amp; team set target ‚Äì t√≠nh h√≤a v·ªën ‚Äì chia th∆∞·ªüng theo t·ª´ng team (Sale, RD, CSKH, KT+HCNS, Media).
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: c·∫•u h√¨nh t·ª´ng team -->
    <section class="panel">
      <div class="panel-title">
        <span>C·∫•u h√¨nh team</span>
        <span class="tag">L∆∞u theo tr√¨nh duy·ªát c·ªßa b·∫°n</span>
      </div>

      <div class="team-select-row">
        <label for="teamSelect">Ch·ªçn team:</label>
        <select id="teamSelect"></select>
        <button class="btn btn-ghost" id="addTeamBtn" type="button">+ Th√™m team</button>
      </div>

      <div class="field-group">
        <label class="field-label" for="teamNameInput">T√™n team</label>
        <input id="teamNameInput" type="text" class="field-input" />
        <div class="field-sub">V√≠ d·ª•: Facebook, TikTok, Shopee, Web, Offline‚Ä¶</div>
      </div>

      <div class="field-group">
        <label class="field-label">Chi ph√≠ c·ªë ƒë·ªãnh m·ªói k·ª≥ (VNƒê)</label>
        <input id="fixedCostInput" type="text" class="field-input" inputmode="numeric" />
        <div class="field-sub">L∆∞∆°ng c·ª©ng, m·∫∑t b·∫±ng, qu·∫£n l√Ω chung‚Ä¶ d√†nh ri√™ng cho team n√†y.</div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Gi√° v·ªën (COGS)</label>
          <input id="cogsRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">T√≠nh theo % doanh thu.</div>
        </div>
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ b√°n h√†ng</label>
          <input id="sellRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Marketing, CSKH, v·∫≠n h√†nh theo %.</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ kh√°c (bi·∫øn ph√≠)</label>
          <input id="otherRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Ph√≠ s√†n, POS, thu h·ªô, v·∫≠n chuy·ªÉn‚Ä¶</div>
        </div>
        <div class="field-group">
          <label class="field-label">T·ªïng bi·∫øn ph√≠ (%)</label>
          <input id="totalVarRateDisplay" type="text" class="field-input" readonly />
          <div class="field-sub">= Gi√° v·ªën + b√°n h√†ng + kh√°c</div>
        </div>
      </div>

      <!-- T·ª∑ l·ªá th∆∞·ªüng -->
      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng Sale tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="saleBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng RD tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="rdBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng CSKH tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="cskhBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng KT + HCNS tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="hcnsBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">% th∆∞·ªüng Media tr√™n L·ª¢I NHU·∫¨N</label>
        <input id="mediaBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
      </div>

      <div class="field-group">
        <label class="field-label">ƒêi·ªÉm h√≤a v·ªën (theo c·∫•u h√¨nh team)</label>
        <input id="breakevenDisplay" type="text" class="field-input" readonly />
        <div class="field-sub">
          Doanh thu c·∫ßn ƒë·∫°t ƒë·ªÉ l·ª£i nhu·∫≠n = 0 (ch·ªâ ƒë·ªß b√π chi ph√≠).
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn btn-primary" id="saveTeamBtn" type="button">üíæ L∆∞u c·∫•u h√¨nh team</button>
        <button class="btn btn-ghost" id="resetTeamBtn" type="button">‚Ü∫ ƒê∆∞a v·ªÅ m·∫∑c ƒë·ªãnh</button>
      </div>

      <div class="note">
        ‚Ä¢ M·ªói team c√≥ th·ªÉ c√≥ chi ph√≠ &amp; m·ª©c th∆∞·ªüng ri√™ng cho t·ª´ng b·ªô ph·∫≠n (Sale, RD, CSKH, KT+HCNS, Media).<br>
        ‚Ä¢ C·∫•u h√¨nh ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát (localStorage) ‚Äì kh√¥ng share gi·ªØa c√°c m√°y.
      </div>
    </section>

    <!-- RIGHT: m·ª•c ti√™u + k·∫øt qu·∫£ + t·ªïng quan nhi·ªÅu team -->
    <section>
      <!-- panel m·ª•c ti√™u + k·∫øt qu·∫£ 1 team -->
      <div class="panel">
        <div class="panel-title">
          <span>M·ª•c ti√™u doanh thu &amp; t·ªïng quan team ƒëang ch·ªçn</span>
        </div>

        <div class="targets-row small">
          Nh·∫≠p c√°c m·ªëc doanh thu (VNƒê) mu·ªën m√¥ ph·ªèng cho team ƒëang ch·ªçn.
        </div>

        <div class="target-inputs" id="targetsContainer"></div>

        <div class="note">
          G·ª£i √Ω: c√≥ th·ªÉ nh·∫≠p c√°c m·ªëc nh∆∞ 1 t·ª∑, 1.5 t·ª∑, 2 t·ª∑‚Ä¶ ho·∫∑c theo KPI th·ª±c t·∫ø c·ªßa t·ª´ng team.
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-title">ƒêi·ªÉm h√≤a v·ªën</div>
            <div class="summary-value" id="summaryBreakeven">‚Äì</div>
            <div class="small">Doanh thu c·∫ßn ƒë·ªÉ l√£i = 0.</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">Bi√™n l·ª£i nhu·∫≠n t·∫°i m·ªëc cao nh·∫•t</div>
            <div class="summary-value" id="summaryTopMargin">‚Äì</div>
            <div class="small">T√≠nh tr√™n doanh thu target cao nh·∫•t c·ªßa team ƒëang ch·ªçn.</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">T·ªïng th∆∞·ªüng (team ƒëang ch·ªçn)</div>
            <div class="summary-value" id="summaryTopBonus">‚Äì</div>
            <div class="small">Sale + RD + CSKH + KT+HCNS + Media (m·ªëc cao nh·∫•t, LN &gt; 0).</div>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="small" style="margin-bottom:4px;">
            B·∫£ng chi ti·∫øt theo t·ª´ng m·ªëc doanh thu (team ƒëang ch·ªçn). Vu·ªët ngang tr√™n m√†n h√¨nh nh·ªè ƒë·ªÉ xem ƒë·ªß c·ªôt.
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
              <tr>
                <th>M·ªëc doanh thu</th>
                <th>T·ªïng chi ph√≠</th>
                <th>L·ª£i nhu·∫≠n</th>
                <th>Bi√™n LN (%)</th>
                <th>Th∆∞·ªüng Sale</th>
                <th>Th∆∞·ªüng RD</th>
                <th>Th∆∞·ªüng CSKH</th>
                <th>Th∆∞·ªüng KT+HCNS</th>
                <th>Th∆∞·ªüng Media</th>
                <th>T·ªïng th∆∞·ªüng</th>
                <th>T·ªïng th∆∞·ªüng / LN</th>
              </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="note">
          ‚Ä¢ L·ª£i nhu·∫≠n &amp; th∆∞·ªüng t√≠nh tr√™n t·ª´ng m·ªëc doanh thu ri√™ng l·∫ª, ch∆∞a t√≠nh b·∫≠c thang ph·ª©c t·∫°p.<br>
          ‚Ä¢ Sau n√†y n·∫øu anh mu·ªën m√¥ h√¨nh th∆∞·ªüng ‚Äúv∆∞·ª£t b·∫≠c‚Äù (tier), m√¨nh c√≥ th·ªÉ n√¢ng c·∫•p th√™m.
        </div>
      </div>

      <!-- panel t·ªïng quan nhi·ªÅu team -->
      <div class="panel" id="multiTeamPanel">
        <div class="panel-title">
          <span>T·ªïng quan t·∫•t c·∫£ team (d√πng m·ªëc doanh thu cao nh·∫•t)</span>
          <button class="btn btn-ghost" id="multiTeamToggleBtn" type="button">·∫®n</button>
        </div>

        <div id="multiTeamInner">
          <div class="small" style="margin-bottom:4px;">
            M·ªói team ƒë∆∞·ª£c t√≠nh t·∫°i <b>m·ªëc doanh thu cao nh·∫•t</b> trong danh s√°ch target hi·ªán t·∫°i.
            D√≤ng cu·ªëi c√πng l√† <b>t·ªïng doanh thu</b> &amp; <b>t·ªïng th∆∞·ªüng</b> t·∫•t c·∫£ team.
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
              <tr>
                <th>Team</th>
                <th>Doanh thu k·∫ø ho·∫°ch</th>
                <th>L·ª£i nhu·∫≠n</th>
                <th>Th∆∞·ªüng Sale</th>
                <th>Th∆∞·ªüng RD</th>
                <th>Th∆∞·ªüng CSKH</th>
                <th>Th∆∞·ªüng KT+HCNS</th>
                <th>Th∆∞·ªüng Media</th>
                <th>T·ªïng th∆∞·ªüng</th>
              </tr>
              </thead>
              <tbody id="allTeamsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="footer-cta">
        X√¢y d·ª±ng b·ªüi L·ªó V≈© ‚Äì ƒë·ªçc th√™m chia s·∫ª v·ªÅ TMƒêT t·∫°i
        <a href="https://nguoibanlo.vn" target="_blank" rel="noopener noreferrer">nguoibanlo.vn</a>
      </div>
    </section>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const STORAGE_KEY = 'plan_thuong_teams_v2';

    const DEFAULT_TEAMS = {
      facebook: {
        id: 'facebook',
        name: 'Facebook',
        fixedCost: 300000000,
        cogsRate: 60,
        sellRate: 14,
        otherRate: 6,
        saleBonusRate: 27,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1
      },
      tiktok: {
        id: 'tiktok',
        name: 'TikTok',
        fixedCost: 250000000,
        cogsRate: 58,
        sellRate: 16,
        otherRate: 8,
        saleBonusRate: 27,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1
      },
      shopee: {
        id: 'shopee',
        name: 'Shopee',
        fixedCost: 200000000,
        cogsRate: 60,
        sellRate: 15,
        otherRate: 10,
        saleBonusRate: 7,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1
      },
      web: {
        id: 'web',
        name: 'Web',
        fixedCost: 150000000,
        cogsRate: 55,
        sellRate: 10,
        otherRate: 5,
        saleBonusRate: 25,
        rdBonusRate: 4,
        cskhBonusRate: 1,
        hcnsBonusRate: 1.2,
        mediaBonusRate: 1
      }
    };

    const DEFAULT_TARGETS = [
      500000000, 800000000, 1000000000,
      1500000000, 2000000000, 2500000000
    ];

    let teams = {};
    let currentTeamId = 'facebook';
    let targets = [...DEFAULT_TARGETS];

    // DOM refs
    const teamSelect = document.getElementById('teamSelect');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const teamNameInput = document.getElementById('teamNameInput');
    const fixedCostInput = document.getElementById('fixedCostInput');
    const cogsRateInput = document.getElementById('cogsRateInput');
    const sellRateInput = document.getElementById('sellRateInput');
    const otherRateInput = document.getElementById('otherRateInput');
    const totalVarRateDisplay = document.getElementById('totalVarRateDisplay');
    const saleBonusRateInput = document.getElementById('saleBonusRateInput');
    const rdBonusRateInput = document.getElementById('rdBonusRateInput');
    const cskhBonusRateInput = document.getElementById('cskhBonusRateInput');
    const hcnsBonusRateInput = document.getElementById('hcnsBonusRateInput');
    const mediaBonusRateInput = document.getElementById('mediaBonusRateInput');
    const breakevenDisplay = document.getElementById('breakevenDisplay');

    const saveTeamBtn = document.getElementById('saveTeamBtn');
    const resetTeamBtn = document.getElementById('resetTeamBtn');

    const targetsContainer = document.getElementById('targetsContainer');
    const resultsBody = document.getElementById('resultsBody');

    const summaryBreakeven = document.getElementById('summaryBreakeven');
    const summaryTopMargin = document.getElementById('summaryTopMargin');
    const summaryTopBonus = document.getElementById('summaryTopBonus');

    const allTeamsBody = document.getElementById('allTeamsBody');
    const multiTeamToggleBtn = document.getElementById('multiTeamToggleBtn');
    const multiTeamInner = document.getElementById('multiTeamInner');

    function formatMoney(value) {
      if (!isFinite(value)) return '‚Äì';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
    }

    function formatPercent(value) {
      if (!isFinite(value)) return '‚Äì';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + '%';
    }

    function parseMoney(str) {
      const digits = String(str || '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }

    function normalizeMoneyInput(el) {
      if (!el) return 0;
      const num = parseMoney(el.value);
      if (num === 0) {
        el.value = '';
        return 0;
      }
      el.value = num.toLocaleString('vi-VN');
      return num;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          teams = { ...DEFAULT_TEAMS };
          targets = [...DEFAULT_TARGETS];
          return;
        }
        const data = JSON.parse(raw);
        teams = data.teams || { ...DEFAULT_TEAMS };
        targets = Array.isArray(data.targets) && data.targets.length ? data.targets : [...DEFAULT_TARGETS];
        currentTeamId = data.currentTeamId || 'facebook';
        if (!teams[currentTeamId]) {
          currentTeamId = Object.keys(teams)[0] || 'facebook';
        }
      } catch (e) {
        teams = { ...DEFAULT_TEAMS };
        targets = [...DEFAULT_TARGETS];
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          teams,
          targets,
          currentTeamId
        }));
      } catch (e) {}
    }

    function renderTeamOptions() {
      teamSelect.innerHTML = '';
      Object.values(teams).forEach(team => {
        const opt = document.createElement('option');
        opt.value = team.id;
        opt.textContent = team.name;
        teamSelect.appendChild(opt);
      });
      if (teams[currentTeamId]) {
        teamSelect.value = currentTeamId;
      }
    }

    function renderTargetsInputs() {
      targetsContainer.innerHTML = '';
      targets.forEach((value, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'target-field';

        const label = document.createElement('div');
        label.className = 'target-label';
        label.textContent = `M·ªëc ${index + 1}`;

        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'numeric';
        input.value = value ? value.toLocaleString('vi-VN') : '';
        input.dataset.index = String(index);

        input.addEventListener('input', () => {
          const num = normalizeMoneyInput(input);
          targets[index] = num;
          saveState();
          recalc();
        });

        wrapper.appendChild(label);
        wrapper.appendChild(input);
        targetsContainer.appendChild(wrapper);
      });

      if (targets.length < 10) {
        const addWrapper = document.createElement('div');
        addWrapper.className = 'target-field';
        const label = document.createElement('div');
        label.className = 'target-label';
        label.textContent = 'Th√™m m·ªëc m·ªõi';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-ghost';
        btn.style.width = '100%';
        btn.textContent = '+ Th√™m m·ªëc doanh thu';
        btn.addEventListener('click', () => {
          targets.push(0);
          saveState();
          renderTargetsInputs();
          recalc();
        });
        addWrapper.appendChild(label);
        addWrapper.appendChild(btn);
        targetsContainer.appendChild(addWrapper);
      }
    }

    function calcBreakeven(team) {
      const varRate = ((team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0)) / 100;
      const fixed = team.fixedCost || 0;
      const denom = 1 - varRate;
      if (denom <= 0) return NaN;
      return fixed / denom;
    }

    function renderCurrentTeamConfig() {
      const team = teams[currentTeamId];
      if (!team) return;
      teamNameInput.value = team.name || '';
      fixedCostInput.value = team.fixedCost ? team.fixedCost.toLocaleString('vi-VN') : '';
      cogsRateInput.value = team.cogsRate != null ? team.cogsRate : '';
      sellRateInput.value = team.sellRate != null ? team.sellRate : '';
      otherRateInput.value = team.otherRate != null ? team.otherRate : '';
      saleBonusRateInput.value = team.saleBonusRate != null ? team.saleBonusRate : '';
      rdBonusRateInput.value = team.rdBonusRate != null ? team.rdBonusRate : '';
      cskhBonusRateInput.value = team.cskhBonusRate != null ? team.cskhBonusRate : '';
      hcnsBonusRateInput.value = team.hcnsBonusRate != null ? team.hcnsBonusRate : '';
      mediaBonusRateInput.value = team.mediaBonusRate != null ? team.mediaBonusRate : '';

      const totalVar = (team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0);
      totalVarRateDisplay.value = formatPercent(totalVar);

      const breakeven = calcBreakeven(team);
      breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
      summaryBreakeven.textContent = breakeven > 0 ? formatMoney(breakeven) : '‚Äì';
    }

    function applyProfitStyleCell(td, profit, revenue) {
      td.classList.remove('pl-pos', 'pl-low', 'pl-neg');
      const base = revenue || 0;
      let margin = 0;
      if (base > 0) margin = profit / base;

      if (profit < 0) {
        td.classList.add('pl-neg');
      } else if (profit === 0 || margin < 0.03) {
        td.classList.add('pl-low');
      } else {
        td.classList.add('pl-pos');
      }

      td.textContent = formatMoney(profit);
    }

    function recalcCurrentTeam() {
      const team = teams[currentTeamId];
      if (!team) return;

      const fixedCost = normalizeMoneyInput(fixedCostInput);
      const cogsRate = parseFloat(cogsRateInput.value || '0');
      const sellRate = parseFloat(sellRateInput.value || '0');
      const otherRate = parseFloat(otherRateInput.value || '0');
      const saleBonusRate = parseFloat(saleBonusRateInput.value || '0');
      const rdBonusRate = parseFloat(rdBonusRateInput.value || '0');
      const cskhBonusRate = parseFloat(cskhBonusRateInput.value || '0');
      const hcnsBonusRate = parseFloat(hcnsBonusRateInput.value || '0');
      const mediaBonusRate = parseFloat(mediaBonusRateInput.value || '0');

      const totalVarRate = cogsRate + sellRate + otherRate;
      totalVarRateDisplay.value = formatPercent(totalVarRate);

      const varRateDecimal = totalVarRate / 100;
      const denom = 1 - varRateDecimal;
      const fixed = fixedCost;

      const breakeven = denom > 0 ? fixed / denom : NaN;
      breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
      summaryBreakeven.textContent = breakeven > 0 ? formatMoney(breakeven) : '‚Äì';

      resultsBody.innerHTML = '';

      let topRevenue = 0;
      let topProfit = 0;
      let topSaleBonus = 0;
      let topRdBonus = 0;
      let topCskhBonus = 0;
      let topHcnsBonus = 0;
      let topMediaBonus = 0;

      targets.forEach(revenue => {
        if (!revenue || revenue <= 0) return;

        const totalCost = revenue * varRateDecimal + fixed;
        const profit = revenue - totalCost;
        const margin = revenue > 0 ? profit / revenue * 100 : 0;

        const saleBonus = profit > 0 ? profit * (saleBonusRate / 100) : 0;
        const rdBonus = profit > 0 ? profit * (rdBonusRate / 100) : 0;
        const cskhBonus = profit > 0 ? profit * (cskhBonusRate / 100) : 0;
        const hcnsBonus = profit > 0 ? profit * (hcnsBonusRate / 100) : 0;
        const mediaBonus = profit > 0 ? profit * (mediaBonusRate / 100) : 0;

        const totalBonus = saleBonus + rdBonus + cskhBonus + hcnsBonus + mediaBonus;
        const bonusOnProfit = profit > 0 ? totalBonus / profit * 100 : 0;

        if (revenue > topRevenue) {
          topRevenue = revenue;
          topProfit = profit;
          topSaleBonus = saleBonus;
          topRdBonus = rdBonus;
          topCskhBonus = cskhBonus;
          topHcnsBonus = hcnsBonus;
          topMediaBonus = mediaBonus;
        }

        const tr = document.createElement('tr');

        const tdRev = document.createElement('td');
        tdRev.textContent = formatMoney(revenue);

        const tdCost = document.createElement('td');
        tdCost.textContent = formatMoney(totalCost);

        const tdProfit = document.createElement('td');
        tdProfit.className = 'pl-cell';
        applyProfitStyleCell(tdProfit, profit, revenue);

        const tdMargin = document.createElement('td');
        tdMargin.textContent = formatPercent(margin);

        const tdSaleBonus = document.createElement('td');
        tdSaleBonus.textContent = saleBonus > 0 ? formatMoney(saleBonus) : '‚Äì';

        const tdRdBonus = document.createElement('td');
        tdRdBonus.textContent = rdBonus > 0 ? formatMoney(rdBonus) : '‚Äì';

        const tdCskhBonus = document.createElement('td');
        tdCskhBonus.textContent = cskhBonus > 0 ? formatMoney(cskhBonus) : '‚Äì';

        const tdHcnsBonus = document.createElement('td');
        tdHcnsBonus.textContent = hcnsBonus > 0 ? formatMoney(hcnsBonus) : '‚Äì';

        const tdMediaBonus = document.createElement('td');
        tdMediaBonus.textContent = mediaBonus > 0 ? formatMoney(mediaBonus) : '‚Äì';

        const tdTotalBonus = document.createElement('td');
        tdTotalBonus.textContent = totalBonus > 0 ? formatMoney(totalBonus) : '‚Äì';

        const tdRatio = document.createElement('td');
        tdRatio.textContent = totalBonus > 0 && profit > 0
          ? formatPercent(bonusOnProfit)
          : '‚Äì';

        tr.appendChild(tdRev);
        tr.appendChild(tdCost);
        tr.appendChild(tdProfit);
        tr.appendChild(tdMargin);
        tr.appendChild(tdSaleBonus);
        tr.appendChild(tdRdBonus);
        tr.appendChild(tdCskhBonus);
        tr.appendChild(tdHcnsBonus);
        tr.appendChild(tdMediaBonus);
        tr.appendChild(tdTotalBonus);
        tr.appendChild(tdRatio);

        resultsBody.appendChild(tr);
      });

      if (topRevenue > 0) {
        const topMargin = topRevenue > 0 ? topProfit / topRevenue * 100 : 0;
        summaryTopMargin.textContent = formatPercent(topMargin);
        const totalTopBonus = topSaleBonus + topRdBonus + topCskhBonus + topHcnsBonus + topMediaBonus;
        summaryTopBonus.textContent = totalTopBonus > 0 ? formatMoney(totalTopBonus) : '‚Äì';
      } else {
        summaryTopMargin.textContent = '‚Äì';
        summaryTopBonus.textContent = '‚Äì';
      }
    }

    // T·ªïng quan t·∫•t c·∫£ team: d√πng m·ªëc doanh thu cao nh·∫•t
    function recalcAllTeamsSummary() {
      if (!allTeamsBody) return;
      allTeamsBody.innerHTML = '';

      const validTargets = targets.filter(t => t > 0);
      if (!validTargets.length) return;
      const revenuePlan = Math.max(...validTargets); // m·ªëc cao nh·∫•t

      let sumRevenue = 0;
      let sumSaleBonus = 0;
      let sumRdBonus = 0;
      let sumCskhBonus = 0;
      let sumHcnsBonus = 0;
      let sumMediaBonus = 0;
      let sumProfit = 0;

      Object.values(teams).forEach(team => {
        const varRateDecimal = ((team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0)) / 100;
        const fixed = team.fixedCost || 0;

        const totalCost = revenuePlan * varRateDecimal + fixed;
        const profit = revenuePlan - totalCost;

        const saleBonusRate = team.saleBonusRate || 0;
        const rdBonusRate = team.rdBonusRate || 0;
        const cskhBonusRate = team.cskhBonusRate || 0;
        const hcnsBonusRate = team.hcnsBonusRate || 0;
        const mediaBonusRate = team.mediaBonusRate || 0;

        const saleBonus = profit > 0 ? profit * (saleBonusRate / 100) : 0;
        const rdBonus = profit > 0 ? profit * (rdBonusRate / 100) : 0;
        const cskhBonus = profit > 0 ? profit * (cskhBonusRate / 100) : 0;
        const hcnsBonus = profit > 0 ? profit * (hcnsBonusRate / 100) : 0;
        const mediaBonus = profit > 0 ? profit * (mediaBonusRate / 100) : 0;

        const totalBonus = saleBonus + rdBonus + cskhBonus + hcnsBonus + mediaBonus;

        sumRevenue += revenuePlan;
        sumProfit += profit;
        sumSaleBonus += saleBonus;
        sumRdBonus += rdBonus;
        sumCskhBonus += cskhBonus;
        sumHcnsBonus += hcnsBonus;
        sumMediaBonus += mediaBonus;

        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = team.name || team.id;
        tdName.style.textAlign = 'left';

        const tdRev = document.createElement('td');
        tdRev.textContent = formatMoney(revenuePlan);

        const tdProfit = document.createElement('td');
        tdProfit.textContent = formatMoney(profit);

        const tdSale = document.createElement('td');
        tdSale.textContent = saleBonus > 0 ? formatMoney(saleBonus) : '‚Äì';

        const tdRd = document.createElement('td');
        tdRd.textContent = rdBonus > 0 ? formatMoney(rdBonus) : '‚Äì';

        const tdCskh = document.createElement('td');
        tdCskh.textContent = cskhBonus > 0 ? formatMoney(cskhBonus) : '‚Äì';

        const tdHcns = document.createElement('td');
        tdHcns.textContent = hcnsBonus > 0 ? formatMoney(hcnsBonus) : '‚Äì';

        const tdMedia = document.createElement('td');
        tdMedia.textContent = mediaBonus > 0 ? formatMoney(mediaBonus) : '‚Äì';

        const tdTotalBonus = document.createElement('td');
        tdTotalBonus.textContent = totalBonus > 0 ? formatMoney(totalBonus) : '‚Äì';

        tr.appendChild(tdName);
        tr.appendChild(tdRev);
        tr.appendChild(tdProfit);
        tr.appendChild(tdSale);
        tr.appendChild(tdRd);
        tr.appendChild(tdCskh);
        tr.appendChild(tdHcns);
        tr.appendChild(tdMedia);
        tr.appendChild(tdTotalBonus);

        allTeamsBody.appendChild(tr);
      });

      // d√≤ng t·ªïng
      const trTotal = document.createElement('tr');
      trTotal.style.fontWeight = '600';
      const tdLabel = document.createElement('td');
      tdLabel.textContent = 'T·ªîNG (t·∫•t c·∫£ team)';
      tdLabel.style.textAlign = 'left';

      const tdRevSum = document.createElement('td');
      tdRevSum.textContent = formatMoney(sumRevenue);

      const tdProfitSum = document.createElement('td');
      tdProfitSum.textContent = formatMoney(sumProfit);

      const tdSaleSum = document.createElement('td');
      tdSaleSum.textContent = formatMoney(sumSaleBonus);

      const tdRdSum = document.createElement('td');
      tdRdSum.textContent = formatMoney(sumRdBonus);

      const tdCskhSum = document.createElement('td');
      tdCskhSum.textContent = formatMoney(sumCskhBonus);

      const tdHcnsSum = document.createElement('td');
      tdHcnsSum.textContent = formatMoney(sumHcnsBonus);

      const tdMediaSum = document.createElement('td');
      tdMediaSum.textContent = formatMoney(sumMediaBonus);

      const tdBonusSum = document.createElement('td');
      tdBonusSum.textContent = formatMoney(sumSaleBonus + sumRdBonus + sumCskhBonus + sumHcnsBonus + sumMediaBonus);

      trTotal.appendChild(tdLabel);
      trTotal.appendChild(tdRevSum);
      trTotal.appendChild(tdProfitSum);
      trTotal.appendChild(tdSaleSum);
      trTotal.appendChild(tdRdSum);
      trTotal.appendChild(tdCskhSum);
      trTotal.appendChild(tdHcnsSum);
      trTotal.appendChild(tdMediaSum);
      trTotal.appendChild(tdBonusSum);

      allTeamsBody.appendChild(trTotal);
    }

    function recalc() {
      recalcCurrentTeam();
      recalcAllTeamsSummary();
    }

    // Events
    teamSelect.addEventListener('change', () => {
      currentTeamId = teamSelect.value;
      saveState();
      renderCurrentTeamConfig();
      recalc();
    });

    addTeamBtn.addEventListener('click', () => {
      const id = 'team_' + Date.now();
      teams[id] = {
        id,
        name: 'Team m·ªõi',
        fixedCost: 0,
        cogsRate: 60,
        sellRate: 10,
        otherRate: 5,
        saleBonusRate: 20,
        rdBonusRate: 5,
        cskhBonusRate: 3,
        hcnsBonusRate: 3,
        mediaBonusRate: 2
      };
      currentTeamId = id;
      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    saveTeamBtn.addEventListener('click', () => {
      const team = teams[currentTeamId];
      if (!team) return;
      team.name = teamNameInput.value || team.name;
      team.fixedCost = normalizeMoneyInput(fixedCostInput);
      team.cogsRate = parseFloat(cogsRateInput.value || '0');
      team.sellRate = parseFloat(sellRateInput.value || '0');
      team.otherRate = parseFloat(otherRateInput.value || '0');
      team.saleBonusRate = parseFloat(saleBonusRateInput.value || '0');
      team.rdBonusRate = parseFloat(rdBonusRateInput.value || '0');
      team.cskhBonusRate = parseFloat(cskhBonusRateInput.value || '0');
      team.hcnsBonusRate = parseFloat(hcnsBonusRateInput.value || '0');
      team.mediaBonusRate = parseFloat(mediaBonusRateInput.value || '0');
      teams[currentTeamId] = team;
      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    resetTeamBtn.addEventListener('click', () => {
      const def = DEFAULT_TEAMS[currentTeamId];
      if (def) {
        teams[currentTeamId] = { ...def };
      } else {
        teams[currentTeamId] = {
          id: currentTeamId,
          name: 'Team m·ªõi',
          fixedCost: 0,
          cogsRate: 60,
          sellRate: 10,
          otherRate: 5,
          saleBonusRate: 20,
          rdBonusRate: 5,
          cskhBonusRate: 3,
          hcnsBonusRate: 3,
          mediaBonusRate: 2
        };
      }
      saveState();
      renderTeamOptions();
      renderCurrentTeamConfig();
      recalc();
    });

    [
      fixedCostInput,
      cogsRateInput,
      sellRateInput,
      otherRateInput,
      saleBonusRateInput,
      rdBonusRateInput,
      cskhBonusRateInput,
      hcnsBonusRateInput,
      mediaBonusRateInput
    ].forEach(el => {
      el.addEventListener('input', () => {
        recalc();
      });
    });

    // Toggle ·∫©n/hi·ªán t·ªïng quan t·∫•t c·∫£ team
    multiTeamToggleBtn.addEventListener('click', () => {
      const isHidden = multiTeamInner.style.display === 'none';
      multiTeamInner.style.display = isHidden ? '' : 'none';
      multiTeamToggleBtn.textContent = isHidden ? '·∫®n' : 'Hi·ªán';
    });

    // INIT
    loadState();
    renderTeamOptions();
    renderTargetsInputs();
    renderCurrentTeamConfig();
    recalc();
  });
</script>
</body>
</html>
