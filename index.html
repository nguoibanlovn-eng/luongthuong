<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Doanh thu – Lợi nhuận – Target | thuong.nguoibanlo.vn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f9;
      color: #222;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .chip {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .chip.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn:hover {
      background: #f1f1f5;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-danger {
      border-color: #f97373;
      color: #b91c1c;
      background: #fff0f0;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed #999;
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 16px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 12px;
      color: #666;
    }

    .team-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .team-name-input {
      border: none;
      font-weight: 600;
      font-size: 14px;
      padding: 0;
      background: transparent;
      outline: none;
    }

    .team-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }
    th:first-child, td:first-child {
      text-align: left;
    }

    input[type="number"] {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 12px;
      text-align: right;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #ddd;
    }
    .pill-green {
      color: #166534;
      border-color: #22c55e;
      background: #ecfdf3;
    }
    .pill-red {
      color: #b91c1c;
      border-color: #f97373;
      background: #fef2f2;
    }

    .footer-note {
      margin-top: 24px;
      font-size: 11px;
      color: #777;
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Doanh thu – lợi nhuận – target</h1>
  <div class="subtitle">
    Bảng này giúp Lỗ Vũ & team set target, tính hòa vốn & theo dõi doanh thu – chi phí theo từng kênh.
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Chọn team / kênh áp dụng cho phiên làm việc này</div>
        <div class="card-sub">Dữ liệu sẽ được lưu lại trên trình duyệt (localStorage). Nút “Lưu làm mặc định” sẽ ghi nhớ cấu hình hiện tại cho lần sau.</div>
      </div>
      <div class="badge" id="overallMarginBadge">
        Tổng biên phí: <span id="overallMarginText">&nbsp;–</span>
      </div>
    </div>

    <div class="chip-group" id="teamChipGroup">
      <!-- chips sẽ render bằng JS -->
    </div>

    <div class="toolbar">
      <button class="btn" id="btnRecalc">Cập nhật lại chỉ số</button>
      <button class="btn" id="btnSaveDefault">Lưu làm mặc định</button>
      <button class="btn" id="btnLoadFromSheet">Tải từ Google Sheet</button>
      <button class="btn" id="btnSaveToSheet">Lưu lên Google Sheet</button>
      <button class="btn btn-primary" id="btnAddTeam">+ Thêm team</button>
    </div>
  </div>

  <div id="teamContainer">
    <!-- team cards sẽ render bằng JS -->
  </div>

  <div class="footer-note">
    * Đơn vị số liệu mặc định là <b>triệu</b>. Anh em có thể đổi cách nhập nếu muốn.<br>
    * Tool đang ở phiên bản demo, công thức có thể đơn giản hơn thực tế. Cứ dùng trước, có gì cần chỉnh thêm anh báo lại.
  </div>
</div>

<script>
  /*************************************************
   * 1. CẤU HÌNH CƠ BẢN
   *************************************************/
  // DÁN URL WEB APP APPS SCRIPT VÀO ĐÂY
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxh6hOQL2cD6SUwnRp91OtPPS83h658rEuq3Hg9Cm15OHBAV9_w3HOEuUeS2prtVUNqlA/exec';

  const LOCAL_KEY_CURRENT = 'nbl_tool_config_current_v1';
  const LOCAL_KEY_DEFAULT = 'nbl_tool_config_default_v1';

  // seed mặc định
  const DEFAULT_TEAMS = [
    { name: 'TikTok', key: 'tiktok' },
    { name: 'Shopee', key: 'shopee' },
    { name: 'Website', key: 'website' },
    { name: 'Facebook', key: 'facebook' },
    { name: 'B2B', key: 'b2b' }
  ];

  let state = {
    scenario: 'default',
    teams: []
  };

  /*************************************************
   * 2. HÀM TIỆN ÍCH
   *************************************************/
  function parseNumber(value) {
    if (value === '' || value === null || value === undefined) return 0;
    const clean = String(value).replace(/,/g, '').trim();
    const num = Number(clean);
    return isNaN(num) ? 0 : num;
  }

  function formatNumber(num) {
    if (num === null || num === undefined || isNaN(num)) return '';
    return new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 2 }).format(num);
  }

  function calcTeamMetrics(team) {
    const margin = parseNumber(team.margin);
    const target = parseNumber(team.targetRevenue);
    const actual = parseNumber(team.actualRevenue);

    const targetProfit = target * margin / 100;
    const actualProfit = actual * margin / 100;
    const diffRevenue = actual - target;
    const diffProfit = actualProfit - targetProfit;
    const diffPercent = target > 0 ? (actual / target - 1) * 100 : 0;

    return {
      targetProfit,
      actualProfit,
      diffRevenue,
      diffProfit,
      diffPercent
    };
  }

  function calcOverallMargin() {
    if (!state.teams.length) return null;
    let sumRevenue = 0;
    let sumProfit = 0;
    state.teams.forEach(t => {
      const margin = parseNumber(t.margin);
      const actual = parseNumber(t.actualRevenue);
      sumRevenue += actual;
      sumProfit += actual * margin / 100;
    });
    if (sumRevenue === 0) return null;
    return sumProfit * 100 / sumRevenue;
  }

  /*************************************************
   * 3. RENDER UI
   *************************************************/
  function renderTeamChips() {
    const wrap = document.getElementById('teamChipGroup');
    wrap.innerHTML = '';
    state.teams.forEach((t, idx) => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip' + (idx === 0 ? ' active' : '');
      chip.textContent = t.name || ('Team ' + (idx + 1));
      chip.dataset.index = idx;
      chip.addEventListener('click', () => {
        document.querySelectorAll('#teamChipGroup .chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        // scroll tới card tương ứng
        const card = document.querySelector('.team-card[data-index="' + idx + '"]');
        if (card) {
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
      wrap.appendChild(chip);
    });
  }

  function renderTeams() {
    const container = document.getElementById('teamContainer');
    container.innerHTML = '';

    state.teams.forEach((team, index) => {
      const card = document.createElement('div');
      card.className = 'card team-card';
      card.dataset.index = index;

      const metrics = calcTeamMetrics(team);

      card.innerHTML = `
        <div class="team-row-header">
          <div>
            <input class="team-name-input" value="${team.name || ('Team ' + (index + 1))}" data-field="name" data-index="${index}">
            <div class="team-meta">
              <span>Kênh: ${team.key || ('team_' + (index + 1))}</span>
              <span>| Biên phí: <span id="margin-label-${index}">${formatNumber(team.margin) || 0}</span>%</span>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="pill ${metrics.diffProfit >= 0 ? 'pill-green' : 'pill-red'}">
              Lợi nhuận: ${formatNumber(metrics.actualProfit)} (chênh ${formatNumber(metrics.diffProfit)})
            </span>
            <button class="btn btn-danger" data-action="remove-team" data-index="${index}">Xóa</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th></th>
              <th>Target</th>
              <th>Thực tế</th>
              <th>Chênh lệch</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Doanh thu (triệu)</td>
              <td>
                <input type="number" step="0.01"
                       data-field="targetRevenue"
                       data-index="${index}"
                       value="${team.targetRevenue !== undefined ? team.targetRevenue : ''}">
              </td>
              <td>
                <input type="number" step="0.01"
                       data-field="actualRevenue"
                       data-index="${index}"
                       value="${team.actualRevenue !== undefined ? team.actualRevenue : ''}">
              </td>
              <td>
                <span id="diff-revenue-${index}">
                  ${formatNumber(metrics.diffRevenue)}
                  (${formatNumber(metrics.diffPercent)}%)
                </span>
              </td>
            </tr>
            <tr>
              <td>Biên phí gộp (%)</td>
              <td colspan="2">
                <input type="number" step="0.1"
                       data-field="margin"
                       data-index="${index}"
                       value="${team.margin !== undefined ? team.margin : ''}">
              </td>
              <td>
                <span id="profit-summary-${index}">
                  LN target: ${formatNumber(metrics.targetProfit)} | LN thực: ${formatNumber(metrics.actualProfit)}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      `;

      container.appendChild(card);
    });

    attachTeamEventHandlers();
    updateOverallMarginBadge();
  }

  function updateOverallMarginBadge() {
    const badgeText = document.getElementById('overallMarginText');
    const margin = calcOverallMargin();
    if (margin === null) {
      badgeText.textContent = '–';
    } else {
      badgeText.textContent = formatNumber(margin) + ' %';
    }
  }

  function attachTeamEventHandlers() {
    // inputs
    document.querySelectorAll('input[data-field]').forEach(input => {
      input.addEventListener('input', () => {
        const field = input.dataset.field;
        const idx = Number(input.dataset.index);
        const val = input.value;
        const team = state.teams[idx];
        if (!team) return;

        if (field === 'name') {
          team.name = val;
        } else if (field === 'margin') {
          team.margin = parseNumber(val);
          const label = document.getElementById('margin-label-' + idx);
          if (label) label.textContent = formatNumber(team.margin || 0);
        } else if (field === 'targetRevenue') {
          team.targetRevenue = parseNumber(val);
        } else if (field === 'actualRevenue') {
          team.actualRevenue = parseNumber(val);
        }

        recalcTeamRow(idx);
        saveCurrentToLocal();
      });
    });

    // rename team input
    document.querySelectorAll('.team-name-input').forEach(input => {
      input.addEventListener('input', () => {
        const idx = Number(input.dataset.index);
        const team = state.teams[idx];
        if (!team) return;
        team.name = input.value;
        const chip = document.querySelector(`#teamChipGroup .chip[data-index="${idx}"]`);
        if (chip) chip.textContent = team.name || ('Team ' + (idx + 1));
        saveCurrentToLocal();
      });
    });

    // remove buttons
    document.querySelectorAll('[data-action="remove-team"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.index);
        if (!confirm('Xóa team này?')) return;
        state.teams.splice(idx, 1);
        saveCurrentToLocal();
        renderTeamChips();
        renderTeams();
      });
    });
  }

  function recalcTeamRow(index) {
    const team = state.teams[index];
    if (!team) return;
    const metrics = calcTeamMetrics(team);

    const diffEl = document.getElementById('diff-revenue-' + index);
    if (diffEl) {
      diffEl.textContent = `${formatNumber(metrics.diffRevenue)} (${formatNumber(metrics.diffPercent)}%)`;
    }
    const pEl = document.getElementById('profit-summary-' + index);
    if (pEl) {
      pEl.textContent = `LN target: ${formatNumber(metrics.targetProfit)} | LN thực: ${formatNumber(metrics.actualProfit)}`;
    }

    const card = document.querySelector(`.team-card[data-index="${index}"] .pill`);
    if (card) {
      card.className = 'pill ' + (metrics.diffProfit >= 0 ? 'pill-green' : 'pill-red');
      card.textContent = `Lợi nhuận: ${formatNumber(metrics.actualProfit)} (chênh ${formatNumber(metrics.diffProfit)})`;
    }

    updateOverallMarginBadge();
  }

  /*************************************************
   * 4. LOCALSTORAGE
   *************************************************/
  function saveCurrentToLocal() {
    const data = JSON.stringify(state);
    localStorage.setItem(LOCAL_KEY_CURRENT, data);
  }

  function saveDefaultToLocal() {
    const data = JSON.stringify(state);
    localStorage.setItem(LOCAL_KEY_DEFAULT, data);
    alert('Đã lưu cấu hình hiện tại làm mặc định.');
  }

  function loadFromLocal() {
    const raw = localStorage.getItem(LOCAL_KEY_CURRENT);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (err) {
      console.error('Parse local current error:', err);
      return null;
    }
  }

  function loadDefaultFromLocal() {
    const raw = localStorage.getItem(LOCAL_KEY_DEFAULT);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (err) {
      console.error('Parse local default error:', err);
      return null;
    }
  }

  /*************************************************
   * 5. GOOGLE SHEET – LOAD & SAVE
   *************************************************/
  async function loadScenarioFromGoogleSheet(scenarioName = 'default') {
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.indexOf('http') !== 0) {
      alert('GOOGLE_SCRIPT_URL chưa được cấu hình đúng trong file index.html');
      return;
    }
    try {
      const url = GOOGLE_SCRIPT_URL +
        '?action=get&scenario=' + encodeURIComponent(scenarioName);

      const res = await fetch(url, { method: 'GET' });

      if (!res.ok) {
        const text = await res.text();
        alert('Không tải được từ Google Sheet: ' + res.status + ' - ' + text);
        return;
      }

      const data = await res.json();
      if (!data.ok) {
        alert('Không tải được từ Google Sheet: ' + (data.error || 'Unknown error'));
        return;
      }

      if (data.data) {
        // data.data chính là object state đã lưu
        state = data.data;
      } else {
        // nếu chưa có gì trên sheet → giữ state hiện tại
      }

      renderTeamChips();
      renderTeams();
      saveCurrentToLocal();

      alert('Đã tải cấu hình từ Google Sheet (scenario: ' + (data.scenario || 'default') + ').');
    } catch (err) {
      console.error('Load from sheet error:', err);
      alert('Không tải được từ Google Sheet: ' + err.message);
    }
  }

  async function saveScenarioToGoogleSheet(scenarioName = 'default') {
    if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.indexOf('http') !== 0) {
      alert('GOOGLE_SCRIPT_URL chưa được cấu hình đúng trong file index.html');
      return;
    }
    try {
      const body = new URLSearchParams();
      body.append('action', 'save');
      body.append('scenario', scenarioName);
      body.append('payload', JSON.stringify(state));

      const res = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body
      });

      if (!res.ok) {
        const text = await res.text();
        alert('Không lưu được lên Google Sheet: ' + res.status + ' - ' + text);
        return;
      }

      const data = await res.json();
      if (!data.ok) {
        alert('Không lưu được lên Google Sheet: ' + (data.error || 'Unknown error'));
        return;
      }

      alert('Đã lưu cấu hình lên Google Sheet (scenario: ' + (data.scenario || 'default') + ').');
    } catch (err) {
      console.error('Save to sheet error:', err);
      alert('Không lưu được lên Google Sheet: ' + err.message);
    }
  }

  /*************************************************
   * 6. KHỞI TẠO & SỰ KIỆN
   *************************************************/
  function initDefaultStateIfNeeded() {
    const fromLocal = loadFromLocal();
    if (fromLocal && fromLocal.teams && Array.isArray(fromLocal.teams) && fromLocal.teams.length) {
      state = fromLocal;
      return;
    }

    const fromDefault = loadDefaultFromLocal();
    if (fromDefault && fromDefault.teams && Array.isArray(fromDefault.teams) && fromDefault.teams.length) {
      state = fromDefault;
      return;
    }

    // nếu chưa có gì → seed mặc định
    state.teams = DEFAULT_TEAMS.map(t => ({
      name: t.name,
      key: t.key,
      margin: 20,
      targetRevenue: 0,
      actualRevenue: 0
    }));
  }

  function initButtons() {
    document.getElementById('btnRecalc').addEventListener('click', () => {
      state.teams.forEach((_, idx) => recalcTeamRow(idx));
      saveCurrentToLocal();
      alert('Đã cập nhật lại chỉ số.');
    });

    document.getElementById('btnSaveDefault').addEventListener('click', () => {
      saveDefaultToLocal();
    });

    document.getElementById('btnAddTeam').addEventListener('click', () => {
      const newTeam = {
        name: 'Team mới ' + (state.teams.length + 1),
        key: 'team_' + (state.teams.length + 1),
        margin: 20,
        targetRevenue: 0,
        actualRevenue: 0
      };
      state.teams.push(newTeam);
      saveCurrentToLocal();
      renderTeamChips();
      renderTeams();
    });

    document.getElementById('btnLoadFromSheet').addEventListener('click', () => {
      loadScenarioFromGoogleSheet('default');
    });

    document.getElementById('btnSaveToSheet').addEventListener('click', () => {
      saveScenarioToGoogleSheet('default');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initDefaultStateIfNeeded();
    renderTeamChips();
    renderTeams();
    initButtons();
  });
</script>

</body>
</html>
