<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu – lợi nhuận – thưởng theo team | Lỗ Vũ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      padding: 16px;
      max-width: 1100px;
      margin-inline: auto;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 14px;
    }
    h1 { font-size: 22px; margin-bottom: 6px; }
    h2 { margin-top: 20px; font-size: 18px; }
    p  { margin: 2px 0 6px; }
    .muted { opacity: 0.7; font-size: 12px; }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 6px 0 10px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid rgba(128,128,128,0.5);
      padding: 6px 12px;
      background: transparent;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    button.primary { background: #2563eb; border-color: #2563eb; color: #fff; }
    button.danger  { border-color: #dc2626; color: #dc2626; }
    button.small   { padding: 4px 8px; font-size: 11px; }

    .chip-button {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(128,128,128,0.06);
    }
    .chip-button.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(128,128,128,0.5);
      font-size: 13px;
      background: transparent;
      height: 32px;
    }
    input:focus {
      outline: 2px solid #2563eb55;
      border-color: #2563eb;
    }

    .team-name {
      max-width: 170px;
      font-weight: 600;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .col-2  { grid-column: span 2; }
    .col-3  { grid-column: span 3; }
    .col-4  { grid-column: span 4; }
    .col-6  { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    @media (max-width: 768px) {
      .col-2, .col-3, .col-4, .col-6 { grid-column: span 12; }
    }

    .card {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 10px;
      margin-bottom: 14px;
      background: rgba(255,255,255,0.02);
    }
    .card.team-0 { border-left: 4px solid #3b82f6; background: rgba(59,130,246,0.02); }
    .card.team-1 { border-left: 4px solid #22c55e; background: rgba(34,197,94,0.02); }
    .card.team-2 { border-left: 4px solid #f97316; background: rgba(249,115,22,0.02); }
    .card.team-3 { border-left: 4px solid #a855f7; background: rgba(168,85,247,0.02); }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(148,163,184,0.15);
      font-weight: 600;
    }

    .pill-input {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.9);
      background: rgba(249,250,251,0.9);
    }
    .pill-input span  { opacity: 0.7; }
    .pill-input strong{ font-variant-numeric: tabular-nums; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 12px;
      table-layout: fixed;
    }
    th, td {
      padding: 3px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.6);
      text-align: right;
      font-variant-numeric: tabular-nums;
      vertical-align: middle;
    }
    th:first-child,
    td:first-child {
      text-align: left;
    }
    th { font-weight: 600; background: rgba(148,163,184,0.25); }
    tbody tr:nth-child(even) { background: rgba(148,163,184,0.08); }
    tfoot td { font-weight: 600; background: rgba(37,99,235,0.06); }
    .row-total  { background: rgba(59,130,246,0.08) !important; }
    .row-profit { background: rgba(16,185,129,0.08) !important; }

    .muted-percent {
      display: inline-block;
      margin-left: 4px;
      font-size: 10px;
      opacity: 0.7;
    }

    .positive { color: #16a34a; }
    .negative { color: #dc2626; }

    .table-input {
      height: 22px;
      padding: 1px 4px;
      font-size: 12px;
      text-align: right;
      border-radius: 6px;
      background: transparent;
    }

    .section-divider {
      margin: 14px 0 8px;
      border-top: 1px dashed rgba(148,163,184,0.9);
    }

    .mini-compare {
      margin-top: 2px;
      font-size: 11px;
      table-layout: auto;
    }
    .mini-compare th,
    .mini-compare td {
      padding: 1px 4px;
    }
    .mini-compare .table-input {
      height: 20px;
      font-size: 11px;
      padding: 1px 4px;
      max-width: 110px;
    }

    .bonus-input {
      width: 70px !important;
      max-width: 100%;
      height: 22px !important;
      font-size: 12px;
      text-align: right;
      padding: 2px 4px;
    }
    .bonus-field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .bonus-label {
      font-size: 13px;
      font-weight: 500;
    }

    .blog-promo {
      margin-top: 20px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(37,99,235,0.4);
      background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(59,130,246,0.02));
    }
    .blog-promo-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .blog-promo-link {
      display: inline-block;
      margin-bottom: 4px;
      font-weight: 600;
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.7);
    }
    .blog-promo-link:hover {
      background: rgba(37,99,235,0.12);
    }
    .blog-promo-sub {
      font-size: 12px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>Plan doanh thu – lợi nhuận – thưởng theo team</h1>
  <p class="muted">
    Công cụ nội bộ giúp Lỗ Vũ &amp; team set target, tính hòa vốn, chia thưởng theo từng team
    (Sale, RD, CSKH, KT+HCNS, Media). Đơn vị doanh thu &amp; chi phí có thể dùng theo triệu cho dễ nhìn.
  </p>

  <div class="section-divider"></div>

  <!-- CẤU HÌNH TEAM -->
  <h2>Cấu hình team <span class="muted">Áp dụng trong phiên làm việc này</span></h2>
  <div class="toolbar">
    <div>
      <span class="muted">Chọn team nhanh:</span>
      <button class="chip-button" data-name="TikTok"   onclick="focusTeam('TikTok')">TikTok</button>
      <button class="chip-button" data-name="Shopee"   onclick="focusTeam('Shopee')">Shopee</button>
      <button class="chip-button" data-name="Website"  onclick="focusTeam('Website')">Website</button>
      <button class="chip-button" data-name="Facebook" onclick="focusTeam('Facebook')">Facebook</button>
      <button class="chip-button" data-name="B2B"      onclick="focusTeam('B2B')">B2B</button>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <button class="small" onclick="resetToDefaults()">Cập nhật lại chỉ số</button>
      <button class="small" onclick="saveDefaultsFromCurrent()">Lưu làm mặc định</button>
      <button class="small" onclick="loadFromServer()">Tải từ Google Sheet</button>
      <button class="small" onclick="saveToServer()">Lưu lên Google Sheet</button>
      <button class="primary" onclick="addTeam()">+ Thêm team</button>
    </div>
  </div>
  <p class="muted">
    • Thay đổi được lưu lại trên trình duyệt của anh (localStorage).<br />
    • “Lưu làm mặc định” sẽ ghi nhớ cấu hình hiện tại để lần reset sau dùng lại.
  </p>

  <div id="teamsContainer"></div>

  <div class="section-divider"></div>

  <!-- TỔNG QUAN DOANH THU -->
  <h2>Tổng quan doanh thu &amp; thưởng các team</h2>
  <p class="muted">
    Mỗi team dùng 3 mốc doanh thu: <b>Mốc 1</b>, <b>Mốc 2</b>, <b>Mốc 3 (thực tế)</b>. Mốc 3 dùng để
    tính tổng doanh thu &amp; tổng thưởng toàn doanh nghiệp.
  </p>

  <h2 style="margin-top: 18px;">Tổng quan tất cả team (Mốc 3 – thực tế)</h2>
  <div id="summaryContainer"></div>

  <!-- PROMO -->
  <div class="blog-promo">
    <div class="blog-promo-title">Đọc thêm các bài viết &amp; case thực chiến tại trang chủ:</div>
    <a href="https://nguoibanlo.vn" target="_blank" rel="noreferrer" class="blog-promo-link">
      nguoibanlo.vn
    </a>
    <div class="blog-promo-sub">
      Chia sẻ về TMĐT, xây kênh, chia thưởng, tối ưu P&amp;L cho SME Việt – phong cách Lỗ Vũ.
    </div>
  </div>

<script>
  // ===== API Google Apps Script =====
  // Nếu anh deploy Apps Script URL khác thì thay chuỗi này.
  const API_URL = 'https://script.google.com/macros/s/AKfycbxKpVKBQeDjAeGYLiO4LtwrRVsjMf8raLw7S28p8a3viydqG7c6qNViYfiuN-zwCVFr3A/exec';
  const SCENARIO_ID = 'default';

  // ===== Storage keys =====
  const STORAGE_KEY_STATE    = 'thuong_tool_state_v1';
  const STORAGE_KEY_DEFAULTS = 'thuong_tool_defaults_v1';

  // ===== LocalStorage helpers =====
  const loadJSON = (key) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      console.warn('Không đọc được', key, e);
      return null;
    }
  };

  const saveJSON = (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.warn('Không lưu được', key, e);
    }
  };

  // ===== Format helpers =====
  const formatCurrency = (n) => {
    if (isNaN(n)) return '-';
    return Number(n).toLocaleString('vi-VN', { maximumFractionDigits: 0 });
  };

  const formatPercent = (n) => {
    if (isNaN(n)) return '-';
    return Number(n).toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + ' %';
  };

  const formatMoneyInput = (n) => {
    if (n === null || n === undefined || n === '' || isNaN(n)) return '';
    return Number(n).toLocaleString('vi-VN');
  };

  const parseMoneyInput = (str) => {
    if (str === null || str === undefined) return 0;
    const cleaned = String(str).replace(/[^\d-]/g, '');
    const num = Number(cleaned);
    return isNaN(num) ? 0 : num;
  };

  const cellValPct = (val, revenue) => {
    if (isNaN(val)) return '-';
    const base = formatCurrency(val);
    if (!revenue || isNaN(revenue) || revenue === 0) return base;
    const pct = (val / revenue) * 100;
    return `${base}<span class="muted-percent">(${pct.toFixed(1)}%)</span>`;
  };

  // ===== Default config per channel =====
  const DEFAULT_TEAMS = {
    Facebook: {
      fixedCost: 320,
      cogs: 60, selling: 15, other: 5,
      bonusSale: 27, bonusRD: 4, bonusCSKH: 1, bonusKT: 1.2, bonusMedia: 1,
      revenue1: 1250, revenue2: 2309, revenue3: 2800,
    },
    TikTok: {
      fixedCost: 320,
      cogs: 51, selling: 30, other: 5,
      bonusSale: 27, bonusRD: 4, bonusCSKH: 1, bonusKT: 1.2, bonusMedia: 1,
      revenue1: 1800, revenue2: 1862, revenue3: 2800,
    },
    Shopee: {
      fixedCost: 120,
      cogs: 53, selling: 30, other: 5,
      bonusSale: 7, bonusRD: 4, bonusCSKH: 1, bonusKT: 1.2, bonusMedia: 1,
      revenue1: 800, revenue2: 1030, revenue3: 1200,
    },
    Website: {
      fixedCost: 75,
      cogs: 60, selling: 15, other: 5,
      bonusSale: 25, bonusRD: 4, bonusCSKH: 1, bonusKT: 1.2, bonusMedia: 1,
      revenue1: 245, revenue2: 245, revenue3: 320,
    },
    B2B: {
      fixedCost: 75,
      cogs: 60, selling: 15, other: 5,
      bonusSale: 20, // Sale B2B ăn 20% LNR
      bonusRD: 4, bonusCSKH: 1, bonusKT: 1.2, bonusMedia: 1,
      revenue1: 245, revenue2: 245, revenue3: 320,
    },
  };

  // ===== Team factory =====
  const createDefaultTeam = (name) => {
    const baseName = name || 'Team mới';
    const d = DEFAULT_TEAMS[baseName] || {};
    const fixedCost = d.fixedCost ?? 100;
    const cogs      = d.cogs ?? 60;
    const selling   = d.selling ?? 10;
    const other     = d.other ?? 5;

    return {
      id: Date.now().toString() + Math.random().toString(16).slice(2),
      name: baseName,
      fixedCost, cogs, selling, other,
      bonusSale:  d.bonusSale  ?? 10,
      bonusRD:    d.bonusRD    ?? 4,
      bonusCSKH:  d.bonusCSKH  ?? 1,
      bonusKT:    d.bonusKT    ?? 1.2,
      bonusMedia: d.bonusMedia ?? 1,
      revenue1: d.revenue1 ?? 1000,
      revenue2: d.revenue2 ?? 1500,
      revenue3: d.revenue3 ?? 2000,
      targetFixedCost: d.fixedCost ?? fixedCost,
      targetCogs:      d.cogs      ?? cogs,
      targetSelling:   d.selling   ?? selling,
      targetOther:     d.other     ?? other,
      collapsed: false,
    };
  };

  const createInitialTeamsFromCodeDefaults = () => ([
    createDefaultTeam('TikTok'),
    createDefaultTeam('Shopee'),
    createDefaultTeam('Website'),
    createDefaultTeam('Facebook'),
    createDefaultTeam('B2B'),
  ]);

  // ===== State init =====
  let teams;
  const storedState = loadJSON(STORAGE_KEY_STATE);
  if (storedState && storedState.length) {
    teams = storedState.map(t => ({
      ...createDefaultTeam(t.name || 'Team'),
      ...t,
    }));
  } else {
    teams = createInitialTeamsFromCodeDefaults();
  }

  const saveState   = () => saveJSON(STORAGE_KEY_STATE, teams);
  const loadDefaults = () => loadJSON(STORAGE_KEY_DEFAULTS);

  const saveDefaultsFromCurrent = () => {
    saveJSON(STORAGE_KEY_DEFAULTS, teams);
    alert('Đã lưu cấu hình hiện tại làm mặc định.');
  };

  const resetToDefaults = () => {
    const storedDefaults = loadDefaults();
    if (storedDefaults && storedDefaults.length) {
      teams = storedDefaults.map(t => ({
        ...createDefaultTeam(t.name || 'Team'),
        ...t,
      }));
    } else {
      teams = createInitialTeamsFromCodeDefaults();
    }
    render();
  };

  // ===== Apps Script sync =====
  const saveToServer = async () => {
    if (!API_URL) {
      alert('Chưa cấu hình API_URL.');
      return;
    }

    try {
      const payload = { id: SCENARIO_ID, teams };
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        throw new Error('Phản hồi không phải JSON: ' + e.message);
      }

      if (!res.ok || !data.ok) {
        throw new Error(data && data.error ? data.error : 'Lỗi không xác định từ server');
      }

      alert(`Đã gửi dữ liệu lên Google Sheet (scenario: ${SCENARIO_ID}). Mở sheet sẽ thấy dòng "${SCENARIO_ID}" được cập nhật.`);
    } catch (err) {
      console.error('saveToServer error:', err);
      alert('Không lưu được lên Google Sheet: ' + err.message);
    }
  };

  const loadFromServer = async () => {
    if (!API_URL) {
      alert('Chưa cấu hình API_URL.');
      return;
    }

    try {
      const url = `${API_URL}?id=${encodeURIComponent(SCENARIO_ID)}`;
      const res = await fetch(url, { method: 'GET' });

      let dataText = await res.text();
      let data;
      try {
        data = JSON.parse(dataText);
      } catch (e) {
        console.error('Raw response:', dataText);
        throw new Error('Phản hồi không phải JSON hợp lệ.');
      }

      if (!res.ok || !data.ok) {
        throw new Error(data && data.error ? data.error : 'Lỗi không xác định từ server');
      }

      const incoming = Array.isArray(data.teams) ? data.teams : [];
      if (!incoming.length) {
        alert('Chưa có dữ liệu trên Google Sheet cho scenario này.');
        return;
      }

      teams = incoming.map(t =>
        Object.assign(
          {},
          createDefaultTeam(t.name || 'Team'),
          t
        )
      );

      render();
      alert(`Đã tải cấu hình từ Google Sheet (scenario: ${SCENARIO_ID}).`);
    } catch (err) {
      console.error('loadFromServer error:', err);
      alert('Không tải được dữ liệu từ Google Sheet: ' + err.message);
    }
  };

  // ===== Core calc =====
  const computeTeamMetrics = (team) => {
    const varPct =
      (Number(team.cogs)    || 0) +
      (Number(team.selling) || 0) +
      (Number(team.other)   || 0);

    const calcForRevenue = (r) => {
      const revenue = Number(r) || 0;
      const variableCost = revenue * (varPct / 100);
      const grossProfit  = revenue - variableCost;
      const fixedCost    = Number(team.fixedCost) || 0;
      const netProfit    = grossProfit - fixedCost;
      const safeProfit   = Math.max(0, netProfit);

      const bonusSale   = safeProfit * ((Number(team.bonusSale)   || 0) / 100);
      const bonusRD     = safeProfit * ((Number(team.bonusRD)     || 0) / 100);
      const bonusCSKH   = safeProfit * ((Number(team.bonusCSKH)   || 0) / 100);
      const bonusKT     = safeProfit * ((Number(team.bonusKT)     || 0) / 100);
      const bonusMedia  = safeProfit * ((Number(team.bonusMedia)  || 0) / 100);

      const totalBonus = bonusSale + bonusRD + bonusCSKH + bonusKT + bonusMedia;
      const profitAfterBonus = netProfit - totalBonus;

      return {
        revenue,
        variableCost,
        grossProfit,
        fixedCost,
        netProfit,
        bonusSale,
        bonusRD,
        bonusCSKH,
        bonusKT,
        bonusMedia,
        totalBonus,
        profitAfterBonus,
      };
    };

    let breakEven = null;
    const fixedCostOuter = Number(team.fixedCost) || 0;
    if (varPct < 100 && fixedCostOuter > 0) {
      breakEven = fixedCostOuter / (1 - varPct / 100);
    }

    return {
      varPct,
      breakEven,
      m1: calcForRevenue(team.revenue1),
      m2: calcForRevenue(team.revenue2),
      m3: calcForRevenue(team.revenue3),
    };
  };

  // ===== Handlers =====
  const handleInput = (teamId, field, value) => {
    teams = teams.map(t => t.id === teamId ? { ...t, [field]: value } : t);
    render();
  };

  const handleMoney = (teamId, field, raw) => {
    const num = parseMoneyInput(raw);
    handleInput(teamId, field, num);
  };

  const toggleCollapse = (teamId) => {
    teams = teams.map(t => t.id === teamId ? { ...t, collapsed: !t.collapsed } : t);
    render();
  };

  const deleteTeam = (teamId) => {
    if (teams.length === 1) {
      alert('Cần ít nhất 1 team.');
      return;
    }
    teams = teams.filter(t => t.id !== teamId);
    render();
  };

  const addTeam = () => {
    teams = [...teams, createDefaultTeam('Team mới')];
    render();
  };

  const comparePercent = (actual, target) => {
    actual = Number(actual) || 0;
    target = Number(target) || 0;
    if (!target) return { txt: '--', cls: '' };

    const diffPct = ((actual - target) / target) * 100;
    const sign = diffPct >= 0 ? '+' : '';
    const txt  = `${sign}${diffPct.toFixed(1)}%`;
    const cls  = diffPct <= 0 ? 'positive' : 'negative'; // xanh nếu ≤ target
    return { txt, cls };
  };

  const focusTeam = (name) => {
    document.querySelectorAll('.chip-button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.name === name);
    });

    let t = teams.find(team => team.name.toLowerCase() === name.toLowerCase());
    if (!t) {
      t = createDefaultTeam(name);
      teams = [...teams, t];
    }
    render();

    requestAnimationFrame(() => {
      const el = document.querySelector(`.card[data-team-id="${t.id}"]`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  };

  // ===== RENDER TEAMS =====
  const renderTeams = () => {
    const container = document.getElementById('teamsContainer');
    container.innerHTML = '';

    teams.forEach((team, index) => {
      const metrics = computeTeamMetrics(team);
      const card = document.createElement('div');
      card.className = `card team-${index % 4}`;
      card.dataset.teamId = team.id;

      const breakEvenText = metrics.breakEven
        ? `${formatCurrency(metrics.breakEven)}`
        : 'Không xác định';

      // so sánh target vs thực tế
      const fixedActual = Number(team.fixedCost) || 0;
      const fixedTarget = Number(team.targetFixedCost) || 0;
      let fixedDiffTxt = '--', fixedDiffClass = '';
      if (fixedTarget > 0) {
        const diffPct = ((fixedActual - fixedTarget) / fixedTarget) * 100;
        const sign = diffPct >= 0 ? '+' : '';
        fixedDiffTxt   = `${sign}${diffPct.toFixed(1)}%`;
        fixedDiffClass = diffPct <= 0 ? 'positive' : 'negative';
      }

      const cogsCmp  = comparePercent(team.cogs,    team.targetCogs);
      const sellCmp  = comparePercent(team.selling, team.targetSelling);
      const otherCmp = comparePercent(team.other,   team.targetOther);

      const headerHtml = `
        <div class="card-header">
          <div class="card-header-left">
            <span class="badge">Team ${index + 1}</span>
            <input
              type="text"
              class="team-name"
              value="${team.name}"
              onchange="handleInput('${team.id}','name',this.value)"
            />
            <span class="pill-input">
              <span>Tổng biến phí:</span>
              <strong>${formatPercent(metrics.varPct)}</strong>
            </span>
            <span class="pill-input">
              <span>Điểm hòa vốn:</span>
              <strong>${breakEvenText}</strong>
            </span>
          </div>
          <div>
            <button class="small" onclick="toggleCollapse('${team.id}')">
              ${team.collapsed ? 'Xem chi tiết' : 'Ẩn chi tiết'}
            </button>
            <button class="small danger" onclick="deleteTeam('${team.id}')">
              Xóa
            </button>
          </div>
        </div>
      `;

      let bodyHtml = '';
      if (!team.collapsed) {
        const profitClassM1 = metrics.m1.netProfit >= 0 ? 'positive' : 'negative';
        const profitClassM2 = metrics.m2.netProfit >= 0 ? 'positive' : 'negative';
        const profitClassM3 = metrics.m3.netProfit >= 0 ? 'positive' : 'negative';

        const paClassM1 = metrics.m1.profitAfterBonus >= 0 ? 'positive' : 'negative';
        const paClassM2 = metrics.m2.profitAfterBonus >= 0 ? 'positive' : 'negative';
        const paClassM3 = metrics.m3.profitAfterBonus >= 0 ? 'positive' : 'negative';

        bodyHtml = `
          <div class="grid">
            <div class="col-12">
              <table class="mini-compare">
                <thead>
                  <tr>
                    <th>Chỉ tiêu</th>
                    <th>Target</th>
                    <th>Thực tế</th>
                    <th>Chênh lệch</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Chi phí cố định / kỳ</td>
                    <td>
                      <input
                        type="text"
                        class="table-input"
                        value="${formatMoneyInput(team.targetFixedCost)}"
                        onchange="handleMoney('${team.id}','targetFixedCost',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="text"
                        class="table-input"
                        value="${formatMoneyInput(team.fixedCost)}"
                        onchange="handleMoney('${team.id}','fixedCost',this.value)"
                      />
                    </td>
                    <td class="${fixedDiffClass}">${fixedDiffTxt}</td>
                  </tr>
                  <tr>
                    <td>Giá vốn (COGS)</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetCogs}"
                        onchange="handleInput('${team.id}','targetCogs',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.cogs}"
                        onchange="handleInput('${team.id}','cogs',this.value)"
                      />
                    </td>
                    <td class="${cogsCmp.cls}">${cogsCmp.txt}</td>
                  </tr>
                  <tr>
                    <td>Chi phí bán hàng</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetSelling}"
                        onchange="handleInput('${team.id}','targetSelling',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.selling}"
                        onchange="handleInput('${team.id}','selling',this.value)"
                      />
                    </td>
                    <td class="${sellCmp.cls}">${sellCmp.txt}</td>
                  </tr>
                  <tr>
                    <td>Chi phí khác (biến phí)</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetOther}"
                        onchange="handleInput('${team.id}','targetOther',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.other}"
                        onchange="handleInput('${team.id}','other',this.value)"
                      />
                    </td>
                    <td class="${otherCmp.cls}">${otherCmp.txt}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-12 muted">
              = Giá vốn + Chi phí bán hàng + Chi phí khác → <b>Tổng biến phí: ${formatPercent(metrics.varPct)}</b>
            </div>

            <div class="col-12" style="margin-top:6px;">
              <p><strong>% thưởng trên LỢI NHUẬN (chỉ tính khi lợi nhuận &gt; 0)</strong></p>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">Sale</span>
                <input type="number" class="bonus-input"
                  value="${team.bonusSale}"
                  onchange="handleInput('${team.id}','bonusSale',this.value)" />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">RD</span>
                <input type="number" class="bonus-input"
                  value="${team.bonusRD}"
                  onchange="handleInput('${team.id}','bonusRD',this.value)" />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">CSKH</span>
                <input type="number" class="bonus-input"
                  value="${team.bonusCSKH}"
                  onchange="handleInput('${team.id}','bonusCSKH',this.value)" />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">KT + HCNS</span>
                <input type="number" class="bonus-input"
                  value="${team.bonusKT}"
                  onchange="handleInput('${team.id}','bonusKT',this.value)" />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">Media</span>
                <input type="number" class="bonus-input"
                  value="${team.bonusMedia}"
                  onchange="handleInput('${team.id}','bonusMedia',this.value)" />
              </div>
            </div>
            <div class="col-12 muted">
              Tổng % thưởng = Sale + RD + CSKH + KT + Media. Thưởng tính trên LNR &gt; 0 của từng mốc.
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Chỉ tiêu</th>
                <th>Mốc 1</th>
                <th>Mốc 2</th>
                <th>Mốc 3</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Doanh thu</td>
                <td>
                  <input type="text" class="table-input"
                    value="${formatMoneyInput(team.revenue1)}"
                    onchange="handleMoney('${team.id}','revenue1',this.value)" />
                </td>
                <td>
                  <input type="text" class="table-input"
                    value="${formatMoneyInput(team.revenue2)}"
                    onchange="handleMoney('${team.id}','revenue2',this.value)" />
                </td>
                <td>
                  <input type="text" class="table-input"
                    value="${formatMoneyInput(team.revenue3)}"
                    onchange="handleMoney('${team.id}','revenue3',this.value)" />
                </td>
              </tr>
              <tr>
                <td>Biến phí</td>
                <td>${cellValPct(metrics.m1.variableCost, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.variableCost, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.variableCost, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Lợi nhuận gộp (sau biến phí)</td>
                <td>${cellValPct(metrics.m1.grossProfit, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.grossProfit, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.grossProfit, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Chi phí cố định</td>
                <td>${cellValPct(metrics.m1.fixedCost, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.fixedCost, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.fixedCost, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Lợi nhuận trước thưởng</td>
                <td class="${profitClassM1}">${cellValPct(metrics.m1.netProfit, metrics.m1.revenue)}</td>
                <td class="${profitClassM2}">${cellValPct(metrics.m2.netProfit, metrics.m2.revenue)}</td>
                <td class="${profitClassM3}">${cellValPct(metrics.m3.netProfit, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Thưởng Sale</td>
                <td>${cellValPct(metrics.m1.bonusSale, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusSale, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusSale, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Thưởng RD</td>
                <td>${cellValPct(metrics.m1.bonusRD, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusRD, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusRD, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Thưởng CSKH</td>
                <td>${cellValPct(metrics.m1.bonusCSKH, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusCSKH, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusCSKH, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Thưởng KT + HCNS</td>
                <td>${cellValPct(metrics.m1.bonusKT, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusKT, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusKT, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Thưởng Media</td>
                <td>${cellValPct(metrics.m1.bonusMedia, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusMedia, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusMedia, metrics.m3.revenue)}</td>
              </tr>
              <tr class="row-total">
                <td><strong>Tổng thưởng</strong></td>
                <td>${cellValPct(metrics.m1.totalBonus, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.totalBonus, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.totalBonus, metrics.m3.revenue)}</td>
              </tr>
              <tr class="row-profit">
                <td><strong>Lợi nhuận sau thưởng</strong></td>
                <td class="${paClassM1}">${cellValPct(metrics.m1.profitAfterBonus, metrics.m1.revenue)}</td>
                <td class="${paClassM2}">${cellValPct(metrics.m2.profitAfterBonus, metrics.m2.revenue)}</td>
                <td class="${paClassM3}">${cellValPct(metrics.m3.profitAfterBonus, metrics.m3.revenue)}</td>
              </tr>
            </tbody>
          </table>
        `;
      }

      card.innerHTML = headerHtml + bodyHtml;
      container.appendChild(card);
    });
  };

  // ===== RENDER SUMMARY =====
  const renderSummary = () => {
    const container = document.getElementById('summaryContainer');
    if (!teams.length) {
      container.innerHTML = "<p class='muted'>Chưa có team nào.</p>";
      return;
    }

    let rowsHtml = '';

    let totalRevenue = 0;
    let totalCostBeforeBonus = 0;
    let totalGross   = 0;
    let totalProfit  = 0;
    let totalSale    = 0;
    let totalRD      = 0;
    let totalCSKH    = 0;
    let totalKT      = 0;
    let totalMedia   = 0;
    let totalBonus   = 0;

    teams.forEach(team => {
      const m = computeTeamMetrics(team).m3; // Mốc 3

      const costBeforeBonus = m.variableCost + m.fixedCost;

      totalRevenue         += m.revenue;
      totalCostBeforeBonus += costBeforeBonus;
      totalGross           += m.grossProfit;
      totalProfit          += m.profitAfterBonus;
      totalSale            += m.bonusSale;
      totalRD              += m.bonusRD;
      totalCSKH            += m.bonusCSKH;
      totalKT              += m.bonusKT;
      totalMedia           += m.bonusMedia;
      totalBonus           += m.totalBonus;

      const grossCls  = m.grossProfit      >= 0 ? 'positive' : 'negative';
      const profitCls = m.profitAfterBonus >= 0 ? 'positive' : 'negative';

      rowsHtml += `
        <tr>
          <td>${team.name}</td>
          <td>${formatCurrency(m.revenue)}</td>
          <td>${cellValPct(costBeforeBonus, m.revenue)}</td>
          <td class="${grossCls}">${cellValPct(m.grossProfit, m.revenue)}</td>
          <td class="${profitCls}">${cellValPct(m.profitAfterBonus, m.revenue)}</td>
          <td>${cellValPct(m.bonusSale, m.revenue)}</td>
          <td>${cellValPct(m.bonusRD, m.revenue)}</td>
          <td>${cellValPct(m.bonusCSKH, m.revenue)}</td>
          <td>${cellValPct(m.bonusKT, m.revenue)}</td>
          <td>${cellValPct(m.bonusMedia, m.revenue)}</td>
          <td>${cellValPct(m.totalBonus, m.revenue)}</td>
        </tr>
      `;
    });

    const totalGrossCls  = totalGross  >= 0 ? 'positive' : 'negative';
    const totalProfitCls = totalProfit >= 0 ? 'positive' : 'negative';

    const tableHtml = `
      <table>
        <thead>
          <tr>
            <th>Team</th>
            <th>Doanh thu Mốc 3</th>
            <th>Chi phí (trước thưởng)</th>
            <th>Lợi nhuận gộp</th>
            <th>Lợi nhuận sau thưởng</th>
            <th>Thưởng Sale</th>
            <th>Thưởng RD</th>
            <th>Thưởng CSKH</th>
            <th>Thưởng KT+HCNS</th>
            <th>Thưởng Media</th>
            <th>Tổng thưởng</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Tổng doanh nghiệp</strong></td>
            <td>${formatCurrency(totalRevenue)}</td>
            <td>${cellValPct(totalCostBeforeBonus, totalRevenue)}</td>
            <td class="${totalGrossCls}">
              ${cellValPct(totalGross, totalRevenue)}
            </td>
            <td class="${totalProfitCls}">
              ${cellValPct(totalProfit, totalRevenue)}
            </td>
            <td>${cellValPct(totalSale, totalRevenue)}</td>
            <td>${cellValPct(totalRD, totalRevenue)}</td>
            <td>${cellValPct(totalCSKH, totalRevenue)}</td>
            <td>${cellValPct(totalKT, totalRevenue)}</td>
            <td>${cellValPct(totalMedia, totalRevenue)}</td>
            <td>${cellValPct(totalBonus, totalRevenue)}</td>
          </tr>
        </tfoot>
      </table>
    `;

    container.innerHTML = tableHtml;
  };

  // ===== MASTER RENDER =====
  const render = () => {
    renderTeams();
    renderSummary();
    saveState();
  };

  // Khởi tạo
  render();
</script>
</body>
</html>
