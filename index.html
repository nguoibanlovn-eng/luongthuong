<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì target | L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn:hover {
      background: #f3f4f6;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      white-space: nowrap;
    }
    .pill-green {
      background: #ecfdf3;
      border-color: #22c55e;
      color: #166534;
    }
    .pill-red {
      background: #fef2f2;
      border-color: #f97373;
      color: #b91c1c;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      margin-bottom: 14px;
      border-left: 4px solid #e5e7eb;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .card-channel-facebook { border-left-color: #3b82f6; }
    .card-channel-tiktok { border-left-color: #ec4899; }
    .card-channel-shopee { border-left-color: #f97316; }
    .card-channel-web { border-left-color: #10b981; }
    .card-total { border-left-color: #111827; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }
    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
      white-space: nowrap;
    }
    thead {
      background: #f9fafb;
    }

    input[type="number"] {
      width: 100%;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      text-align: right;
    }
    input[type="number"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .muted {
      color: #9ca3af;
    }

    .footer-note {
      margin-top: 20px;
      font-size: 11px;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì target</h1>
  <div class="subtitle">
    Tool n√†y d√πng ƒë·ªÉ t√≠nh nhanh doanh thu ‚Äì chi ph√≠ ‚Äì l·ª£i nhu·∫≠n theo t·ª´ng k√™nh (Facebook, TikTok, Shopee, Web),
    theo ƒë√∫ng c·∫•u tr√∫c chi ph√≠ trong file plan th∆∞·ªüng. Nh·∫≠p doanh thu t·ª´ng k√™nh, tool s·∫Ω b√°o l·ªó/l√£i v√† bi√™n l·ª£i nhu·∫≠n.
  </div>

  <div class="toolbar">
    <button class="btn" id="btnResetPlan">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh plan</button>
    <button class="btn" id="btnSaveDefault">L∆∞u l√†m m·∫∑c ƒë·ªãnh (local)</button>
    <button class="btn" id="btnLoadFromSheet">T·∫£i t·ª´ Google Sheet</button>
    <button class="btn btn-primary" id="btnSaveToSheet">L∆∞u l√™n Google Sheet</button>
  </div>

  <div id="channelsContainer"></div>

  <div id="totalCard"></div>

  <div class="footer-note">
    * ƒê∆°n v·ªã m·∫∑c ƒë·ªãnh: <b>tri·ªáu</b> (vnd).<br>
    * T·ªâ l·ªá chi ph√≠/bi√™n l·ª£i nhu·∫≠n m·∫∑c ƒë·ªãnh l·∫•y t·ª´ file Excel ‚ÄúPLAN TH∆Ø·ªûNG V≈®‚Äù (Facebook, TikTok, Shopee, Web).<br>
    * Google Sheet ch·ªâ l∆∞u l·∫°i <b>state hi·ªán t·∫°i</b> (doanh thu + c·∫•u h√¨nh chi ph√≠) d·∫°ng JSON, kh√¥ng t·ª± t√≠nh gi√∫p ‚Äì t√≠nh to√°n l√† ·ªü web n√†y.
  </div>
</div>

<script>
  /*************************************************
   * 1. C·∫§U H√åNH & STATE
   *************************************************/
  // üëâ D√ÅN URL WEB APP APPS SCRIPT V√ÄO ƒê√ÇY
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxh6hOQL2cD6SUwnRp91OtPPS83h658rEuq3Hg9Cm15OHBAV9_w3HOEuUeS2prtVUNqlA/exec';

  const LOCAL_KEY_CURRENT = 'nbl_plan_state_current_v2';
  const LOCAL_KEY_DEFAULT = 'nbl_plan_state_default_v2';

  // Default theo plan trong Excel (m√¨nh ƒë√£ ƒë·ªçc t·ª´ file)
  const DEFAULT_STATE = {
    scenario: 'default',
    channels: {
      facebook: {
        key: 'facebook',
        label: 'Facebook',
        colorClass: 'card-channel-facebook',
        revenue: 2800,       // target mid: 2800
        costSellRate: 0.14,  // Chi ph√≠ b√°n h√†ng (% doanh thu)
        costCogsRate: 0.55,  // Gi√° v·ªën
        costOtherRate: 0.05, // Chi ph√≠ kh√°c
        fixedCost: 320       // Chi ph√≠ c·ªë ƒë·ªãnh
      },
      tiktok: {
        key: 'tiktok',
        label: 'TikTok',
        colorClass: 'card-channel-tiktok',
        revenue: 2800,
        costSellRate: 0.27,
        costCogsRate: 0.45,
        costOtherRate: 0.05,
        fixedCost: 320
      },
      shopee: {
        key: 'shopee',
        label: 'Shopee',
        colorClass: 'card-channel-shopee',
        revenue: 1200,
        costSellRate: 0.27,
        costCogsRate: 0.50,
        costOtherRate: 0.05,
        fixedCost: 120
      },
      web: {
        key: 'web',
        label: 'Web',
        colorClass: 'card-channel-web',
        revenue: 320,
        costSellRate: 0.09,
        costCogsRate: 0.50,
        costOtherRate: 0.05,
        fixedCost: 75
      }
    }
  };

  const CHANNEL_ORDER = ['facebook', 'tiktok', 'shopee', 'web'];

  let state = null; // s·∫Ω init ·ªü d∆∞·ªõi

  /*************************************************
   * 2. TI·ªÜN √çCH S·ªê & T√çNH TO√ÅN
   *************************************************/
  function parseNumber(val) {
    if (val === '' || val === null || val === undefined) return 0;
    const clean = String(val).replace(/,/g, '').trim();
    const num = Number(clean);
    return isNaN(num) ? 0 : num;
  }

  function formatNumber(num, digits = 2) {
    if (num === null || num === undefined || isNaN(num)) return '';
    return new Intl.NumberFormat('vi-VN', { maximumFractionDigits: digits }).format(num);
  }

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  // T√≠nh cho 1 k√™nh
  function calcChannelMetrics(ch) {
    const revenue = parseNumber(ch.revenue);
    const costSell = parseNumber(ch.costSellRate);
    const costCogs = parseNumber(ch.costCogsRate);
    const costOther = parseNumber(ch.costOtherRate);
    const fixedCost = parseNumber(ch.fixedCost);

    const totalRate = costSell + costCogs + costOther; // t·ªâ l·ªá t·ªïng chi ph√≠ bi·∫øn
    const variableCost = revenue * totalRate;
    const totalCost = variableCost + fixedCost;
    const profit = revenue - totalCost;
    const margin = revenue > 0 ? profit / revenue : 0;

    let breakevenRevenue = null;
    if (1 - totalRate > 0) {
      breakevenRevenue = fixedCost / (1 - totalRate);
    }

    const diffFromBreakeven = breakevenRevenue !== null ? revenue - breakevenRevenue : null;

    return {
      revenue,
      costSell,
      costCogs,
      costOther,
      fixedCost,
      totalRate,
      variableCost,
      totalCost,
      profit,
      margin,
      breakevenRevenue,
      diffFromBreakeven
    };
  }

  // T√≠nh t·ªïng t·∫•t c·∫£ k√™nh
  function calcTotalMetrics() {
    let sumRevenue = 0;
    let sumVariable = 0;
    let sumFixed = 0;

    CHANNEL_ORDER.forEach(key => {
      const ch = state.channels[key];
      if (!ch) return;
      const m = calcChannelMetrics(ch);
      sumRevenue += m.revenue;
      sumVariable += m.variableCost;
      sumFixed += m.fixedCost;
    });

    const totalCost = sumVariable + sumFixed;
    const profit = sumRevenue - totalCost;
    const margin = sumRevenue > 0 ? profit / sumRevenue : 0;
    const effectiveVarRate = sumRevenue > 0 ? (sumVariable / sumRevenue) : 0;

    let breakevenRevenue = null;
    if (1 - effectiveVarRate > 0) {
      breakevenRevenue = sumFixed / (1 - effectiveVarRate);
    }

    return {
      sumRevenue,
      sumVariable,
      sumFixed,
      totalCost,
      profit,
      margin,
      effectiveVarRate,
      breakevenRevenue
    };
  }

  /*************************************************
   * 3. RENDER UI
   *************************************************/
  function renderChannels() {
    const container = document.getElementById('channelsContainer');
    container.innerHTML = '';

    CHANNEL_ORDER.forEach(key => {
      const ch = state.channels[key];
      if (!ch) return;

      const metrics = calcChannelMetrics(ch);
      const card = document.createElement('div');
      card.className = 'card ' + ch.colorClass;

      const profitClass = metrics.profit >= 0 ? 'pill-green' : 'pill-red';
      const profitText = 'L·ª£i nhu·∫≠n: ' + formatNumber(metrics.profit) + ' tri·ªáu'
        + (metrics.margin ? ' (' + formatNumber(metrics.margin * 100, 1) + '%)' : '');

      const diffBreakevenText = metrics.breakevenRevenue !== null
        ? (metrics.diffFromBreakeven >= 0
            ? '‚Üë v∆∞·ª£t h√≤a v·ªën ' + formatNumber(metrics.diffFromBreakeven, 1) + ' tri·ªáu'
            : '‚Üì d∆∞·ªõi h√≤a v·ªën ' + formatNumber(Math.abs(metrics.diffFromBreakeven), 1) + ' tri·ªáu')
        : '‚Äî';

      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${ch.label}</div>
            <div class="card-sub">
              Nh·∫≠p doanh thu & chi ph√≠ c·ªßa k√™nh n√†y. Bi√™n ph√≠ v√† chi ph√≠ c·ªë ƒë·ªãnh ƒëang d√πng theo plan m·∫∑c ƒë·ªãnh.
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
            <span class="pill ${profitClass}">${profitText}</span>
            <span class="muted" style="font-size:11px;">${diffBreakevenText}</span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Ch·ªâ ti√™u</th>
              <th>Gi√° tr·ªã</th>
              <th>T·ªâ l·ªá (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Doanh thu (tri·ªáu)</td>
              <td>
                <input type="number" step="0.01" data-channel="${key}" data-field="revenue"
                       value="${ch.revenue !== undefined ? ch.revenue : ''}">
              </td>
              <td class="muted">100%</td>
            </tr>
            <tr>
              <td>CP b√°n h√†ng</td>
              <td>${formatNumber(metrics.revenue * metrics.costSell, 2)}</td>
              <td>
                <input type="number" step="0.01" data-channel="${key}" data-field="costSellRate"
                       value="${(ch.costSellRate * 100).toFixed(2)}">
              </td>
            </tr>
            <tr>
              <td>Gi√° v·ªën</td>
              <td>${formatNumber(metrics.revenue * metrics.costCogs, 2)}</td>
              <td>
                <input type="number" step="0.01" data-channel="${key}" data-field="costCogsRate"
                       value="${(ch.costCogsRate * 100).toFixed(2)}">
              </td>
            </tr>
            <tr>
              <td>Chi ph√≠ kh√°c</td>
              <td>${formatNumber(metrics.revenue * metrics.costOther, 2)}</td>
              <td>
                <input type="number" step="0.01" data-channel="${key}" data-field="costOtherRate"
                       value="${(ch.costOtherRate * 100).toFixed(2)}">
              </td>
            </tr>
            <tr>
              <td>Chi ph√≠ c·ªë ƒë·ªãnh</td>
              <td>
                <input type="number" step="0.01" data-channel="${key}" data-field="fixedCost"
                       value="${ch.fixedCost !== undefined ? ch.fixedCost : ''}">
              </td>
              <td class="muted">‚Äî</td>
            </tr>
          </tbody>
        </table>

        <table>
          <thead>
            <tr>
              <th>Output</th>
              <th>S·ªë ti·ªÅn (tri·ªáu)</th>
              <th>T·ªâ l·ªá theo doanh thu</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>T·ªïng chi ph√≠ bi·∫øn</td>
              <td>${formatNumber(metrics.variableCost, 2)}</td>
              <td>${formatNumber(metrics.totalRate * 100, 2)}%</td>
            </tr>
            <tr>
              <td>T·ªïng chi ph√≠ (bi·∫øn + c·ªë ƒë·ªãnh)</td>
              <td>${formatNumber(metrics.totalCost, 2)}</td>
              <td>${metrics.revenue > 0 ? formatNumber(metrics.totalCost / metrics.revenue * 100, 2) + '%' : '‚Äî'}</td>
            </tr>
            <tr>
              <td>L·ª£i nhu·∫≠n</td>
              <td style="color:${metrics.profit >= 0 ? '#166534' : '#b91c1c'}; font-weight:600;">
                ${formatNumber(metrics.profit, 2)}
              </td>
              <td>${metrics.revenue > 0 ? formatNumber(metrics.margin * 100, 2) + '%' : '‚Äî'}</td>
            </tr>
            <tr>
              <td>Doanh thu h√≤a v·ªën</td>
              <td>${metrics.breakevenRevenue !== null ? formatNumber(metrics.breakevenRevenue, 2) : '‚Äî'}</td>
              <td>
                ${
                  (metrics.breakevenRevenue !== null && metrics.revenue > 0)
                    ? formatNumber(metrics.breakevenRevenue / metrics.revenue * 100, 1) + '% so v·ªõi DT hi·ªán t·∫°i'
                    : '‚Äî'
                }
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
    
    container.appendChild(card);
  }

  function renderTotalCard() {
    const metrics = calcTotalMetrics();
    const totalContainer = document.getElementById('totalCard');
    const profitClass = metrics.profit >= 0 ? 'pill-green' : 'pill-red';

    const profitText = 'L·ª£i nhu·∫≠n: ' + formatNumber(metrics.profit, 2) + ' tri·ªáu'
      + (metrics.margin ? ' (' + formatNumber(metrics.margin * 100, 2) + '%)' : '');

    const breakevenText = metrics.breakevenRevenue !== null
      ? 'H√≤a v·ªën t·ªïng: ' + formatNumber(metrics.breakevenRevenue, 2) : '‚Äî
