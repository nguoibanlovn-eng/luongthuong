<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng theo team | L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      padding: 16px;
      max-width: 1100px;
      margin-inline: auto;
      box-sizing: border-box;
      line-height: 1.5;
      font-size: 14px;
    }
    h1 { font-size: 22px; margin-bottom: 6px; }
    h2 { margin-top: 20px; font-size: 18px; }
    p  { margin: 2px 0 6px; }
    .muted { opacity: 0.7; font-size: 12px; }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 6px 0 10px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid rgba(128,128,128,0.5);
      padding: 6px 12px;
      background: transparent;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    button.primary { background: #2563eb; border-color: #2563eb; color: #fff; }
    button.danger  { border-color: #dc2626; color: #dc2626; }
    button.small   { padding: 4px 8px; font-size: 11px; }

    .chip-button {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(128,128,128,0.06);
    }
    .chip-button.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(128,128,128,0.5);
      font-size: 13px;
      background: transparent;
      height: 32px;
    }
    input:focus {
      outline: 2px solid #2563eb55;
      border-color: #2563eb;
    }

    .team-name {
      max-width: 170px;
      font-weight: 600;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .col-2 { grid-column: span 2; }
    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    @media (max-width: 768px) {
      .col-2, .col-3, .col-4, .col-6 { grid-column: span 12; }
    }

    .card {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 10px;
      margin-bottom: 14px;
      background: rgba(255,255,255,0.02);
    }
    .card.team-0 { border-left: 4px solid #3b82f6; background: rgba(59,130,246,0.02); }
    .card.team-1 { border-left: 4px solid #22c55e; background: rgba(34,197,94,0.02); }
    .card.team-2 { border-left: 4px solid #f97316; background: rgba(249,115,22,0.02); }
    .card.team-3 { border-left: 4px solid #a855f7; background: rgba(168,85,247,0.02); }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(148,163,184,0.15);
      font-weight: 600;
    }

    .pill-input {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.9);
      background: rgba(249,250,251,0.9);
    }
    .pill-input span { opacity: 0.7; }
    .pill-input strong { font-variant-numeric: tabular-nums; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 12px;
      table-layout: fixed;
    }
    th, td {
      padding: 3px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.6);
      text-align: right;
      font-variant-numeric: tabular-nums;
      vertical-align: middle;
    }
    th:first-child,
    td:first-child {
      text-align: left;
    }
    th { font-weight: 600; background: rgba(148,163,184,0.25); }
    tbody tr:nth-child(even) { background: rgba(148,163,184,0.08); }
    tfoot td { font-weight: 600; background: rgba(37,99,235,0.06); }
    .row-total  { background: rgba(59,130,246,0.08) !important; }
    .row-profit { background: rgba(16,185,129,0.08) !important; }

    .muted-percent {
      display: inline-block;
      margin-left: 4px;
      font-size: 10px;
      opacity: 0.7;
    }

    .positive { color: #16a34a; }
    .negative { color: #dc2626; }

    .table-input {
      height: 22px;
      padding: 1px 4px;
      font-size: 12px;
      text-align: right;
      border-radius: 6px;
      background: transparent;
    }

    .section-divider {
      margin: 14px 0 8px;
      border-top: 1px dashed rgba(148,163,184,0.9);
    }

    .mini-compare {
      margin-top: 2px;
      font-size: 11px;
      table-layout: auto;
    }
    .mini-compare th,
    .mini-compare td {
      padding: 1px 4px;
    }
    .mini-compare .table-input {
      height: 20px;
      font-size: 11px;
      padding: 1px 4px;
      max-width: 110px;
    }

    .bonus-input {
      width: 70px !important;
      max-width: 100%;
      height: 22px !important;
      font-size: 12px;
      text-align: right;
      padding: 2px 4px;
    }
    .bonus-field {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .bonus-label {
      font-size: 13px;
      font-weight: 500;
    }

    .blog-promo {
      margin-top: 20px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(37,99,235,0.4);
      background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(59,130,246,0.02));
    }
    .blog-promo-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .blog-promo-link {
      display: inline-block;
      margin-bottom: 4px;
      font-weight: 600;
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.7);
    }
    .blog-promo-link:hover {
      background: rgba(37,99,235,0.12);
    }
    .blog-promo-sub {
      font-size: 12px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng theo team</h1>
  <p class="muted">
    C√¥ng c·ª• n·ªôi b·ªô gi√∫p L·ªó V≈© &amp; team set target, t√≠nh h√≤a v·ªën, chia th∆∞·ªüng theo t·ª´ng team
    (Sale, RD, CSKH, KT+HCNS, Media). ƒê∆°n v·ªã doanh thu &amp; chi ph√≠ c√≥ th·ªÉ d√πng theo tri·ªáu cho d·ªÖ nh√¨n.
  </p>

  <div class="section-divider"></div>

  <h2>C·∫•u h√¨nh team <span class="muted">√Åp d·ª•ng trong phi√™n l√†m vi·ªác n√†y</span></h2>
  <div class="toolbar">
    <div>
      <span class="muted">Ch·ªçn team nhanh:</span>
      <button class="chip-button" data-name="TikTok"   onclick="focusTeam('TikTok')">TikTok</button>
      <button class="chip-button" data-name="Shopee"   onclick="focusTeam('Shopee')">Shopee</button>
      <button class="chip-button" data-name="Website"  onclick="focusTeam('Website')">Website</button>
      <button class="chip-button" data-name="Facebook" onclick="focusTeam('Facebook')">Facebook</button>
      <button class="chip-button" data-name="B2B"      onclick="focusTeam('B2B')">B2B</button>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <button class="small" onclick="resetToDefaults()">C·∫≠p nh·∫≠t l·∫°i ch·ªâ s·ªë</button>
      <button class="small" onclick="saveDefaultsFromCurrent()">L∆∞u l√†m m·∫∑c ƒë·ªãnh</button>
      <button class="small" onclick="loadFromServer()">T·∫£i t·ª´ Google Sheet</button>
      <button class="small" onclick="saveToServer()">L∆∞u l√™n Google Sheet</button>
      <button class="primary" onclick="addTeam()">+ Th√™m team</button>
    </div>
  </div>
  <p class="muted">
    ‚Ä¢ Thay ƒë·ªïi ƒë∆∞·ª£c l∆∞u l·∫°i tr√™n tr√¨nh duy·ªát c·ªßa anh (localStorage).<br />
    ‚Ä¢ ‚ÄúL∆∞u l√†m m·∫∑c ƒë·ªãnh‚Äù s·∫Ω ghi nh·ªõ c·∫•u h√¨nh hi·ªán t·∫°i ƒë·ªÉ l·∫ßn reset sau d√πng l·∫°i.
  </p>

  <div id="teamsContainer"></div>

  <div class="section-divider"></div>

  <h2>T·ªïng quan doanh thu &amp; th∆∞·ªüng c√°c team</h2>
  <p class="muted">
    M·ªói team d√πng 3 m·ªëc doanh thu: <b>M·ªëc 1</b>, <b>M·ªëc 2</b>, <b>M·ªëc 3 (th·ª±c t·∫ø)</b>. M·ªëc 3 d√πng ƒë·ªÉ
    t√≠nh t·ªïng doanh thu &amp; t·ªïng th∆∞·ªüng to√†n doanh nghi·ªáp.
  </p>

  <h2 style="margin-top: 18px;">T·ªïng quan t·∫•t c·∫£ team (M·ªëc 3 ‚Äì th·ª±c t·∫ø)</h2>
  <div id="summaryContainer"></div>

  <div class="blog-promo">
    <div class="blog-promo-title">ƒê·ªçc th√™m c√°c b√†i vi·∫øt &amp; case th·ª±c chi·∫øn t·∫°i trang ch·ªß:</div>
    <a href="https://nguoibanlo.vn" target="_blank" rel="noreferrer" class="blog-promo-link">
      nguoibanlo.vn
    </a>
    <div class="blog-promo-sub">
      Chia s·∫ª v·ªÅ TMƒêT, x√¢y k√™nh, chia th∆∞·ªüng, t·ªëi ∆∞u P&amp;L cho SME Vi·ªát ‚Äì phong c√°ch L·ªó V≈©.
    </div>
  </div>

<script>
  // =========================
  // 1) C·∫§U H√åNH API
  // =========================
  // üëâ THAY B·∫∞NG URL ·ª®NG D·ª§NG WEB APPS SCRIPT C·ª¶A ANH (k·∫øt th√∫c b·∫±ng /exec)
  const API_URL = 'https://script.google.com/macros/s/AKfycbzM7u_CeZoQQ6QjagAdT6UXvnuCmVnzwDbQUQDtv1qnwGWvsWtLbcI2mTgkAq50fQ4gKg/exec';
  const SCENARIO_ID = 'default';

  // =========================
  // 2) LOCALSTORAGE
  // =========================
  const STORAGE_KEY_STATE    = 'thuong_tool_state_v2';
  const STORAGE_KEY_DEFAULTS = 'thuong_tool_defaults_v2';

  const loadJSON = (key) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      console.warn('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c', key, e);
      return null;
    }
  };

  const saveJSON = (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.warn('Kh√¥ng l∆∞u ƒë∆∞·ª£c', key, e);
    }
  };

  // =========================
  // 3) HELPER FORMAT
  // =========================
  const formatCurrency = (n) => {
    if (isNaN(n)) return '-';
    return Number(n).toLocaleString('vi-VN', { maximumFractionDigits: 0 });
  };

  const formatPercent = (n) => {
    if (isNaN(n)) return '-';
    return Number(n).toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + ' %';
  };

  const formatMoneyInput = (n) => {
    if (n === null || n === undefined || n === '' || isNaN(n)) return '';
    return Number(n).toLocaleString('vi-VN');
  };

  const parseMoneyInput = (str) => {
    if (str === null || str === undefined) return 0;
    const cleaned = String(str).replace(/[^\d-]/g, '');
    const num = Number(cleaned);
    return isNaN(num) ? 0 : num;
  };

  const cellValPct = (val, revenue) => {
    if (isNaN(val)) return '-';
    const base = formatCurrency(val);
    if (!revenue || isNaN(revenue) || revenue === 0) return base;
    const pct = (val / revenue) * 100;
    return `${base}<span class="muted-percent">(${pct.toFixed(1)}%)</span>`;
  };

  // =========================
  // 4) DEFAULT TEAM CONFIG
  // =========================
  const DEFAULT_TEAMS = {
    Facebook: {
      fixedCost: 320,
      cogs: 60,
      selling: 15,
      other: 5,
      bonusSale: 27,
      bonusRD: 4,
      bonusCSKH: 1,
      bonusKT: 1.2,
      bonusMedia: 1,
      revenue1: 1250,
      revenue2: 2309,
      revenue3: 2800,
    },
    TikTok: {
      fixedCost: 320,
      cogs: 51,
      selling: 30,
      other: 5,
      bonusSale: 27,
      bonusRD: 4,
      bonusCSKH: 1,
      bonusKT: 1.2,
      bonusMedia: 1,
      revenue1: 1800,
      revenue2: 1862,
      revenue3: 2800,
    },
    Shopee: {
      fixedCost: 120,
      cogs: 53,
      selling: 30,
      other: 5,
      bonusSale: 7,
      bonusRD: 4,
      bonusCSKH: 1,
      bonusKT: 1.2,
      bonusMedia: 1,
      revenue1: 800,
      revenue2: 1030,
      revenue3: 1200,
    },
    Website: {
      fixedCost: 75,
      cogs: 60,
      selling: 15,
      other: 5,
      bonusSale: 25,
      bonusRD: 4,
      bonusCSKH: 1,
      bonusKT: 1.2,
      bonusMedia: 1,
      revenue1: 245,
      revenue2: 245,
      revenue3: 320,
    },
    B2B: {
      fixedCost: 75,
      cogs: 60,
      selling: 15,
      other: 5,
      bonusSale: 20, // Sale B2B ƒÉn 20% LNR
      bonusRD: 4,
      bonusCSKH: 1,
      bonusKT: 1.2,
      bonusMedia: 1,
      revenue1: 245,
      revenue2: 245,
      revenue3: 320,
    },
  };

  const createDefaultTeam = (name) => {
    const baseName = name || 'Team m·ªõi';
    const d = DEFAULT_TEAMS[baseName] || {};
    const fixedCost = d.fixedCost ?? 100;
    const cogs = d.cogs ?? 60;
    const selling = d.selling ?? 10;
    const other = d.other ?? 5;

    return {
      id: Date.now().toString() + Math.random().toString(16).slice(2),
      name: baseName,
      fixedCost,
      cogs,
      selling,
      other,
      bonusSale: d.bonusSale ?? 10,
      bonusRD: d.bonusRD ?? 4,
      bonusCSKH: d.bonusCSKH ?? 1,
      bonusKT: d.bonusKT ?? 1.2,
      bonusMedia: d.bonusMedia ?? 1,
      revenue1: d.revenue1 ?? 1000,
      revenue2: d.revenue2 ?? 1500,
      revenue3: d.revenue3 ?? 2000,
      targetFixedCost: d.fixedCost ?? fixedCost,
      targetCogs: d.cogs ?? cogs,
      targetSelling: d.selling ?? selling,
      targetOther: d.other ?? other,
      collapsed: false,
    };
  };

  const createInitialTeamsFromCodeDefaults = () => ([
    createDefaultTeam('TikTok'),
    createDefaultTeam('Shopee'),
    createDefaultTeam('Website'),
    createDefaultTeam('Facebook'),
    createDefaultTeam('B2B'),
  ]);

  // =========================
  // 5) STATE
  // =========================
  let teams = [];

  const loadState = () => loadJSON(STORAGE_KEY_STATE);
  const saveState = () => saveJSON(STORAGE_KEY_STATE, teams);
  const loadDefaults = () => loadJSON(STORAGE_KEY_DEFAULTS);

  const saveDefaultsFromCurrent = () => {
    saveJSON(STORAGE_KEY_DEFAULTS, teams);
    alert('ƒê√£ l∆∞u c·∫•u h√¨nh hi·ªán t·∫°i l√†m m·∫∑c ƒë·ªãnh.');
  };

  const resetToDefaults = () => {
    const storedDefaults = loadDefaults();
    if (storedDefaults && storedDefaults.length) {
      teams = storedDefaults.map(t => ({
        ...createDefaultTeam(t.name || 'Team'),
        ...t,
      }));
    } else {
      teams = createInitialTeamsFromCodeDefaults();
    }
    render();
  };

  // =========================
  // 6) T√çNH TO√ÅN
  // =========================
  const computeTeamMetrics = (team) => {
    const varPct = (Number(team.cogs) || 0) +
                   (Number(team.selling) || 0) +
                   (Number(team.other) || 0);

    const calcForRevenue = (r) => {
      const revenue = Number(r) || 0;
      const variableCost = revenue * (varPct / 100);
      const grossProfit = revenue - variableCost;
      const fixedCost = Number(team.fixedCost) || 0;
      const netProfit = grossProfit - fixedCost;
      const safeProfit = Math.max(0, netProfit);

      const bonusSale   = safeProfit * ((Number(team.bonusSale)   || 0) / 100);
      const bonusRD     = safeProfit * ((Number(team.bonusRD)     || 0) / 100);
      const bonusCSKH   = safeProfit * ((Number(team.bonusCSKH)   || 0) / 100);
      const bonusKT     = safeProfit * ((Number(team.bonusKT)     || 0) / 100);
      const bonusMedia  = safeProfit * ((Number(team.bonusMedia)  || 0) / 100);

      const totalBonus = bonusSale + bonusRD + bonusCSKH + bonusKT + bonusMedia;
      const profitAfterBonus = netProfit - totalBonus;

      return {
        revenue,
        variableCost,
        grossProfit,
        fixedCost,
        netProfit,
        bonusSale,
        bonusRD,
        bonusCSKH,
        bonusKT,
        bonusMedia,
        totalBonus,
        profitAfterBonus
      };
    };

    let breakEven = null;
    const fixedCostOuter = Number(team.fixedCost) || 0;
    if (varPct < 100 && fixedCostOuter > 0) {
      breakEven = fixedCostOuter / (1 - varPct / 100);
    }

    return {
      varPct,
      breakEven,
      m1: calcForRevenue(team.revenue1),
      m2: calcForRevenue(team.revenue2),
      m3: calcForRevenue(team.revenue3)
    };
  };

  // so s√°nh % chi ph√≠: ch√™nh l·ªách theo t·ªâ l·ªá % so v·ªõi target
  const comparePercent = (actual, target) => {
    actual = Number(actual) || 0;
    target = Number(target) || 0;
    if (!target) return { txt: '--', cls: '' };

    const diffPct = ((actual - target) / target) * 100;
    const sign = diffPct >= 0 ? '+' : '';
    const txt = `${sign}${diffPct.toFixed(1)}%`;
    const cls = diffPct <= 0 ? 'positive' : 'negative'; // xanh n·∫øu ‚â§ target, ƒë·ªè n·∫øu v∆∞·ª£t
    return { txt, cls };
  };

  // =========================
  // 7) HANDLER
  // =========================
  const handleInput = (teamId, field, value) => {
    teams = teams.map(t => t.id === teamId ? { ...t, [field]: value } : t);
    render();
  };

  const handleMoney = (teamId, field, raw) => {
    const num = parseMoneyInput(raw);
    handleInput(teamId, field, num);
  };

  const toggleCollapse = (teamId) => {
    teams = teams.map(t => t.id === teamId ? { ...t, collapsed: !t.collapsed } : t);
    render();
  };

  const deleteTeam = (teamId) => {
    if (teams.length === 1) {
      alert('C·∫ßn √≠t nh·∫•t 1 team.');
      return;
    }
    teams = teams.filter(t => t.id !== teamId);
    render();
  };

  const addTeam = () => {
    teams = [...teams, createDefaultTeam('Team m·ªõi')];
    render();
  };

  const focusTeam = (name) => {
    document.querySelectorAll('.chip-button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.name === name);
    });

    let t = teams.find(team => team.name.toLowerCase() === name.toLowerCase());
    if (!t) {
      t = createDefaultTeam(name);
      teams = [...teams, t];
    }
    render();

    requestAnimationFrame(() => {
      const el = document.querySelector(`.card[data-team-id="${t.id}"]`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  };

  // =========================
  // 8) RENDER TEAMS
  // =========================
  const renderTeams = () => {
    const container = document.getElementById('teamsContainer');
    container.innerHTML = '';

    teams.forEach((team, index) => {
      const metrics = computeTeamMetrics(team);
      const card = document.createElement('div');
      card.className = `card team-${index % 4}`;
      card.dataset.teamId = team.id;

      const breakEvenText = metrics.breakEven
        ? `${formatCurrency(metrics.breakEven)}`
        : 'Kh√¥ng x√°c ƒë·ªãnh';

      const fixedActual  = Number(team.fixedCost) || 0;
      const fixedTarget  = Number(team.targetFixedCost) || 0;
      let fixedDiffTxt = '--', fixedDiffClass = '';
      if (fixedTarget > 0) {
        const diffPct = ((fixedActual - fixedTarget) / fixedTarget) * 100;
        const sign = diffPct >= 0 ? '+' : '';
        fixedDiffTxt = `${sign}${diffPct.toFixed(1)}%`;
        fixedDiffClass = diffPct <= 0 ? 'positive' : 'negative';
      }

      const cogsCmp  = comparePercent(team.cogs,    team.targetCogs);
      const sellCmp  = comparePercent(team.selling, team.targetSelling);
      const otherCmp = comparePercent(team.other,   team.targetOther);

      const headerHtml = `
        <div class="card-header">
          <div class="card-header-left">
            <span class="badge">Team ${index + 1}</span>
            <input
              type="text"
              class="team-name"
              value="${team.name}"
              onchange="handleInput('${team.id}','name',this.value)"
            />
            <span class="pill-input">
              <span>T·ªïng bi·∫øn ph√≠:</span>
              <strong>${formatPercent(metrics.varPct)}</strong>
            </span>
            <span class="pill-input">
              <span>ƒêi·ªÉm h√≤a v·ªën:</span>
              <strong>${breakEvenText}</strong>
            </span>
          </div>
          <div>
            <button class="small" onclick="toggleCollapse('${team.id}')">
              ${team.collapsed ? 'Xem chi ti·∫øt' : '·∫®n chi ti·∫øt'}
            </button>
            <button class="small danger" onclick="deleteTeam('${team.id}')">
              X√≥a
            </button>
          </div>
        </div>
      `;

      let bodyHtml = '';
      if (!team.collapsed) {
        const profitClassM1 = metrics.m1.netProfit >= 0 ? 'positive' : 'negative';
        const profitClassM2 = metrics.m2.netProfit >= 0 ? 'positive' : 'negative';
        const profitClassM3 = metrics.m3.netProfit >= 0 ? 'positive' : 'negative';

        const paClassM1 = metrics.m1.profitAfterBonus >= 0 ? 'positive' : 'negative';
        const paClassM2 = metrics.m2.profitAfterBonus >= 0 ? 'positive' : 'negative';
        const paClassM3 = metrics.m3.profitAfterBonus >= 0 ? 'positive' : 'negative';

        bodyHtml = `
          <div class="grid">
            <!-- B·∫£ng so s√°nh: Target & Th·ª±c t·∫ø -->
            <div class="col-12">
              <table class="mini-compare">
                <thead>
                  <tr>
                    <th>Ch·ªâ ti√™u</th>
                    <th>Target</th>
                    <th>Th·ª±c t·∫ø</th>
                    <th>Ch√™nh l·ªách</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Chi ph√≠ c·ªë ƒë·ªãnh / k·ª≥</td>
                    <td>
                      <input
                        type="text"
                        class="table-input"
                        value="${formatMoneyInput(team.targetFixedCost)}"
                        onchange="handleMoney('${team.id}','targetFixedCost',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="text"
                        class="table-input"
                        value="${formatMoneyInput(team.fixedCost)}"
                        onchange="handleMoney('${team.id}','fixedCost',this.value)"
                      />
                    </td>
                    <td class="${fixedDiffClass}">${fixedDiffTxt}</td>
                  </tr>
                  <tr>
                    <td>Gi√° v·ªën (COGS)</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetCogs}"
                        onchange="handleInput('${team.id}','targetCogs',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.cogs}"
                        onchange="handleInput('${team.id}','cogs',this.value)"
                      />
                    </td>
                    <td class="${cogsCmp.cls}">${cogsCmp.txt}</td>
                  </tr>
                  <tr>
                    <td>Chi ph√≠ b√°n h√†ng</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetSelling}"
                        onchange="handleInput('${team.id}','targetSelling',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.selling}"
                        onchange="handleInput('${team.id}','selling',this.value)"
                      />
                    </td>
                    <td class="${sellCmp.cls}">${sellCmp.txt}</td>
                  </tr>
                  <tr>
                    <td>Chi ph√≠ kh√°c (bi·∫øn ph√≠)</td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.targetOther}"
                        onchange="handleInput('${team.id}','targetOther',this.value)"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        class="table-input"
                        value="${team.other}"
                        onchange="handleInput('${team.id}','other',this.value)"
                      />
                    </td>
                    <td class="${otherCmp.cls}">${otherCmp.txt}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="col-12 muted">
              = Gi√° v·ªën + Chi ph√≠ b√°n h√†ng + Chi ph√≠ kh√°c ‚Üí <b>T·ªïng bi·∫øn ph√≠: ${formatPercent(metrics.varPct)}</b>
            </div>

            <!-- Kh·ªëi % th∆∞·ªüng -->
            <div class="col-12" style="margin-top:6px;">
              <p><strong>% th∆∞·ªüng tr√™n L·ª¢I NHU·∫¨N (ch·ªâ t√≠nh khi l·ª£i nhu·∫≠n &gt; 0)</strong></p>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">Sale</span>
                <input
                  type="number"
                  class="bonus-input"
                  value="${team.bonusSale}"
                  onchange="handleInput('${team.id}','bonusSale',this.value)"
                />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">RD</span>
                <input
                  type="number"
                  class="bonus-input"
                  value="${team.bonusRD}"
                  onchange="handleInput('${team.id}','bonusRD',this.value)"
                />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">CSKH</span>
                <input
                  type="number"
                  class="bonus-input"
                  value="${team.bonusCSKH}"
                  onchange="handleInput('${team.id}','bonusCSKH',this.value)"
                />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">KT + HCNS</span>
                <input
                  type="number"
                  class="bonus-input"
                  value="${team.bonusKT}"
                  onchange="handleInput('${team.id}','bonusKT',this.value)"
                />
              </div>
            </div>
            <div class="col-2">
              <div class="bonus-field">
                <span class="bonus-label">Media</span>
                <input
                  type="number"
                  class="bonus-input"
                  value="${team.bonusMedia}"
                  onchange="handleInput('${team.id}','bonusMedia',this.value)"
                />
              </div>
            </div>
            <div class="col-12 muted">
              T·ªïng % th∆∞·ªüng = Sale + RD + CSKH + KT + Media. Th∆∞·ªüng t√≠nh tr√™n LNR &gt; 0 c·ªßa t·ª´ng m·ªëc.
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Ch·ªâ ti√™u</th>
                <th>M·ªëc 1</th>
                <th>M·ªëc 2</th>
                <th>M·ªëc 3</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Doanh thu</td>
                <td>
                  <input
                    type="text"
                    class="table-input"
                    value="${formatMoneyInput(team.revenue1)}"
                    onchange="handleMoney('${team.id}','revenue1',this.value)"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    class="table-input"
                    value="${formatMoneyInput(team.revenue2)}"
                    onchange="handleMoney('${team.id}','revenue2',this.value)"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    class="table-input"
                    value="${formatMoneyInput(team.revenue3)}"
                    onchange="handleMoney('${team.id}','revenue3',this.value)"
                  />
                </td>
              </tr>
              <tr>
                <td>Bi·∫øn ph√≠</td>
                <td>${cellValPct(metrics.m1.variableCost, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.variableCost, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.variableCost, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>L·ª£i nhu·∫≠n g·ªôp (sau bi·∫øn ph√≠)</td>
                <td>${cellValPct(metrics.m1.grossProfit, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.grossProfit, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.grossProfit, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Chi ph√≠ c·ªë ƒë·ªãnh</td>
                <td>${cellValPct(metrics.m1.fixedCost, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.fixedCost, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.fixedCost, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>L·ª£i nhu·∫≠n tr∆∞·ªõc th∆∞·ªüng</td>
                <td class="${profitClassM1}">
                  ${cellValPct(metrics.m1.netProfit, metrics.m1.revenue)}
                </td>
                <td class="${profitClassM2}">
                  ${cellValPct(metrics.m2.netProfit, metrics.m2.revenue)}
                </td>
                <td class="${profitClassM3}">
                  ${cellValPct(metrics.m3.netProfit, metrics.m3.revenue)}
                </td>
              </tr>
              <tr>
                <td>Th∆∞·ªüng Sale</td>
                <td>${cellValPct(metrics.m1.bonusSale, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusSale, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusSale, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Th∆∞·ªüng RD</td>
                <td>${cellValPct(metrics.m1.bonusRD, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusRD, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusRD, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Th∆∞·ªüng CSKH</td>
                <td>${cellValPct(metrics.m1.bonusCSKH, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusCSKH, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusCSKH, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Th∆∞·ªüng KT + HCNS</td>
                <td>${cellValPct(metrics.m1.bonusKT, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusKT, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusKT, metrics.m3.revenue)}</td>
              </tr>
              <tr>
                <td>Th∆∞·ªüng Media</td>
                <td>${cellValPct(metrics.m1.bonusMedia, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.bonusMedia, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.bonusMedia, metrics.m3.revenue)}</td>
              </tr>
              <tr class="row-total">
                <td><strong>T·ªïng th∆∞·ªüng</strong></td>
                <td>${cellValPct(metrics.m1.totalBonus, metrics.m1.revenue)}</td>
                <td>${cellValPct(metrics.m2.totalBonus, metrics.m2.revenue)}</td>
                <td>${cellValPct(metrics.m3.totalBonus, metrics.m3.revenue)}</td>
              </tr>
              <tr class="row-profit">
                <td><strong>L·ª£i nhu·∫≠n sau th∆∞·ªüng</strong></td>
                <td class="${paClassM1}">
                  ${cellValPct(metrics.m1.profitAfterBonus, metrics.m1.revenue)}
                </td>
                <td class="${paClassM2}">
                  ${cellValPct(metrics.m2.profitAfterBonus, metrics.m2.revenue)}
                </td>
                <td class="${paClassM3}">
                  ${cellValPct(metrics.m3.profitAfterBonus, metrics.m3.revenue)}
                </td>
              </tr>
            </tbody>
          </table>
        `;
      }

      card.innerHTML = headerHtml + bodyHtml;
      container.appendChild(card);
    });
  };

  // =========================
  // 9) RENDER SUMMARY
  // =========================
  const renderSummary = () => {
    const container = document.getElementById('summaryContainer');
    if (!teams.length) {
      container.innerHTML = "<p class='muted'>Ch∆∞a c√≥ team n√†o.</p>";
      return;
    }

    let rowsHtml = '';

    let totalRevenue = 0;
    let totalCostBeforeBonus = 0;
    let totalGross   = 0;
    let totalProfit  = 0;
    let totalSale    = 0;
    let totalRD      = 0;
    let totalCSKH    = 0;
    let totalKT      = 0;
    let totalMedia   = 0;
    let totalBonus   = 0;

    teams.forEach(team => {
      const m = computeTeamMetrics(team).m3; // M·ªëc 3 ‚Äì th·ª±c t·∫ø
      const costBeforeBonus = m.variableCost + m.fixedCost;

      totalRevenue         += m.revenue;
      totalCostBeforeBonus += costBeforeBonus;
      totalGross           += m.grossProfit;
      totalProfit          += m.profitAfterBonus;
      totalSale            += m.bonusSale;
      totalRD              += m.bonusRD;
      totalCSKH            += m.bonusCSKH;
      totalKT              += m.bonusKT;
      totalMedia           += m.bonusMedia;
      totalBonus           += m.totalBonus;

      const grossCls  = m.grossProfit      >= 0 ? 'positive' : 'negative';
      const profitCls = m.profitAfterBonus >= 0 ? 'positive' : 'negative';

      rowsHtml += `
        <tr>
          <td>${team.name}</td>
          <td>${formatCurrency(m.revenue)}</td>
          <td>${cellValPct(costBeforeBonus, m.revenue)}</td>
          <td class="${grossCls}">${cellValPct(m.grossProfit, m.revenue)}</td>
          <td class="${profitCls}">${cellValPct(m.profitAfterBonus, m.revenue)}</td>
          <td>${cellValPct(m.bonusSale, m.revenue)}</td>
          <td>${cellValPct(m.bonusRD, m.revenue)}</td>
          <td>${cellValPct(m.bonusCSKH, m.revenue)}</td>
          <td>${cellValPct(m.bonusKT, m.revenue)}</td>
          <td>${cellValPct(m.bonusMedia, m.revenue)}</td>
          <td>${cellValPct(m.totalBonus, m.revenue)}</td>
        </tr>
      `;
    });

    const totalGrossCls  = totalGross  >= 0 ? 'positive' : 'negative';
    const totalProfitCls = totalProfit >= 0 ? 'positive' : 'negative';

    const tableHtml = `
      <table>
        <thead>
          <tr>
            <th>Team</th>
            <th>Doanh thu M·ªëc 3</th>
            <th>Chi ph√≠ (tr∆∞·ªõc th∆∞·ªüng)</th>
            <th>L·ª£i nhu·∫≠n g·ªôp</th>
            <th>L·ª£i nhu·∫≠n sau th∆∞·ªüng</th>
            <th>Th∆∞·ªüng Sale</th>
            <th>Th∆∞·ªüng RD</th>
            <th>Th∆∞·ªüng CSKH</th>
            <th>Th∆∞·ªüng KT+HCNS</th>
            <th>Th∆∞·ªüng Media</th>
            <th>T·ªïng th∆∞·ªüng</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>T·ªïng doanh nghi·ªáp</strong></td>
            <td>${formatCurrency(totalRevenue)}</td>
            <td>${cellValPct(totalCostBeforeBonus, totalRevenue)}</td>
            <td class="${totalGrossCls}">
              ${cellValPct(totalGross, totalRevenue)}
            </td>
            <td class="${totalProfitCls}">
              ${cellValPct(totalProfit, totalRevenue)}
            </td>
            <td>${cellValPct(totalSale, totalRevenue)}</td>
            <td>${cellValPct(totalRD, totalRevenue)}</td>
            <td>${cellValPct(totalCSKH, totalRevenue)}</td>
            <td>${cellValPct(totalKT, totalRevenue)}</td>
            <td>${cellValPct(totalMedia, totalRevenue)}</td>
            <td>${cellValPct(totalBonus, totalRevenue)}</td>
          </tr>
        </tfoot>
      </table>
    `;

    container.innerHTML = tableHtml;
  };

  // =========================
  // 10) GOOGLE SHEET SYNC
  // =========================
  const saveToServer = async () => {
    if (!API_URL || API_URL.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) {
      alert('Ch∆∞a c·∫•u h√¨nh API_URL trong code.');
      return;
    }

    try {
      const payload = { id: SCENARIO_ID, teams };

      // Kh√¥ng set headers ƒë·ªÉ tr√°nh preflight CORS
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
      }

      alert(`ƒê√£ l∆∞u l√™n Google Sheet (scenario: ${SCENARIO_ID}).`);
    } catch (err) {
      console.error(err);
      alert('Kh√¥ng l∆∞u ƒë∆∞·ª£c l√™n Google Sheet: ' + err.message);
    }
  };

  const loadFromServer = async () => {
    if (!API_URL || API_URL.includes('PASTE_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) {
      alert('Ch∆∞a c·∫•u h√¨nh API_URL trong code.');
      return;
    }

    try {
      const res = await fetch(`${API_URL}?id=${encodeURIComponent(SCENARIO_ID)}`);
      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
      }

      const incoming = Array.isArray(data.teams) ? data.teams : [];
      if (!incoming.length) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu tr√™n Google Sheet cho scenario n√†y.');
        return;
      }

      teams = incoming.map(t =>
        Object.assign({}, createDefaultTeam(t.name || 'Team'), t)
      );

      render();
      alert(`ƒê√£ t·∫£i c·∫•u h√¨nh t·ª´ Google Sheet (scenario: ${SCENARIO_ID}).`);
    } catch (err) {
      console.error(err);
      alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Google Sheet: ' + err.message);
    }
  };

  // =========================
  // 11) INIT
  // =========================
  const init = () => {
    const storedState = loadState();
    if (storedState && storedState.length) {
      teams = storedState.map(t => ({
        ...createDefaultTeam(t.name || 'Team'),
        ...t,
      }));
    } else {
      teams = createInitialTeamsFromCodeDefaults();
    }
    render();
  };

  const render = () => {
    renderTeams();
    renderSummary();
    saveState();
  };

  init();
</script>
</body>
</html>
