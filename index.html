<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng team | L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #0b57d0;
      --bg: #f5f5f5;
      --card-radius: 12px;
      --green-bg: #e6f4ea;
      --green-text: #137333;
      --yellow-bg: #fff8e1;
      --yellow-text: #b05a00;
      --red-bg: #fce8e6;
      --red-text: #b3261e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 16px 16px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: .01em;
    }

    .subtitle {
      font-size: 12px;
      color: #666;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 16px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      border-radius: var(--card-radius);
      border: 1px solid #e5e5e5;
      padding: 12px 12px 14px;
      background: #fafafa;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .team-select-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .team-select-row label {
      font-size: 13px;
      color: #444;
    }

    select, input[type="text"], input[type="number"] {
      font-family: inherit;
      font-size: 13px;
    }

    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      min-width: 150px;
    }

    select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
      color: #555;
      white-space: nowrap;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 12px;
      margin-bottom: 2px;
      color: #444;
    }

    .field-sub {
      font-size: 11px;
      color: #888;
      margin-top: 1px;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row .field-group {
      flex: 1;
      margin-bottom: 0;
    }

    .field-input {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      outline: none;
      text-align: right;
    }

    .field-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
      background: #fff;
    }

    .field-input[readonly] {
      background: #f3f4f6;
      cursor: default;
    }

    .small {
      font-size: 11px;
      color: #777;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #0b57d0;
      color: #fff;
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }

    .btn-primary:hover {
      background: #0a4ab5;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #ddd;
      color: #555;
    }

    .btn-ghost:hover {
      background: #f3f4f6;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0 10px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }

    .summary-card {
      border-radius: 10px;
      border: 1px solid #eee;
      background: #fafafa;
      padding: 8px 10px;
      font-size: 12px;
    }

    .summary-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .targets-row {
      margin-bottom: 6px;
    }

    .target-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .target-inputs .target-field {
      flex: 1 1 120px;
    }

    .target-label {
      font-size: 11px;
      color: #555;
      margin-bottom: 2px;
    }

    .target-inputs input {
      width: 100%;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: right;
      background: #fff;
      outline: none;
    }

    .target-inputs input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
    }

    .team-block {
      border-radius: 10px;
      border: 1px solid #e5e5e5;
      padding: 10px 10px 12px;
      background: #fff;
      margin-bottom: 10px;
    }

    .team-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .team-name {
      font-weight: 600;
      font-size: 13px;
    }

  .table-wrapper {
  margin-top: 8px;
  overflow-x: auto;      /* cho ph√©p cu·ªôn ngang */
}

/* ƒê·∫£m b·∫£o b·∫£ng ƒë·ªß r·ªông ƒë·ªÉ kh√¥ng b·ªã b√≥p ch·ªØ qu√° nh·ªè */
.table-wrapper table {
  min-width: 900px;
}

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }

    .pl-cell { font-weight: 500; }
    .pl-pos { background: var(--green-bg); color: var(--green-text); }
    .pl-low { background: var(--yellow-bg); color: var(--yellow-text); }
    .pl-neg { background: var(--red-bg); color: var(--red-text); }

    .note {
      margin-top: 6px;
      font-size: 11px;
      color: #777;
    }

    .footer-cta {
      margin-top: 16px;
      text-align: center;
      font-size: 12px;
      color: #555;
    }

    .footer-cta a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    .footer-cta a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Plan doanh thu ‚Äì l·ª£i nhu·∫≠n ‚Äì th∆∞·ªüng theo team</h1>
    <div class="subtitle">
      C√¥ng c·ª• n·ªôi b·ªô gi√∫p L·ªó V≈© &amp; team set target ‚Äì t√≠nh h√≤a v·ªën ‚Äì chia th∆∞·ªüng theo t·ª´ng team (Sale, RD, CSKH, KT+HCNS, Media).
    </div>
  </header>

  <div class="layout">
    <!-- LEFT -->
    <section class="panel">
      <div class="panel-title">
        <span>C·∫•u h√¨nh team</span>
        <span class="tag">√Åp d·ª•ng trong phi√™n l√†m vi·ªác n√†y</span>
      </div>

      <div class="team-select-row">
        <label for="teamSelect">Ch·ªçn team:</label>
        <select id="teamSelect"></select>
        <button class="btn btn-ghost" id="addTeamBtn" type="button">+ Th√™m team</button>
      </div>

      <div class="field-group">
        <label class="field-label" for="teamNameInput">T√™n team</label>
        <input id="teamNameInput" type="text" class="field-input" />
        <div class="field-sub">V√≠ d·ª•: Facebook, TikTok, Shopee, Web, Offline‚Ä¶</div>
      </div>

      <div class="field-group">
        <label class="field-label">Chi ph√≠ c·ªë ƒë·ªãnh m·ªói k·ª≥ (VNƒê)</label>
        <input id="fixedCostInput" type="text" class="field-input" inputmode="numeric" />
        <div class="field-sub">L∆∞∆°ng c·ª©ng, m·∫∑t b·∫±ng, qu·∫£n l√Ω chung‚Ä¶ d√†nh ri√™ng cho team n√†y.</div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Gi√° v·ªën (COGS)</label>
          <input id="cogsRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">T√≠nh theo % doanh thu.</div>
        </div>
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ b√°n h√†ng</label>
          <input id="sellRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Marketing, CSKH, v·∫≠n h√†nh theo %.</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% Chi ph√≠ kh√°c (bi·∫øn ph√≠)</label>
          <input id="otherRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
          <div class="field-sub">Ph√≠ s√†n, POS, thu h·ªô, v·∫≠n chuy·ªÉn‚Ä¶</div>
        </div>
        <div class="field-group">
          <label class="field-label">T·ªïng bi·∫øn ph√≠ (%)</label>
          <input id="totalVarRateDisplay" type="text" class="field-input" readonly />
          <div class="field-sub">= Gi√° v·ªën + b√°n h√†ng + kh√°c</div>
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng Sale tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="saleBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng RD tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="rdBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng CSKH tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="cskhBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
        <div class="field-group">
          <label class="field-label">% th∆∞·ªüng KT + HCNS tr√™n L·ª¢I NHU·∫¨N</label>
          <input id="hcnsBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">% th∆∞·ªüng Media tr√™n L·ª¢I NHU·∫¨N</label>
        <input id="mediaBonusRateInput" type="number" class="field-input" step="0.1" min="0" max="100" />
      </div>

      <div class="field-group">
        <label class="field-label">ƒêi·ªÉm h√≤a v·ªën (preview)</label>
        <input id="breakevenDisplay" type="text" class="field-input" readonly />
        <div class="field-sub">
          Doanh thu c·∫ßn ƒë·∫°t ƒë·ªÉ l·ª£i nhu·∫≠n = 0 (ch·ªâ ƒë·ªß b√π chi ph√≠). ƒê√¢y l√† preview theo c·∫•u h√¨nh ƒëang nh·∫≠p.
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn btn-primary" id="saveTeamBtn" type="button">üíæ C·∫≠p nh·∫≠t team</button>
        <button class="btn btn-ghost" id="resetTeamBtn" type="button">‚Ü∫ ƒê∆∞a v·ªÅ m·∫∑c ƒë·ªãnh</button>
      </div>

      <div class="note">
        ‚Ä¢ Thay ƒë·ªïi ch·ªâ l∆∞u trong l·∫ßn m·ªü trang n√†y (reload s·∫Ω quay v·ªÅ m·∫∑c ƒë·ªãnh).<br>
        ‚Ä¢ M·ªói team c√≥ chi ph√≠ &amp; m·ª©c th∆∞·ªüng ri√™ng: Sale, RD, CSKH, KT+HCNS, Media.
      </div>
    </section>

    <!-- RIGHT -->
    <section>
      <div class="panel">
        <div class="panel-title">
          <span>M·ª•c ti√™u doanh thu &amp; t·ªïng quan c√°c team</span>
        </div>
        <div class="targets-row small">
          M·ªói team d√πng <b>3 m·ªëc doanh thu</b>: M·ªëc 1, M·ªëc 2 v√† <b>M·ªëc 3 (th·ª±c t·∫ø)</b>.  
          M·ªëc 3 d√πng ƒë·ªÉ t√≠nh t·ªïng doanh thu &amp; t·ªïng th∆∞·ªüng to√†n c√¥ng ty.
        </div>
        <div id="teamsOverviewContainer"></div>
        <div class="note">
          ‚Ä¢ D√πng n√∫t ‚Äú·∫®n chi ti·∫øt / Xem chi ti·∫øt‚Äù ƒë·ªÉ thu g·ªçn b·∫£ng t·ª´ng team.<br>
          ‚Ä¢ M·ªëc 3 l√† ‚Äúm·ªëc th·ª±c t·∫ø‚Äù ƒë·ªÉ c·ªông t·ªïng doanh nghi·ªáp.
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <span>T·ªïng quan t·∫•t c·∫£ team (M·ªëc 3 ‚Äì th·ª±c t·∫ø)</span>
        </div>
        <div class="small" style="margin-bottom:4px;">
          T√≠nh theo doanh thu M·ªëc 3 ri√™ng c·ªßa t·ª´ng team.
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Team</th>
                <th>Doanh thu M·ªëc 3</th>
                <th>L·ª£i nhu·∫≠n</th>
                <th>Th∆∞·ªüng Sale</th>
                <th>Th∆∞·ªüng RD</th>
                <th>Th∆∞·ªüng CSKH</th>
                <th>Th∆∞·ªüng KT+HCNS</th>
                <th>Th∆∞·ªüng Media</th>
                <th>T·ªïng th∆∞·ªüng</th>
              </tr>
            </thead>
            <tbody id="allTeamsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer-cta">
        X√¢y d·ª±ng b·ªüi L·ªó V≈© ‚Äì ƒë·ªçc th√™m chia s·∫ª v·ªÅ TMƒêT t·∫°i
        <a href="https://nguoibanlo.vn" target="_blank" rel="noopener noreferrer">nguoibanlo.vn</a>
      </div>
    </section>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ===== Helpers =====
  function formatMoney(value) {
    if (!isFinite(value)) return '‚Äì';
    return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
  }

  function formatPercent(value) {
    if (!isFinite(value)) return '‚Äì';
    return value.toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + '%';
  }

  function parseMoney(str) {
    const digits = String(str || '').replace(/\D/g, '');
    return digits ? parseInt(digits, 10) : 0;
  }

  function formatMoneyInput(el) {
    const num = parseMoney(el.value);
    el.value = num ? num.toLocaleString('vi-VN') : '';
    return num;
  }

  // ===== Data =====
  const DEFAULT_TARGETS = [800000000, 1200000000, 3000000000];

  const INITIAL_TEAMS = [
    {
      id: 'facebook',
      name: 'Facebook',
      fixedCost: 300000000,
      cogsRate: 60,
      sellRate: 14,
      otherRate: 6,
      saleBonusRate: 27,
      rdBonusRate: 4,
      cskhBonusRate: 1,
      hcnsBonusRate: 1.2,
      mediaBonusRate: 1,
      targets: [...DEFAULT_TARGETS]
    },
    {
      id: 'tiktok',
      name: 'TikTok',
      fixedCost: 250000000,
      cogsRate: 58,
      sellRate: 16,
      otherRate: 8,
      saleBonusRate: 27,
      rdBonusRate: 4,
      cskhBonusRate: 1,
      hcnsBonusRate: 1.2,
      mediaBonusRate: 1,
      targets: [...DEFAULT_TARGETS]
    },
    {
      id: 'shopee',
      name: 'Shopee',
      fixedCost: 200000000,
      cogsRate: 60,
      sellRate: 15,
      otherRate: 10,
      saleBonusRate: 7,
      rdBonusRate: 4,
      cskhBonusRate: 1,
      hcnsBonusRate: 1.2,
      mediaBonusRate: 1,
      targets: [...DEFAULT_TARGETS]
    },
    {
      id: 'web',
      name: 'Web',
      fixedCost: 150000000,
      cogsRate: 55,
      sellRate: 10,
      otherRate: 5,
      saleBonusRate: 25,
      rdBonusRate: 4,
      cskhBonusRate: 1,
      hcnsBonusRate: 1.2,
      mediaBonusRate: 1,
      targets: [...DEFAULT_TARGETS]
    }
  ];

  let teams = INITIAL_TEAMS.map(t => ({
    ...t,
    targets: [...t.targets]
  }));

  let currentTeamIndex = 0;

  function getCurrentTeam() {
    return teams[currentTeamIndex];
  }

  // ===== DOM refs =====
  const teamSelect = document.getElementById('teamSelect');
  const addTeamBtn = document.getElementById('addTeamBtn');
  const teamNameInput = document.getElementById('teamNameInput');
  const fixedCostInput = document.getElementById('fixedCostInput');
  const cogsRateInput = document.getElementById('cogsRateInput');
  const sellRateInput = document.getElementById('sellRateInput');
  const otherRateInput = document.getElementById('otherRateInput');
  const totalVarRateDisplay = document.getElementById('totalVarRateDisplay');
  const saleBonusRateInput = document.getElementById('saleBonusRateInput');
  const rdBonusRateInput = document.getElementById('rdBonusRateInput');
  const cskhBonusRateInput = document.getElementById('cskhBonusRateInput');
  const hcnsBonusRateInput = document.getElementById('hcnsBonusRateInput');
  const mediaBonusRateInput = document.getElementById('mediaBonusRateInput');
  const breakevenDisplay = document.getElementById('breakevenDisplay');
  const saveTeamBtn = document.getElementById('saveTeamBtn');
  const resetTeamBtn = document.getElementById('resetTeamBtn');

  const teamsOverviewContainer = document.getElementById('teamsOverviewContainer');
  const allTeamsBody = document.getElementById('allTeamsBody');

  // ===== Logic =====
  function calcBreakeven(team) {
    const totalVarRate = (team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0);
    totalVarRateDisplay.value = formatPercent(totalVarRate);
    const varDec = totalVarRate / 100;
    const denom = 1 - varDec;
    if (denom <= 0) return NaN;
    return (team.fixedCost || 0) / denom;
  }

  function renderTeamOptions() {
    teamSelect.innerHTML = '';
    teams.forEach((t, idx) => {
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = t.name;
      teamSelect.appendChild(opt);
    });
    teamSelect.value = String(currentTeamIndex);
  }

  function renderCurrentTeamConfig() {
    const team = getCurrentTeam();
    teamNameInput.value = team.name;
    fixedCostInput.value = team.fixedCost ? team.fixedCost.toLocaleString('vi-VN') : '';
    cogsRateInput.value = team.cogsRate;
    sellRateInput.value = team.sellRate;
    otherRateInput.value = team.otherRate;
    saleBonusRateInput.value = team.saleBonusRate;
    rdBonusRateInput.value = team.rdBonusRate;
    cskhBonusRateInput.value = team.cskhBonusRate;
    hcnsBonusRateInput.value = team.hcnsBonusRate;
    mediaBonusRateInput.value = team.mediaBonusRate;

    const breakeven = calcBreakeven(team);
    breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
  }

  function recalcLeftPreviewFromInputs() {
    const team = {
      fixedCost: parseMoney(fixedCostInput.value),
      cogsRate: parseFloat(cogsRateInput.value || '0'),
      sellRate: parseFloat(sellRateInput.value || '0'),
      otherRate: parseFloat(otherRateInput.value || '0')
    };
    const breakeven = calcBreakeven(team);
    breakevenDisplay.value = breakeven > 0 ? formatMoney(breakeven) : 'Kh√¥ng x√°c ƒë·ªãnh';
  }

  function computeTeamMetrics(team) {
    const labels = ['M·ªëc 1', 'M·ªëc 2', 'M·ªëc 3 (th·ª±c t·∫ø)'];
    const targets = team.targets || [0,0,0];

    const varRateDecimal = ((team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0)) / 100;
    const fixed = team.fixedCost || 0;

    const totalVarRate = (team.cogsRate || 0) + (team.sellRate || 0) + (team.otherRate || 0);
    const denom = 1 - totalVarRate / 100;
    const breakeven = denom > 0 ? fixed / denom : NaN;

    const saleRate = team.saleBonusRate || 0;
    const rdRate = team.rdBonusRate || 0;
    const cskhRate = team.cskhBonusRate || 0;
    const hcnsRate = team.hcnsBonusRate || 0;
    const mediaRate = team.mediaBonusRate || 0;

    const rows = [];
    let m3 = { revenue: targets[2] || 0, profit: 0, totalBonus: 0 };

    for (let i = 0; i < 3; i++) {
      const revenue = targets[i] || 0;
      if (!revenue) {
        rows.push(null);
        continue;
      }
      const totalCost = revenue * varRateDecimal + fixed;
      const profit = revenue - totalCost;
      const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

      const saleBonus  = profit > 0 ? profit * (saleRate  / 100) : 0;
      const rdBonus    = profit > 0 ? profit * (rdRate    / 100) : 0;
      const cskhBonus  = profit > 0 ? profit * (cskhRate  / 100) : 0;
      const hcnsBonus  = profit > 0 ? profit * (hcnsRate  / 100) : 0;
      const mediaBonus = profit > 0 ? profit * (mediaRate / 100) : 0;

      const totalBonus = saleBonus + rdBonus + cskhBonus + hcnsBonus + mediaBonus;
      const bonusOnProfit = profit > 0 ? (totalBonus / profit) * 100 : 0;

      const row = {
        label: labels[i],
        revenue,
        totalCost,
        profit,
        margin,
        saleBonus,
        rdBonus,
        cskhBonus,
        hcnsBonus,
        mediaBonus,
        totalBonus,
        bonusOnProfit
      };
      rows.push(row);

      if (i === 2) {
        m3 = { revenue, profit, totalBonus };
      }
    }
    return { breakeven, rows, m3 };
  }

  function renderTeamsOverview() {
    teamsOverviewContainer.innerHTML = '';
    const labels = ['M·ªëc 1', 'M·ªëc 2', 'M·ªëc 3 (th·ª±c t·∫ø)'];

    teams.forEach((team, teamIdx) => {
      const { breakeven, rows, m3 } = computeTeamMetrics(team);

      const block = document.createElement('div');
      block.className = 'team-block';

      const header = document.createElement('div');
      header.className = 'team-header';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'team-name';
      nameSpan.textContent = team.name;

      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'btn btn-ghost';
      toggleBtn.textContent = '·∫®n chi ti·∫øt';

      header.appendChild(nameSpan);
      header.appendChild(toggleBtn);
      block.appendChild(header);

      // Targets
      const targetsRow = document.createElement('div');
      targetsRow.className = 'target-inputs';

      for (let i = 0; i < 3; i++) {
        const field = document.createElement('div');
        field.className = 'target-field';

        const label = document.createElement('div');
        label.className = 'target-label';
        label.textContent = labels[i];

        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'numeric';
        const v = team.targets[i] || 0;
        input.value = v ? v.toLocaleString('vi-VN') : '';

        input.addEventListener('input', () => {
          const num = parseMoney(input.value);
          input.value = num ? num.toLocaleString('vi-VN') : '';
          teams[teamIdx].targets[i] = num;
          recalc();
        });

        field.appendChild(label);
        field.appendChild(input);
        targetsRow.appendChild(field);
      }

      block.appendChild(targetsRow);

      // Summary cards
      const summaryGrid = document.createElement('div');
      summaryGrid.className = 'summary-grid';

      const card1 = document.createElement('div');
      card1.className = 'summary-card';
      card1.innerHTML =
        '<div class="summary-title">ƒêi·ªÉm h√≤a v·ªën</div>' +
        `<div class="summary-value">${breakeven > 0 ? formatMoney(breakeven) : '‚Äì'}</div>` +
        '<div class="small">Doanh thu c·∫ßn ƒë·ªÉ l√£i = 0.</div>';

      const card2 = document.createElement('div');
      card2.className = 'summary-card';
      const marginText =
        m3.revenue > 0 ? formatPercent((m3.profit / m3.revenue) * 100) : '‚Äì';
      card2.innerHTML =
        '<div class="summary-title">Bi√™n l·ª£i nhu·∫≠n t·∫°i M·ªëc 3</div>' +
        `<div class="summary-value">${marginText}</div>` +
        '<div class="small">T√≠nh tr√™n doanh thu M·ªëc 3 c·ªßa team.</div>';

      const card3 = document.createElement('div');
      card3.className = 'summary-card';
      card3.innerHTML =
        '<div class="summary-title">T·ªïng th∆∞·ªüng t·∫°i M·ªëc 3</div>' +
        `<div class="summary-value">${m3.totalBonus > 0 ? formatMoney(m3.totalBonus) : '‚Äì'}</div>` +
        '<div class="small">Sale + RD + CSKH + KT+HCNS + Media (LN > 0).</div>';

      summaryGrid.appendChild(card1);
      summaryGrid.appendChild(card2);
      summaryGrid.appendChild(card3);
      block.appendChild(summaryGrid);

      // Detail table
      const detailWrapper = document.createElement('div');
      const tableWrapper = document.createElement('div');
      tableWrapper.className = 'table-wrapper';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>M·ªëc</th>
          <th>Doanh thu</th>
          <th>T·ªïng chi ph√≠</th>
          <th>L·ª£i nhu·∫≠n</th>
          <th>Bi√™n LN (%)</th>
          <th>Th∆∞·ªüng Sale</th>
          <th>Th∆∞·ªüng RD</th>
          <th>Th∆∞·ªüng CSKH</th>
          <th>Th∆∞·ªüng KT+HCNS</th>
          <th>Th∆∞·ªüng Media</th>
          <th>T·ªïng th∆∞·ªüng</th>
          <th>T·ªïng th∆∞·ªüng / LN</th>
        </tr>
      `;
      const tbody = document.createElement('tbody');

      rows.forEach(row => {
        if (!row) return;
        const tr = document.createElement('tr');

        const tdLabel = document.createElement('td');
        tdLabel.textContent = row.label;
        tdLabel.style.textAlign = 'left';

        const tdRev = document.createElement('td');
        tdRev.textContent = formatMoney(row.revenue);

        const tdCost = document.createElement('td');
        tdCost.textContent = formatMoney(row.totalCost);

        const tdProfit = document.createElement('td');
        tdProfit.className = 'pl-cell';
        if (row.profit < 0) tdProfit.classList.add('pl-neg');
        else if (row.profit === 0 || row.margin < 3) tdProfit.classList.add('pl-low');
        else tdProfit.classList.add('pl-pos');
        tdProfit.textContent = formatMoney(row.profit);

        const tdMargin = document.createElement('td');
        tdMargin.textContent = formatPercent(row.margin);

        const tdSale = document.createElement('td');
        tdSale.textContent = row.saleBonus > 0 ? formatMoney(row.saleBonus) : '‚Äì';

        const tdRd = document.createElement('td');
        tdRd.textContent = row.rdBonus > 0 ? formatMoney(row.rdBonus) : '‚Äì';

        const tdCskh = document.createElement('td');
        tdCskh.textContent = row.cskhBonus > 0 ? formatMoney(row.cskhBonus) : '‚Äì';

        const tdHcns = document.createElement('td');
        tdHcns.textContent = row.hcnsBonus > 0 ? formatMoney(row.hcnsBonus) : '‚Äì';

        const tdMedia = document.createElement('td');
        tdMedia.textContent = row.mediaBonus > 0 ? formatMoney(row.mediaBonus) : '‚Äì';

        const tdTotalBonus = document.createElement('td');
        tdTotalBonus.textContent = row.totalBonus > 0 ? formatMoney(row.totalBonus) : '‚Äì';

        const tdRatio = document.createElement('td');
        tdRatio.textContent =
          row.totalBonus > 0 && row.profit > 0
            ? formatPercent(row.bonusOnProfit)
            : '‚Äì';

        tr.appendChild(tdLabel);
        tr.appendChild(tdRev);
        tr.appendChild(tdCost);
        tr.appendChild(tdProfit);
        tr.appendChild(tdMargin);
        tr.appendChild(tdSale);
        tr.appendChild(tdRd);
        tr.appendChild(tdCskh);
        tr.appendChild(tdHcns);
        tr.appendChild(tdMedia);
        tr.appendChild(tdTotalBonus);
        tr.appendChild(tdRatio);

        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      tableWrapper.appendChild(table);
      detailWrapper.appendChild(tableWrapper);
      block.appendChild(detailWrapper);

      toggleBtn.addEventListener('click', () => {
        const hidden = detailWrapper.style.display === 'none';
        detailWrapper.style.display = hidden ? '' : 'none';
        toggleBtn.textContent = hidden ? '·∫®n chi ti·∫øt' : 'Xem chi ti·∫øt';
      });

      teamsOverviewContainer.appendChild(block);
    });
  }

  function recalcAllTeamsSummary() {
    allTeamsBody.innerHTML = '';

    let sumRev = 0, sumProfit = 0;
    let sumSale = 0, sumRd = 0, sumCskh = 0, sumHcns = 0, sumMedia = 0;

    teams.forEach(team => {
      const { rows } = computeTeamMetrics(team);
      const m3 = rows[2]; // M·ªëc 3

      const revenue = m3 ? m3.revenue : 0;
      const profit = m3 ? m3.profit : 0;

      const saleBonus  = m3 ? m3.saleBonus  : 0;
      const rdBonus    = m3 ? m3.rdBonus    : 0;
      const cskhBonus  = m3 ? m3.cskhBonus  : 0;
      const hcnsBonus  = m3 ? m3.hcnsBonus  : 0;
      const mediaBonus = m3 ? m3.mediaBonus : 0;
      const totalBonus = m3 ? m3.totalBonus : 0;

      sumRev += revenue;
      sumProfit += profit;
      sumSale += saleBonus;
      sumRd += rdBonus;
      sumCskh += cskhBonus;
      sumHcns += hcnsBonus;
      sumMedia += mediaBonus;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left">${team.name}</td>
        <td>${revenue ? formatMoney(revenue) : '‚Äì'}</td>
        <td>${revenue ? formatMoney(profit) : '‚Äì'}</td>
        <td>${saleBonus  ? formatMoney(saleBonus)  : '‚Äì'}</td>
        <td>${rdBonus    ? formatMoney(rdBonus)    : '‚Äì'}</td>
        <td>${cskhBonus  ? formatMoney(cskhBonus)  : '‚Äì'}</td>
        <td>${hcnsBonus  ? formatMoney(hcnsBonus)  : '‚Äì'}</td>
        <td>${mediaBonus ? formatMoney(mediaBonus) : '‚Äì'}</td>
        <td>${totalBonus ? formatMoney(totalBonus) : '‚Äì'}</td>
      `;
      allTeamsBody.appendChild(tr);
    });

    const trTotal = document.createElement('tr');
    trTotal.style.fontWeight = '600';
    trTotal.innerHTML = `
      <td style="text-align:left">T·ªîNG (t·∫•t c·∫£ team)</td>
      <td>${formatMoney(sumRev)}</td>
      <td>${formatMoney(sumProfit)}</td>
      <td>${formatMoney(sumSale)}</td>
      <td>${formatMoney(sumRd)}</td>
      <td>${formatMoney(sumCskh)}</td>
      <td>${formatMoney(sumHcns)}</td>
      <td>${formatMoney(sumMedia)}</td>
      <td>${formatMoney(sumSale + sumRd + sumCskh + sumHcns + sumMedia)}</td>
    `;
    allTeamsBody.appendChild(trTotal);
  }

  function recalc() {
    renderTeamsOverview();
    recalcAllTeamsSummary();
  }

  // ===== Events =====
  teamSelect.addEventListener('change', () => {
    currentTeamIndex = parseInt(teamSelect.value, 10) || 0;
    renderCurrentTeamConfig();
  });

  addTeamBtn.addEventListener('click', () => {
    const id = 'team_' + Date.now();
    teams.push({
      id,
      name: 'Team m·ªõi',
      fixedCost: 0,
      cogsRate: 60,
      sellRate: 10,
      otherRate: 5,
      saleBonusRate: 20,
      rdBonusRate: 5,
      cskhBonusRate: 3,
      hcnsBonusRate: 3,
      mediaBonusRate: 2,
      targets: [...DEFAULT_TARGETS]
    });
    currentTeamIndex = teams.length - 1;
    renderTeamOptions();
    renderCurrentTeamConfig();
    recalc();
  });

  saveTeamBtn.addEventListener('click', () => {
    const t = getCurrentTeam();
    t.name = teamNameInput.value || t.name;
    t.fixedCost = parseMoney(fixedCostInput.value);
    t.cogsRate = parseFloat(cogsRateInput.value || '0');
    t.sellRate = parseFloat(sellRateInput.value || '0');
    t.otherRate = parseFloat(otherRateInput.value || '0');
    t.saleBonusRate = parseFloat(saleBonusRateInput.value || '0');
    t.rdBonusRate = parseFloat(rdBonusRateInput.value || '0');
    t.cskhBonusRate = parseFloat(cskhBonusRateInput.value || '0');
    t.hcnsBonusRate = parseFloat(hcnsBonusRateInput.value || '0');
    t.mediaBonusRate = parseFloat(mediaBonusRateInput.value || '0');
    renderTeamOptions();
    renderCurrentTeamConfig();
    recalc();
  });

  resetTeamBtn.addEventListener('click', () => {
    const id = getCurrentTeam().id;
    const def = INITIAL_TEAMS.find(x => x.id === id);
    if (def) {
      teams[currentTeamIndex] = {
        ...def,
        targets: [...def.targets]
      };
    }
    renderTeamOptions();
    renderCurrentTeamConfig();
    recalc();
  });

  fixedCostInput.addEventListener('input', () => {
    formatMoneyInput(fixedCostInput);
    recalcLeftPreviewFromInputs();
  });
  cogsRateInput.addEventListener('input', recalcLeftPreviewFromInputs);
  sellRateInput.addEventListener('input', recalcLeftPreviewFromInputs);
  otherRateInput.addEventListener('input', recalcLeftPreviewFromInputs);

  // ===== Init =====
  renderTeamOptions();
  renderCurrentTeamConfig();
  recalc();
});
</script>
</body>
</html>
